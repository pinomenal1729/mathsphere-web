<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>MathSphere v9.0 ‚Äî The Mathematical Lab</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"/>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
<style>
/* ‚ïê‚ïê ROOT VARIABLES ‚ïê‚ïê */
:root {
  --safe-area-top: 0;
  --safe-area-bottom: 0;
  --safe-area-left: 0;
  --safe-area-right: 0;
  --bg-deep:#0a0e27; --bg-main:#0f1437; --bg-light:#14194f;
  --accent-primary:#00d9ff; --accent-secondary:#7c3aed; --accent-tertiary:#06f7d6;
  --text-primary:#f8fafc; --text-secondary:#a8b7d1; --text-tertiary:#6b7a94;
  --gold:#d4a574; --danger:#ff6b6b;
  --sidebar-bg:rgba(10,14,39,.9); --topbar-bg:rgba(10,14,39,.7);
  --input-bg:rgba(20,25,79,.6); --card-bg:rgba(0,217,255,.07);
  --result-bg:rgba(0,0,0,.25); --border:rgba(0,217,255,.2);
  --font-display:'Playfair Display',serif; --font-body:'Poppins',sans-serif; --font-mono:'JetBrains Mono',monospace;
}

@supports (padding: max(0px)) {
  :root {
    --safe-area-top: max(0px, env(safe-area-inset-top));
    --safe-area-bottom: max(0px, env(safe-area-inset-bottom));
    --safe-area-left: max(0px, env(safe-area-inset-left));
    --safe-area-right: max(0px, env(safe-area-inset-right));
  }
}

body.light {
  --bg-deep:#e8f4ff; --bg-main:#f0f6ff;
  --text-primary:#0a1628; --text-secondary:#2a4a7f; --text-tertiary:#5a7aaf;
  --sidebar-bg:rgba(220,235,255,.97); --topbar-bg:rgba(220,235,255,.9);
  --input-bg:rgba(255,255,255,.9); --card-bg:rgba(255,255,255,.85);
  --result-bg:rgba(255,255,255,.85); --border:rgba(0,120,255,.2);
}

/* ‚ïê‚ïê BASE ‚ïê‚ïê */
*{margin:0;padding:0;box-sizing:border-box;}
html, body {
  width: 100%;
  height: 100%;
  position: fixed;
  overflow: hidden;
}
body {
  background:linear-gradient(135deg,var(--bg-deep) 0%,#1a1f4b 100%);
  color:var(--text-primary);
  font-family:var(--font-body);
  font-size:14px;
  line-height:1.65;
  transition:background .4s,color .3s;
}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(circle at 20% 80%,rgba(0,217,255,.15) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(124,58,237,.1) 0%,transparent 50%);animation:gradientShift 15s ease-in-out infinite;}
@keyframes gradientShift{0%,100%{filter:blur(40px)}50%{filter:blur(60px)}}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(0deg,transparent 24%,rgba(0,217,255,.05) 25%,rgba(0,217,255,.05) 26%,transparent 27%),linear-gradient(90deg,transparent 24%,rgba(0,217,255,.05) 25%,rgba(0,217,255,.05) 26%,transparent 27%);background-size:60px 60px;opacity:.3;}

/* ‚ïê‚ïê FLOATING ‚ïê‚ïê */
.math-float{position:fixed;opacity:.04;pointer-events:none;z-index:0;animation:floatSym 20s infinite ease-in-out;font-family:var(--font-mono);color:var(--accent-primary);}
.float-text{position:fixed;opacity:.06;pointer-events:none;z-index:0;font-family:var(--font-display);font-weight:800;letter-spacing:6px;text-transform:uppercase;color:var(--accent-primary);animation:floatTxt 28s infinite ease-in-out;white-space:nowrap;}
@keyframes floatSym{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-22px) rotate(180deg)}}
@keyframes floatTxt{0%,100%{transform:translateY(0) rotate(-12deg)}50%{transform:translateY(-28px) rotate(-12deg)}}

#app{position:relative;z-index:1;display:flex;height:100vh;width:100%;max-width:100vw;overflow:hidden;}

/* ‚ïê‚ïê SIDEBAR ‚ïê‚ïê */
#sidebar{width:260px;flex-shrink:0;background:var(--sidebar-bg);backdrop-filter:blur(20px);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:transform .3s ease,background .4s;}
.logo-wrap{padding:20px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,rgba(0,217,255,.05) 0%,rgba(124,58,237,.05) 100%);}
.logo-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));box-shadow:0 0 30px rgba(0,217,255,.4);animation:glow 3s ease-in-out infinite;}
.logo-icon img{width:100%;height:100%;object-fit:cover;border-radius:10px;display:block;}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(0,217,255,.3)}50%{box-shadow:0 0 40px rgba(0,217,255,.6),0 0 80px rgba(124,58,237,.3)}}
.logo-name{font-family:var(--font-display);font-size:17px;font-weight:800;background:linear-gradient(135deg,var(--text-primary),var(--accent-primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.logo-by{font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:1.5px;text-transform:uppercase;}
.sb-scroll{flex:1;overflow-y:auto;padding:10px 8px;scrollbar-width:thin;scrollbar-color:rgba(0,217,255,.3) transparent;}
.sb-scroll::-webkit-scrollbar{width:4px;}.sb-scroll::-webkit-scrollbar-thumb{background:rgba(0,217,255,.3);border-radius:2px;}
.sb-section{padding:12px 12px 4px;font-size:9px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase;margin-top:6px;}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;border-radius:8px;font-family:var(--font-body);font-size:13px;font-weight:500;transition:all .25s ease;text-align:left;margin:2px 0;position:relative;overflow:hidden;}
.nav-btn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(180deg,var(--accent-primary),var(--accent-secondary));transform:scaleY(0);transition:transform .25s ease;border-radius:0 2px 2px 0;}
.nav-btn:hover{color:var(--text-primary);background:rgba(0,217,255,.07);transform:translateX(4px);}
.nav-btn.active{background:rgba(0,217,255,.12);color:var(--accent-primary);border:1px solid rgba(0,217,255,.3);box-shadow:0 0 15px rgba(0,217,255,.15);}
.nav-btn.active::before{transform:scaleY(1);}
.nav-btn .em{font-size:15px;transition:transform .25s;}.nav-btn:hover .em{transform:scale(1.2) rotate(-8deg);}
.sb-links{padding:10px 8px;border-top:1px solid var(--border);display:flex;gap:6px;}
.sb-link{flex:1;text-align:center;padding:7px;background:rgba(0,217,255,.07);border:1px solid var(--border);border-radius:7px;color:var(--text-secondary);text-decoration:none;font-size:11px;transition:all .25s;}
.sb-link:hover{color:var(--accent-primary);background:rgba(0,217,255,.13);}

/* ‚ïê‚ïê MAIN ‚ïê‚ïê */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;width:100%;height:100%;}
#topbar{display:flex;align-items:center;gap:12px;padding:12px 20px;padding-top:calc(12px + var(--safe-area-top));border-bottom:1px solid var(--border);background:var(--topbar-bg);backdrop-filter:blur(20px);flex-shrink:0;transition:background .4s;width:100%;overflow-x:auto;overflow-y:hidden;}
#mode-title{font-family:var(--font-display);font-weight:700;font-size:17px;background:linear-gradient(135deg,var(--text-primary),var(--accent-primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;flex:1;transition:opacity .2s;white-space:nowrap;}
.status-dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(135deg,var(--accent-tertiary),var(--accent-primary));box-shadow:0 0 12px var(--accent-tertiary);animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}
#clear-btn,#theme-btn{background:rgba(0,217,255,.08);border:1px solid rgba(0,217,255,.25);color:var(--text-secondary);padding:6px 12px;border-radius:7px;font-family:var(--font-mono);font-size:10px;cursor:pointer;transition:all .25s;}
#clear-btn:hover,#theme-btn:hover{background:rgba(0,217,255,.15);border-color:var(--accent-primary);color:var(--accent-primary);}
#owner-name{font-family:var(--font-display);font-weight:700;font-size:11px;color:var(--accent-tertiary);padding:5px 10px;border:1px solid rgba(6,247,214,.3);border-radius:999px;background:rgba(6,247,214,.08);}
#tagsbar{display:flex;gap:8px;padding:10px 20px;border-bottom:1px solid rgba(0,217,255,.08);background:rgba(20,25,79,.3);overflow-x:auto;flex-shrink:0;scrollbar-width:none;width:100%;}
#tagsbar::-webkit-scrollbar{display:none;}
.tag{background:rgba(0,217,255,.07);border:1px solid rgba(0,217,255,.2);color:var(--text-secondary);padding:5px 12px;border-radius:20px;font-size:11px;font-family:var(--font-mono);cursor:pointer;white-space:nowrap;transition:all .25s;}
.tag:hover{background:rgba(0,217,255,.15);border-color:var(--accent-primary);color:var(--accent-primary);transform:translateY(-2px);}

/* ‚ïê‚ïê CHAT ‚ïê‚ïê */
#chat{flex:1;overflow-y:auto;overflow-x:hidden;padding:20px;display:flex;flex-direction:column;gap:16px;scrollbar-width:thin;scrollbar-color:rgba(0,217,255,.2) transparent;width:100%;min-height:0;}
#chat::-webkit-scrollbar{width:5px;}#chat::-webkit-scrollbar-thumb{background:rgba(0,217,255,.2);border-radius:3px;}
.msg{display:flex;gap:10px;animation:msgIn .3s cubic-bezier(.4,0,.2,1);}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.user{flex-direction:row-reverse;}
.avatar{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;overflow:hidden;}
.msg.user .avatar{background:linear-gradient(135deg,#1a2d5c,#2a1f4f);border:1px solid rgba(124,58,237,.3);}
.msg.bot .avatar{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));box-shadow:0 0 15px rgba(0,217,255,.35);}
.msg.bot .avatar img{width:100%;height:100%;object-fit:cover;border-radius:8px;display:block;}
.bubble{max-width:78%;padding:13px 16px;border-radius:14px;font-size:13.5px;line-height:1.8;overflow-wrap:break-word;min-width:0;backdrop-filter:blur(10px);}
.msg.user .bubble{background:linear-gradient(135deg,rgba(124,58,237,.12),rgba(0,217,255,.08));border:1px solid rgba(124,58,237,.25);border-top-right-radius:3px;}
.msg.bot .bubble{background:linear-gradient(135deg,rgba(0,217,255,.08),rgba(20,25,79,.5));border:1px solid rgba(0,217,255,.2);border-top-left-radius:3px;position:relative;}
.msg.bot .bubble::before{content:'';position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary),var(--accent-tertiary),transparent);border-radius:14px 14px 0 0;opacity:.5;}
.bubble code{font-family:var(--font-mono);font-size:11.5px;background:rgba(0,0,0,.3);padding:2px 5px;border-radius:4px;color:var(--accent-tertiary);}
.bubble pre{background:rgba(0,0,0,.4);border:1px solid rgba(0,217,255,.2);border-radius:8px;padding:12px;margin:8px 0;overflow-x:auto;font-family:var(--font-mono);font-size:11px;line-height:1.6;color:var(--accent-tertiary);white-space:pre-wrap;}

/* ‚ïê‚ïê INPUT AREA - CRITICAL FIX ‚ïê‚ïê */
#inputarea{
  padding:14px 20px 18px;
  padding-bottom:calc(14px + var(--safe-area-bottom));
  border-top:1px solid var(--border);
  background:var(--topbar-bg);
  backdrop-filter:blur(20px);
  flex-shrink:0;
  width:100%;
  min-height:auto;
  max-height:200px;
  overflow-y:auto;
  transition:all .2s ease;
  position:relative;
  z-index:100;
  scrollbar-width:thin;
}
#inputarea::-webkit-scrollbar{width:3px;}#inputarea::-webkit-scrollbar-thumb{background:rgba(0,217,255,.2);border-radius:2px;}

.inp-wrap{display:flex;gap:8px;align-items:flex-end;background:var(--input-bg);border:1px solid rgba(0,217,255,.25);border-radius:12px;padding:9px 10px 9px 14px;transition:all .25s;min-height:44px;width:100%;}
.inp-wrap:focus-within{border-color:var(--accent-primary);box-shadow:0 6px 30px rgba(0,217,255,.15);}
#input{flex:1;background:none;border:none;outline:none;color:var(--text-primary);font-family:var(--font-body);font-size:13.5px;line-height:1.6;resize:none;max-height:120px;min-height:22px;font-weight:500;width:100%;}
#input::placeholder{color:var(--text-tertiary);}
.iico{width:34px;height:34px;background:rgba(0,217,255,.08);border:1px solid rgba(0,217,255,.2);border-radius:7px;color:var(--text-tertiary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .25s;flex-shrink:0;}
.iico:hover{background:rgba(0,217,255,.18);border-color:var(--accent-primary);color:var(--accent-primary);transform:scale(1.1);}
#send-btn{width:34px;height:34px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border:none;border-radius:7px;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 4px 15px rgba(0,217,255,.3);transition:all .25s;flex-shrink:0;}
#send-btn:hover{transform:scale(1.12) rotate(8deg);box-shadow:0 8px 25px rgba(0,217,255,.5);}
#send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.inp-hint{text-align:center;margin-top:7px;font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);}

/* ‚ïê‚ïê WELCOME ‚ïê‚ïê */
#welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:30px 20px;text-align:center;animation:welcomeIn .6s cubic-bezier(.4,0,.2,1);overflow-y:auto;}
@keyframes welcomeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.big-icon{width:88px;height:88px;border-radius:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 20px 50px rgba(0,217,255,.4);animation:iconFloat 4s ease-in-out infinite;margin-bottom:24px;overflow:hidden;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));}
.big-icon img{width:100%;height:100%;object-fit:cover;border-radius:20px;display:block;}
@keyframes iconFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
#welcome h1{font-family:var(--font-display);font-size:32px;font-weight:800;letter-spacing:-1px;margin-bottom:10px;background:linear-gradient(135deg,var(--text-primary),var(--accent-primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
#welcome p{color:var(--text-secondary);max-width:460px;font-size:13px;line-height:1.8;margin-bottom:24px;}
.feat-grid{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:580px;}
.feat{background:rgba(0,217,255,.07);border:1px solid rgba(0,217,255,.18);border-radius:8px;padding:7px 13px;font-size:11px;color:var(--text-secondary);font-family:var(--font-mono);transition:all .25s;cursor:default;}
.feat:hover{background:rgba(0,217,255,.13);border-color:var(--accent-primary);color:var(--accent-primary);transform:translateY(-3px);}

/* ‚ïê‚ïê PANELS ‚ïê‚ïê */
.panel-card{background:linear-gradient(135deg,rgba(0,217,255,.07),rgba(124,58,237,.07));border:1px solid rgba(0,217,255,.2);border-radius:14px;padding:20px;animation:cardIn .35s cubic-bezier(.4,0,.2,1);}
@keyframes cardIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.panel-title{font-family:var(--font-display);font-weight:700;font-size:16px;color:var(--text-primary);margin-bottom:4px;}
.panel-sub{font-size:11px;color:var(--text-tertiary);font-family:var(--font-mono);margin-bottom:16px;}
.form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;}
.form-group{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px;}
.form-label{font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:1px;text-transform:uppercase;}
.form-input,.form-select{background:rgba(20,25,79,.7);border:1px solid rgba(0,217,255,.2);color:var(--text-primary);border-radius:8px;padding:9px 12px;font-family:var(--font-body);font-size:13px;outline:none;transition:all .25s;}
.form-input:focus,.form-select:focus{border-color:var(--accent-primary);box-shadow:0 0 12px rgba(0,217,255,.15);}
.form-select option{background:var(--bg-main);color:var(--text-primary);}
.action-btn{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border:none;color:white;padding:11px 24px;border-radius:9px;font-family:var(--font-body);font-size:13px;font-weight:600;cursor:pointer;transition:all .25s;box-shadow:0 4px 15px rgba(0,217,255,.3);}
.action-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,217,255,.45);}
.action-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.result-box{background:rgba(0,0,0,.25);border:1px solid rgba(0,217,255,.15);border-radius:10px;padding:16px;margin-top:14px;line-height:1.9;font-size:13.5px;color:var(--text-primary);overflow-wrap:break-word;max-height:55vh;overflow-y:auto;scrollbar-width:thin;}
.result-box::-webkit-scrollbar{width:4px;}.result-box::-webkit-scrollbar-thumb{background:rgba(0,217,255,.2);border-radius:2px;}
.graph-box{background:rgba(0,0,0,.3);border:1px solid rgba(0,217,255,.2);border-radius:10px;padding:12px;margin-top:12px;height:360px;}

/* ‚ïê‚ïê TYPING ‚ïê‚ïê */
.typing{display:flex;gap:5px;padding:12px 14px;background:rgba(0,217,255,.08);border:1px solid rgba(0,217,255,.2);border-radius:14px;border-top-left-radius:3px;width:fit-content;}
.td{width:6px;height:6px;border-radius:50%;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));animation:bounce 1.2s ease-in-out infinite;}
.td:nth-child(2){animation-delay:.2s}.td:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-9px);opacity:1}}

/* ‚ïê‚ïê TOAST ‚ïê‚ïê */
.toast{position:fixed;top:18px;right:18px;padding:11px 16px;border-radius:9px;font-size:12px;z-index:9999;font-family:var(--font-mono);animation:toastIn .3s ease;backdrop-filter:blur(10px);border:1px solid;}
@keyframes toastIn{from{opacity:0;transform:translateX(80px)}to{opacity:1;transform:translateX(0)}}
.toast.ok{background:rgba(6,247,214,.1);border-color:rgba(6,247,214,.3);color:var(--accent-tertiary);}
.toast.info{background:rgba(0,217,255,.1);border-color:rgba(0,217,255,.3);color:var(--accent-primary);}
.toast.err{background:rgba(255,107,107,.1);border-color:rgba(255,107,107,.3);color:#ff6b6b;}
.loading-spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(0,217,255,.3);border-top-color:var(--accent-primary);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚ïê‚ïê KATEX ‚ïê‚ïê */
.katex{color:var(--text-primary);font-size:1.04em;}
.katex-display{margin:10px 0;overflow-x:auto;}

/* ‚ïê‚ïê LIGHT THEME ‚ïê‚ïê */
body.light { background:linear-gradient(135deg,#e8f4ff 0%,#ddeeff 100%) !important; }
body.light #sidebar { background:var(--sidebar-bg); border-right:1px solid rgba(0,100,200,.15); }
body.light .nav-btn { color:var(--text-secondary); }
body.light .nav-btn:hover { background:rgba(0,120,255,.08); color:#0050cc; }
body.light .nav-btn.active { background:rgba(0,120,255,.12); color:#0050cc; border-color:rgba(0,120,255,.3); }
body.light #topbar,body.light #inputarea { background:var(--topbar-bg); border-color:rgba(0,100,200,.15); }
body.light .inp-wrap { background:var(--input-bg); border-color:rgba(0,100,200,.25); }
body.light #input { color:var(--text-primary); }
body.light .panel-card { background:var(--card-bg); border-color:rgba(0,100,200,.2); }
body.light .form-input,.form-select { background:rgba(255,255,255,.9); border-color:rgba(0,100,200,.25); color:var(--text-primary); }
body.light .result-box { background:var(--result-bg); border-color:rgba(0,100,200,.2); color:var(--text-primary); }
body.light .msg.bot .bubble { background:rgba(255,255,255,.92); border-color:rgba(0,100,200,.2); }
body.light .tag { background:rgba(0,120,255,.07); border-color:rgba(0,120,255,.2); color:#2a4a7f; }
body.light .tag:hover { background:rgba(0,120,255,.15); color:#0050cc; }

/* ‚ïê‚ïê MATHEMATICIAN CARD ‚ïê‚ïê */
.mcard-name{font-family:var(--font-display);font-size:22px;font-weight:800;background:linear-gradient(135deg,var(--text-primary),var(--accent-primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;}
.mcard-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-family:var(--font-mono);margin-right:6px;margin-bottom:4px;}
.mcard-sec{font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase;margin:14px 0 8px;}
.mcard-quote{background:rgba(212,165,116,.08);border-left:3px solid var(--gold);padding:12px 16px;border-radius:0 8px 8px 0;margin:14px 0;font-style:italic;color:var(--gold);font-size:13px;}
.mcard-ach{background:rgba(0,217,255,.06);border:1px solid rgba(0,217,255,.15);border-radius:8px;padding:10px 14px;margin-bottom:8px;}

/* ‚ïê‚ïê MOBILE RESPONSIVE ‚ïê‚ïê */
@media (max-width: 600px) {
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 200;
    transform: translateX(-100%);
    width: 240px;
    height: 100vh;
    border-right: 2px solid rgba(0, 217, 255, .3);
    box-shadow: 4px 0 30px rgba(0, 217, 255, .3);
  }

  #sidebar.open {
    transform: translateX(0);
  }

  #app {
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  #main {
    width: 100%;
    height: 100%;
  }

  #topbar {
    padding: 8px 12px;
    padding-top: calc(8px + var(--safe-area-top));
    gap: 8px;
    font-size: 12px;
  }

  #mode-title {
    font-size: 14px;
  }

  #tagsbar {
    padding: 8px 12px;
    gap: 6px;
    max-height: 45px;
  }

  #chat {
    padding: 12px;
    gap: 12px;
  }

  #inputarea {
    padding: 10px 12px;
    padding-bottom: calc(10px + var(--safe-area-bottom));
  }

  .inp-wrap {
    padding: 8px 8px;
    min-height: 42px;
    border-radius: 10px;
  }

  #input {
    font-size: 14px;
    min-height: 42px;
    max-height: 80px;
  }

  .iico, #send-btn {
    min-width: 42px;
    height: 42px;
  }

  #menu-toggle {
    display: flex !important;
  }

  .bubble {
    max-width: 90%;
  }

  #imgpreview {
    display: none !important;
  }

  .panel-card {
    padding: 16px;
    border-radius: 12px;
  }

  .form-row {
    flex-direction: column;
  }

  .form-group {
    min-width: 100% !important;
  }

  .graph-box {
    height: 280px;
  }

  #welcome h1 {
    font-size: 22px;
  }

  #welcome p {
    font-size: 12px;
  }

  .big-icon {
    width: 70px;
    height: 70px;
  }

  .feat-grid {
    gap: 6px;
  }

  .feat {
    padding: 5px 10px;
    font-size: 10px;
  }

  #tagsbar {
    display: none;
  }
}

/* ‚ïê‚ïê TABLET RESPONSIVE ‚ïê‚ïê */
@media (min-width: 601px) and (max-width: 1024px) {
  #sidebar {
    width: 240px;
  }

  #topbar {
    padding: 10px 16px;
    gap: 10px;
    font-size: 13px;
  }

  #chat {
    padding: 14px;
    gap: 14px;
  }

  #inputarea {
    padding: 11px 14px;
    padding-bottom: calc(11px + var(--safe-area-bottom));
  }

  .inp-wrap {
    min-height: 43px;
  }

  #input {
    font-size: 13.5px;
    min-height: 43px;
    max-height: 90px;
  }

  .bubble {
    max-width: 85%;
  }

  .graph-box {
    height: 340px;
  }

  .panel-card {
    padding: 18px;
  }
}

/* ‚ïê‚ïê DESKTOP RESPONSIVE ‚ïê‚ïê */
@media (min-width: 1025px) {
  #sidebar {
    width: 280px;
  }

  #topbar {
    padding: 12px 20px;
  }

  #chat {
    padding: 20px;
  }

  #inputarea {
    padding: 14px 20px;
    padding-bottom: calc(14px + var(--safe-area-bottom));
  }

  .bubble {
    max-width: 78%;
  }

  .graph-box {
    height: 400px;
  }

  .panel-card {
    padding: 22px;
    max-width: 900px;
    margin: 0 auto;
  }
}

/* ‚ïê‚ïê LANDSCAPE MODE ‚ïê‚ïê */
@media (max-height: 600px) {
  #topbar {
    padding: 6px 12px;
    min-height: 42px;
  }

  #tagsbar {
    display: none;
  }

  #chat {
    padding: 8px;
  }

  #inputarea {
    padding: 8px 12px;
    padding-bottom: calc(8px + var(--safe-area-bottom));
  }

  .inp-wrap {
    min-height: 40px;
  }

  #input {
    min-height: 40px;
    max-height: 60px;
  }

  .iico, #send-btn {
    min-width: 40px;
    height: 40px;
    font-size: 12px;
  }
}
</style>
</head>
<body>
<div id="app">

<!-- SIDEBAR -->
<nav id="sidebar">
  <div class="logo-wrap">
    <div class="logo-icon">
      <img src="/logo.png" alt="Logo" onerror="this.outerHTML='<span style=font-size:22px>‚àë</span>'"/>
    </div>
    <div>
      <div class="logo-name">MathSphere</div>
      <div class="logo-by">By Anupam Nigam</div>
    </div>
  </div>
  <div class="sb-scroll">
    <div class="sb-section">üßÆ Core Learning</div>
    <button class="nav-btn active" id="nav-ask"           onclick="setMode('ask')">          <span class="em">üí¨</span>Ask Anupam</button>
    <button class="nav-btn"        id="nav-formula"       onclick="setMode('formula')">      <span class="em">üìä</span>Formula Sheet</button>
    <button class="nav-btn"        id="nav-graph"         onclick="setMode('graph')">        <span class="em">üìà</span>Graph Plotter</button>
    <div class="sb-section">üî¨ Explore</div>
    <button class="nav-btn"        id="nav-mathematician" onclick="setMode('mathematician')"> <span class="em">üë®‚Äçüî¨</span>Mathematicians</button>
    <button class="nav-btn"        id="nav-projects"      onclick="setMode('projects')">     <span class="em">üöÄ</span>Projects</button>
    <button class="nav-btn"        id="nav-theorem"       onclick="setMode('theorem')">      <span class="em">üìê</span>Theorems</button>
    <button class="nav-btn"        id="nav-competition"   onclick="setMode('competition')">  <span class="em">üèÜ</span>Competitions</button>
    <div class="sb-section">üìö Practice</div>
    <button class="nav-btn"        id="nav-quiz"          onclick="setMode('quiz')">         <span class="em">üìù</span>Quiz Mode</button>
    <button class="nav-btn"        id="nav-verify"        onclick="setMode('verify')">       <span class="em">‚úÖ</span>Verify Answer</button>
    <button class="nav-btn"        id="nav-mistakes"      onclick="setMode('mistakes')">     <span class="em">‚ö†Ô∏è</span>Common Mistakes</button>
  </div>
  <div class="sb-links">
    <a href="https://youtube.com/@pi_nomenal1729" target="_blank" class="sb-link">‚ñ∂ YouTube</a>
    <a href="https://www.anupamnigam.com"         target="_blank" class="sb-link">üåê Website</a>
  </div>
</nav>

<!-- MAIN -->
<div id="main">
  <div id="topbar">
    <button id="menu-toggle" onclick="toggleSidebar()" style="display:none;background:rgba(0,217,255,.1);border:1px solid rgba(0,217,255,.2);color:var(--text-secondary);width:34px;height:34px;border-radius:7px;cursor:pointer;font-size:16px;align-items:center;justify-content:center">‚ò∞</button>
    <div id="mode-title">üí¨ Ask Anupam</div>
    <div class="status-dot"></div>
    <span style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono)">LIVE</span>
    <span id="owner-name">Anupam Nigam</span>
    <button id="theme-btn" onclick="toggleTheme()">‚òÄÔ∏è Light</button>
    <button id="clear-btn" onclick="clearAll()">CLEAR</button>
  </div>
  <div id="tagsbar"></div>
  <div id="chat"></div>
  <div id="inputarea">
    <div id="imgpreview" style="display:none;margin-bottom:8px;position:relative">
      <img id="prev-img" src="" alt="" style="width:64px;height:48px;object-fit:cover;border-radius:7px;border:1px solid rgba(0,217,255,.3)"/>
      <button onclick="removeImg()" style="position:absolute;top:-5px;right:-5px;width:16px;height:16px;background:var(--danger);border-radius:50%;border:none;color:white;font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center">‚úï</button>
    </div>
    <div class="inp-wrap">
      <textarea id="input" rows="1" placeholder="Ask any math question..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <div style="display:flex;gap:7px;align-items:center;flex-shrink:0">
        <input type="file" id="filein" accept="image/*" style="display:none" onchange="handleImg(event)"/>
        <button class="iico" onclick="document.getElementById('filein').click()" title="Upload image">üì∏</button>
        <button id="send-btn" onclick="sendMsg()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
    <div class="inp-hint">MathSphere v9.0 ¬∑ The Mathematical Lab ¬∑ By Anupam Nigam</div>
  </div>
</div>
</div>

<script>
const API_BASE = "";

/* ‚ïê‚ïê FLOATING BACKGROUND ‚ïê‚ïê */
(()=>{
  const syms = ['‚à´','‚àë','œÄ','‚àû','‚àö','‚àÇ','‚àá','Œª','Œî','Œ∏','Œ±','Œ≤','Œ≥','œÜ'];
  syms.forEach((s,i)=>{
    const el = document.createElement('div');
    el.className = 'math-float';
    el.textContent = s;
    el.style.cssText = `left:${(i/syms.length*100+5)%95}%;top:${Math.random()*90}%;font-size:${50+Math.random()*50}px;animation-duration:${18+Math.random()*14}s;animation-delay:${-Math.random()*18}s`;
    document.body.appendChild(el);
  });

  [
    {t:'ANUPAM',    left:'3%',  top:'15%', size:'26px', dur:'24s', delay:'-6s'},
    {t:'MATHSPHERE',left:'65%', top:'55%', size:'20px', dur:'30s', delay:'-14s'},
    {t:'ANUPAM',    left:'50%', top:'82%', size:'22px', dur:'20s', delay:'-3s'},
    {t:'MATHSPHERE',left:'80%', top:'8%',  size:'18px', dur:'26s', delay:'-9s'},
  ].forEach(cfg=>{
    const el = document.createElement('div');
    el.className = 'float-text';
    el.textContent = cfg.t;
    el.style.cssText = `left:${cfg.left};top:${cfg.top};font-size:${cfg.size};animation-duration:${cfg.dur};animation-delay:${cfg.delay}`;
    document.body.appendChild(el);
  });
})();

/* ‚ïê‚ïê KATEX ‚ïê‚ïê */
function renderMath(el){
  if(!el) return;
  if(typeof renderMathInElement==='undefined'){ setTimeout(()=>renderMath(el),400); return; }
  try{
    renderMathInElement(el,{
      delimiters:[
        {left:'\\[',right:'\\]',display:true},
        {left:'\\(',right:'\\)',display:false},
        {left:'$$',right:'$$',display:true},
        {left:'$',right:'$',display:false}
      ],throwOnError:false,errorColor:'#ff6b6b',strict:false
    });
  }catch(e){}
}

/* ‚ïê‚ïê MOBILE KEYBOARD HANDLER ‚ïê‚ïê */
class MobileKeyboardHandler {
  constructor() {
    this.isOpen = false;
    this.originalViewportHeight = window.innerHeight;
    
    window.addEventListener('resize', () => this.handleResize());
    window.addEventListener('orientationchange', () => this.handleOrientationChange());
    
    const input = document.getElementById('input');
    if (input) {
      input.addEventListener('focus', () => this.onInputFocus());
      input.addEventListener('blur', () => this.onInputBlur());
    }
  }
  
  handleResize() {
    const currentHeight = window.innerHeight;
    const heightDifference = this.originalViewportHeight - currentHeight;
    
    if (heightDifference > 100) {
      this.isOpen = true;
      this.shiftInputUp();
    } else {
      this.isOpen = false;
      this.resetInput();
    }
  }
  
  handleOrientationChange() {
    setTimeout(() => {
      this.originalViewportHeight = window.innerHeight;
      this.scrollChatToBottom();
    }, 500);
  }
  
  onInputFocus() {
    setTimeout(() => {
      const inputArea = document.getElementById('inputarea');
      if (inputArea) {
        inputArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }
      this.scrollChatToBottom();
    }, 300);
  }
  
  onInputBlur() {
    this.resetInput();
  }
  
  shiftInputUp() {
    const inputArea = document.getElementById('inputarea');
    if (inputArea) {
      inputArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
  }
  
  resetInput() {
    const chat = document.getElementById('chat');
    if (chat) {
      chat.style.marginBottom = '0';
    }
  }
  
  scrollChatToBottom() {
    const chat = document.getElementById('chat');
    if (chat) {
      setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
      }, 100);
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  new MobileKeyboardHandler();
  loadThemePreference();
  loadChatHistory();
});

/* ‚ïê‚ïê PERSISTENT STORAGE ‚ïê‚ïê */
function saveChatHistory() {
  try {
    localStorage.setItem('mathsphere_chat', JSON.stringify(chatHistory));
  } catch (e) {
    console.warn('Could not save chat history:', e);
  }
}

function loadChatHistory() {
  try {
    const saved = localStorage.getItem('mathsphere_chat');
    if (saved) {
      chatHistory = JSON.parse(saved);
    }
  } catch (e) {
    console.warn('Could not load chat history:', e);
  }
}

function saveThemePreference() {
  localStorage.setItem('mathsphere_theme', isLight ? 'light' : 'dark');
}

function loadThemePreference() {
  const saved = localStorage.getItem('mathsphere_theme');
  if (saved === 'light' && !isLight) {
    toggleTheme();
  }
}

/* ‚ïê‚ïê STATE ‚ïê‚ïê */
let mode='ask', chatHistory=[], imgB64=null, imgType=null, busy=false, isLight=false;

const MODES={
  ask:{title:'üí¨ Ask Anupam',ph:'Ask any mathematics question...'},
  formula:{title:'üìä Formula Sheet',ph:'Enter a topic...'},
  graph:{title:'üìà Graph Plotter',ph:'Enter a function e.g. x**2'},
  mathematician:{title:'üë®‚Äçüî¨ Mathematician Explorer',ph:'Enter a mathematician name...'},
  projects:{title:'üöÄ Math Projects',ph:'Enter a topic...'},
  theorem:{title:'üìê Theorem Prover',ph:'Enter a theorem name...'},
  competition:{title:'üèÜ Competition Problems',ph:''},
  quiz:{title:'üìù Quiz Mode',ph:''},
  verify:{title:'‚úÖ Verify Answer',ph:''},
  mistakes:{title:'‚ö†Ô∏è Common Mistakes',ph:'Enter a topic...'},
};

function logoImg(size, radius){
  return `<img src="/logo.png" alt="Logo" style="width:${size}px;height:${size}px;object-fit:cover;border-radius:${radius}px;display:block;" onerror="this.outerHTML='<span style=font-size:${Math.round(size*.45)}px>‚àë</span>'"/>`;
}

window.onload = ()=>setMode('ask');

function toggleTheme(){
  isLight = !isLight;
  document.body.classList.toggle('light', isLight);
  document.getElementById('theme-btn').textContent = isLight ? 'üåô Dark' : '‚òÄÔ∏è Light';
  saveThemePreference();
}

function setMode(m){
  mode=m;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const nb=document.getElementById(`nav-${m}`); if(nb) nb.classList.add('active');
  const mt=document.getElementById('mode-title');
  mt.style.opacity='0';
  setTimeout(()=>{mt.textContent=(MODES[m]||MODES.ask).title;mt.style.opacity='1';},150);
  const ph=(MODES[m]||MODES.ask).ph; if(ph) document.getElementById('input').placeholder=ph;
  document.getElementById('sidebar').classList.remove('open');
  renderTagsBar();
  if(m!=='ask') renderModePanel(m);
  else showWelcome();
}

function clearAll(){
  chatHistory=[]; imgB64=null; imgType=null; removeImg();
  saveChatHistory();
  document.getElementById('chat').innerHTML='';
  if(mode==='ask') showWelcome();
  toast('Chat cleared', 'ok');
}

function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); }

document.addEventListener('click',e=>{
  const sb=document.getElementById('sidebar');
  if(window.innerWidth<=700&&sb.classList.contains('open')&&!sb.contains(e.target)&&e.target.id!=='menu-toggle')
    sb.classList.remove('open');
});

/* ‚ïê‚ïê TAGS ‚ïê‚ïê */
function renderTagsBar(){
  const bar=document.getElementById('tagsbar');
  const tags={
    ask:[['‚à´ Integral','Solve ‚à´ x¬≤ sin(x) dx step by step'],['Matrix Eigen','Find eigenvalues of [[2,1],[1,2]]'],['Series','Test convergence of Œ£ 1/n¬≤'],['ODE','Solve dy/dx + 2y = 4x, y(0)=1']],
    formula:[['Calculus','Calculus'],['Linear Algebra','Linear Algebra'],['Real Analysis','Real Analysis'],['Complex Analysis','Complex Analysis']],
    graph:[['x¬≤','x**2'],['sin(x)','sin(x)'],['e^x','exp(x)'],['x¬≥-3x','x**3-3*x'],['1/x','1/x']],
    mathematician:[['Ramanujan','Srinivasa Ramanujan'],['Euler','Leonhard Euler'],['Gauss','Carl Friedrich Gauss'],['Noether','Emmy Noether'],['Turing','Alan Turing']],
    theorem:[['Pythagorean','Pythagorean Theorem'],['FTA','Fundamental Theorem of Algebra'],['Bayes','Bayes Theorem'],['Fermat Last','Fermat Last Theorem']],
    competition:[['IMO','IMO'],['PUTNAM','PUTNAM'],['AIME','AIME']],
    quiz:[['Calculus','Calculus'],['Linear Algebra','Linear Algebra'],['Real Analysis','Real Analysis'],['Probability','Probability']],
    mistakes:[['Calculus','Calculus'],['Integration','Integration'],['Limits','Limits'],['Linear Algebra','Linear Algebra']],
  };
  const list=tags[mode]||[];
  bar.innerHTML=list.map(([lbl,val])=>`<div class="tag" onclick="tagClick('${esc(val)}')">${lbl}</div>`).join('');
}

function tagClick(val){
  if(mode==='ask'){quickChat(val);return;}
  const map={
    formula:()=>{document.getElementById('f-topic').value=val;runFormula();},
    graph:()=>{document.getElementById('g-expr').value=val;runGraph();},
    mathematician:()=>{document.getElementById('m-name').value=val;runMathematician();},
    theorem:()=>{document.getElementById('t-name').value=val;runTheorem();},
    competition:()=>{document.getElementById('c-cat').value=val;runCompetition();},
    quiz:()=>{document.getElementById('q-topic').value=val;runQuiz();},
    mistakes:()=>{document.getElementById('mk-topic').value=val;runMistakes();},
  };
  if(map[mode]) map[mode]();
}

/* ‚ïê‚ïê WELCOME ‚ïê‚ïê */
function showWelcome(){
  document.getElementById('chat').innerHTML=`
  <div id="welcome">
    <div class="big-icon">${logoImg(88,20)}</div>
    <h1>MathSphere</h1>
    <p>Your premium AI mathematics laboratory. Solve problems, explore mathematicians, prove theorems and master mathematics with advanced AI.</p>
    <div class="feat-grid">
      <div class="feat">‚ú® Natural Chat</div><div class="feat">üìä Formula Sheets</div>
      <div class="feat">üìà Graph Plotting</div><div class="feat">üë®‚Äçüî¨ Math Explorers</div>
      <div class="feat">üöÄ Real Projects</div><div class="feat">üìê Theorem Proofs</div>
      <div class="feat">üèÜ Competitions</div><div class="feat">üìù Quiz Mode</div>
      <div class="feat">üì∏ Image Solving</div><div class="feat">‚úÖ Verify Answers</div>
      <div class="feat">‚ö†Ô∏è Common Mistakes</div>
    </div>
  </div>`;
}

/* ‚ïê‚ïê PANELS ‚ïê‚ïê */
function renderModePanel(m){
  const chat=document.getElementById('chat');
  const p={
    formula:`<div class="panel-card">
      <div class="panel-title">üìä Formula Sheet Generator</div>
      <div class="panel-sub">Get complete exam-ready formula sheets for any topic</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Topic</label><input class="form-input" id="f-topic" placeholder="e.g. Calculus..." value="Calculus"/></div>
        <div class="form-group"><label class="form-label">Exam</label>
          <select class="form-select" id="f-exam"><option value="JAM">IIT JAM</option><option value="GATE">GATE</option><option value="CSIR">CSIR NET</option><option value="General">General</option></select>
        </div>
      </div>
      <button class="action-btn" id="f-btn" onclick="runFormula()">Generate Formula Sheet</button>
      <div id="f-result" class="result-box" style="display:none"></div></div>`,

    graph:`<div class="panel-card">
      <div class="panel-title">üìà Graph Plotter</div>
      <div class="panel-sub">Plot and analyze any mathematical function</div>
      <div class="form-row">
        <div class="form-group" style="flex:2"><label class="form-label">Function f(x) =</label><input class="form-input" id="g-expr" placeholder="e.g. x**2, sin(x), exp(x)" value="x**2"/></div>
        <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="g-type"><option value="2d">2D Plot</option></select></div>
      </div>
      <button class="action-btn" id="g-btn" onclick="runGraph()">Plot & Analyze</button>
      <div id="g-plotbox" class="graph-box" style="display:none"></div>
      <div id="g-result" class="result-box" style="display:none"></div></div>`,

    mathematician:`<div class="panel-card">
      <div class="panel-title">üë®‚Äçüî¨ Mathematician Explorer</div>
      <div class="panel-sub">Discover the lives and contributions of great mathematicians</div>
      <div class="form-row">
        <div class="form-group" style="flex:2"><label class="form-label">Name</label>
          <input class="form-input" id="m-name" placeholder="e.g. Ramanujan, Euler, Gauss..."/>
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <button class="action-btn" id="m-btn" onclick="runMathematician()">Explore</button>
        <button class="action-btn-secondary" onclick="runRandMath()">üé≤ Random</button>
      </div>
      <div id="m-result" class="result-box" style="display:none"></div></div>`,

    projects:`<div class="panel-card">
      <div class="panel-title">üöÄ Math Projects Generator</div>
      <div class="panel-sub">5 detailed projects with code for any topic</div>
      <div class="form-row">
        <div class="form-group" style="flex:2"><label class="form-label">Topic</label>
          <input class="form-input" id="p-topic" placeholder="e.g. Machine Learning..." value="Machine Learning"/>
        </div>
      </div>
      <button class="action-btn" id="p-btn" onclick="runProjects()">Generate Projects</button>
      <div id="p-result" class="result-box" style="display:none"></div></div>`,

    theorem:`<div class="panel-card">
      <div class="panel-title">üìê Theorem Prover</div>
      <div class="panel-sub">Get complete, rigorous proofs from scratch</div>
      <div class="form-row">
        <div class="form-group" style="flex:2"><label class="form-label">Theorem</label>
          <input class="form-input" id="t-name" placeholder="e.g. Pythagorean Theorem..." value="Pythagorean Theorem"/>
        </div>
      </div>
      <button class="action-btn" id="t-btn" onclick="runTheorem()">Prove Theorem</button>
      <div id="t-result" class="result-box" style="display:none"></div></div>`,

    competition:`<div class="panel-card">
      <div class="panel-title">üèÜ Competition Problems</div>
      <div class="panel-sub">Olympiad-level problems with full solutions</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Competition</label>
          <select class="form-select" id="c-cat"><option value="IMO">IMO</option><option value="PUTNAM">Putnam</option><option value="AIME">AIME</option><option value="AMC">AMC</option></select>
        </div>
        <div class="form-group"><label class="form-label">Count</label>
          <select class="form-select" id="c-count"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option><option value="30">30</option></select>
        </div>
      </div>
      <button class="action-btn" id="c-btn" onclick="runCompetition()">Generate Problems</button>
      <div id="c-result" class="result-box" style="display:none"></div></div>`,

    quiz:`<div class="panel-card">
      <div class="panel-title">üìù Quiz Mode</div>
      <div class="panel-sub">Exam-style questions with complete solutions</div>
      <div class="form-row">
        <div class="form-group" style="flex:2"><label class="form-label">Topic</label>
          <input class="form-input" id="q-topic" placeholder="e.g. Calculus..." value="Calculus"/>
        </div>
        <div class="form-group"><label class="form-label">Count</label>
          <select class="form-select" id="q-count"><option value="10">10</option><option value="20" selected>20</option><option value="30">30</option></select>
        </div>
      </div>
      <button class="action-btn" id="q-btn" onclick="runQuiz()">Start Quiz</button>
      <div id="q-result" class="result-box" style="display:none"></div></div>`,

    verify:`<div class="panel-card">
      <div class="panel-title">‚úÖ Answer Verifier</div>
      <div class="panel-sub">Check if your solution is correct</div>
      <div class="form-row"><div class="form-group" style="flex:1;min-width:100%"><label class="form-label">Problem</label>
        <textarea class="form-input" id="v-problem" rows="3" placeholder="Enter the problem..." style="resize:vertical"></textarea>
      </div></div>
      <div class="form-row"><div class="form-group" style="flex:1;min-width:100%"><label class="form-label">Your Solution</label>
        <textarea class="form-input" id="v-solution" rows="3" placeholder="Enter your solution..." style="resize:vertical"></textarea>
      </div></div>
      <button class="action-btn" id="v-btn" onclick="runVerify()">Verify Solution</button>
      <div id="v-result" class="result-box" style="display:none"></div></div>`,

    mistakes:`<div class="panel-card">
      <div class="panel-title">‚ö†Ô∏è Common Mistakes</div>
      <div class="panel-sub">Most common errors students make</div>
      <div class="form-row">
        <div class="form-group" style="flex:2"><label class="form-label">Topic</label>
          <input class="form-input" id="mk-topic" placeholder="e.g. Integration, Limits..." value="Integration"/>
        </div>
      </div>
      <button class="action-btn" id="mk-btn" onclick="runMistakes()">Show Mistakes</button>
      <div id="mk-result" class="result-box" style="display:none"></div></div>`,
  };
  if(p[m]){ chat.innerHTML=p[m]; setTimeout(()=>renderMath(chat),100); }
}

/* ‚ïê‚ïê API RUNNERS ‚ïê‚ïê */
async function runFormula(){ await rp('f-btn','/api/formula',{topic:V('f-topic')||'Calculus',exam:V('f-exam')},'f-result',r=>r.answer,'Generate Formula Sheet'); }
async function runGraph(){
  const expr=V('g-expr')||'x**2';
  const btn=document.getElementById('g-btn');
  setLoad(btn,true,'Plotting...');
  try{
    const r=await post('/api/graph',{expression:expr,type:'2d'});
    const pb=document.getElementById('g-plotbox');
    if(r.sympy&&r.points&&r.points.length){
      pb.style.display='block';
      const pts=r.points.filter(p=>p.y!==null&&isFinite(p.y));
      Plotly.newPlot(pb,[{x:pts.map(p=>p.x),y:pts.map(p=>p.y),type:'scatter',mode:'lines',line:{color:'#00d9ff',width:2.5,shape:'spline'},name:`f(x)=${expr}`,fill:'tozeroy',fillcolor:'rgba(0,217,255,0.05)'}],
        {paper_bgcolor:'rgba(15,20,55,0.95)',plot_bgcolor:'rgba(15,20,55,0.95)',font:{color:'#a8b7d1',family:'JetBrains Mono',size:11},
         xaxis:{gridcolor:'rgba(0,217,255,.12)',zerolinecolor:'rgba(0,217,255,.4)',zerolinewidth:1.5,title:{text:'x',font:{color:'#00d9ff'}},tickfont:{color:'#6b7a94'}},
         yaxis:{gridcolor:'rgba(0,217,255,.12)',zerolinecolor:'rgba(0,217,255,.4)',zerolinewidth:1.5,title:{text:'f(x)',font:{color:'#00d9ff'}},tickfont:{color:'#6b7a94'}},
         margin:{l:55,r:20,t:40,b:50},title:{text:`f(x) = ${expr}`,font:{color:'#f8fafc',size:14},x:0.5}},
        {responsive:true,displaylogo:false});
      showRes('g-result',r.analysis||'');
    }else{ pb.style.display='none'; showRes('g-result',r.analysis||'No graph data.'); }
  }catch(e){ showRes('g-result','‚ö†Ô∏è Error: '+e.message,true); }
  finally{ setLoad(btn,false,'Plot & Analyze'); }
}

async function runMathematician(){
  const name=V('m-name'), btn=document.getElementById('m-btn'), box=document.getElementById('m-result');
  setLoad(btn,true,'Exploring...'); box.style.display='none';
  try{
    const r=await post('/api/mathematician',{name});
    box.style.display='block';
    box.innerHTML=fmtMathematician(r);
    setTimeout(()=>renderMath(box),200);
  }catch(e){ box.style.display='block'; box.innerHTML=`<span style="color:var(--danger)">‚ö†Ô∏è ${escH(e.message)}</span>`; }
  finally{ setLoad(btn,false,'Explore'); }
}

async function runRandMath(){
  document.getElementById('m-name').value='';
  const btn=document.getElementById('m-btn'), box=document.getElementById('m-result');
  setLoad(btn,true,'Loading...'); box.style.display='none';
  try{
    const r=await post('/api/mathematician',{});
    if(r.name) document.getElementById('m-name').value=r.name;
    box.style.display='block';
    box.innerHTML=fmtMathematician(r);
    setTimeout(()=>renderMath(box),200);
  }catch(e){ box.style.display='block'; box.innerHTML=`<span style="color:var(--danger)">‚ö†Ô∏è ${escH(e.message)}</span>`; }
  finally{ setLoad(btn,false,'Explore'); }
}

function fmtMathematician(r){
  if(!r) return '<p style="color:var(--danger)">No data. Try again.</p>';
  if(typeof r==='string') return `<div style="color:var(--text-secondary);line-height:1.9">${escH(r)}</div>`;

  const name    = r.name||'Unknown';
  const period  = r.period||'';
  const country = r.country||'';
  const fields  = Array.isArray(r.fields)?r.fields:(r.fields?[r.fields]:[]);
  const bio     = r.biography||r.bio||'';
  const quote   = r.famous_quote||'';
  const contribs= Array.isArray(r.major_contributions)?r.major_contributions:[];
  const achs    = (r.key_achievements&&typeof r.key_achievements==='object'&&!Array.isArray(r.key_achievements))?r.key_achievements:{};
  const impact  = r.impact_today||'';
  const res     = Array.isArray(r.learning_resources)?r.learning_resources:[];
  const wiki    = r.wikipedia||`https://en.wikipedia.org/wiki/${encodeURIComponent(name)}`;

  let h=`<div style="border-bottom:1px solid rgba(0,217,255,.2);padding-bottom:16px;margin-bottom:4px">
    <div class="mcard-name">${escH(name)}</div>
    <div>`;
  if(period)  h+=`<span class="mcard-badge" style="background:rgba(0,217,255,.12);border:1px solid rgba(0,217,255,.3);color:var(--accent-primary)">üìÖ ${escH(period)}</span>`;
  if(country) h+=`<span class="mcard-badge" style="background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.3);color:#a78bfa">üåç ${escH(country)}</span>`;
  h+=`</div>`;
  if(fields.length) h+=`<div style="font-size:11px;color:var(--accent-tertiary);font-family:var(--font-mono);margin-top:6px">üî¨ ${fields.map(escH).join(' ¬∑ ')}</div>`;
  h+=`</div>`;

  if(bio){
    h+=`<div class="mcard-sec">üìñ BIOGRAPHY</div>
    <div style="color:var(--text-secondary);line-height:1.9;font-size:13px">${escH(bio)}</div>`;
  }
  if(quote){
    h+=`<div class="mcard-quote">"${escH(quote)}"</div>`;
  }
  if(contribs.length){
    h+=`<div class="mcard-sec">üèÜ MAJOR CONTRIBUTIONS</div>`;
    contribs.forEach(c=>{
      h+=`<div style="display:flex;gap:8px;margin-bottom:6px;align-items:flex-start">
        <span style="color:var(--accent-primary);flex-shrink:0;margin-top:2px">‚ñ∏</span>
        <span style="color:var(--text-secondary);font-size:13px">${escH(c)}</span>
      </div>`;
    });
  }
  const achKeys=Object.keys(achs);
  if(achKeys.length){
    h+=`<div class="mcard-sec">üìê KEY THEOREMS & RESULTS</div>`;
    achKeys.forEach(k=>{
      h+=`<div class="mcard-ach">
        <div style="color:var(--accent-primary);font-weight:600;font-size:12px;margin-bottom:4px">${escH(k)}</div>
        <div style="color:var(--text-secondary);font-size:12px;line-height:1.7">${escH(String(achs[k]))}</div>
      </div>`;
    });
  }
  if(impact){
    h+=`<div class="mcard-sec">üåç IMPACT TODAY</div>
    <div style="color:var(--text-secondary);font-size:13px;line-height:1.8">${escH(impact)}</div>`;
  }
  if(res.length){
    h+=`<div class="mcard-sec">üìö LEARNING RESOURCES</div>`;
    res.forEach(r=>{ h+=`<div style="color:var(--accent-tertiary);font-size:12px;margin-bottom:4px">‚Üí ${escH(r)}</div>`; });
  }
  h+=`<div style="margin-top:16px">
    <a href="${escH(wiki)}" target="_blank" style="display:inline-block;background:rgba(0,217,255,.1);border:1px solid rgba(0,217,255,.3);color:var(--accent-primary);padding:8px 18px;border-radius:8px;text-decoration:none;font-size:12px;font-family:var(--font-mono)">üîó Wikipedia ‚Üí</a>
  </div>`;
  return h;
}

async function runProjects(){
  const btn=document.getElementById('p-btn'), box=document.getElementById('p-result');
  setLoad(btn,true,'Generating...'); box.style.display='none';
  try{
    const r=await post('/api/projects/generate',{topic:V('p-topic')||'Machine Learning'});
    box.style.display='block';
    if(!r.projects||!r.projects.length){ box.innerHTML='‚ö†Ô∏è No projects. Try again.'; return; }
    box.innerHTML=r.projects.map(fmtProject).join('');
    setTimeout(()=>renderMath(box),200);
  }catch(e){ box.style.display='block'; box.innerHTML=`<span style="color:var(--danger)">‚ö†Ô∏è ${escH(e.message)}</span>`; }
  finally{ setLoad(btn,false,'Generate Projects'); }
}

function fmtProject(p,i){
  const dc={'Beginner':'#06f7d6','Intermediate':'#00d9ff','Advanced':'#a78bfa'}[p.difficulty]||'#00d9ff';
  const concepts=Array.isArray(p.math_concepts)?p.math_concepts:[];
  const steps=Array.isArray(p.step_by_step)?p.step_by_step:[];
  const rsrc=Array.isArray(p.resources)?p.resources:[];
  const sq=encodeURIComponent((p.title||'')+' math tutorial');
  return `<div style="background:rgba(0,217,255,.05);border:1px solid rgba(0,217,255,.18);border-radius:12px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden">
    <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary),var(--accent-tertiary))"></div>
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-bottom:10px">
      <div>
        <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono)">PROJECT ${i+1}</div>
        <div style="font-family:var(--font-display);font-size:16px;font-weight:700;color:var(--text-primary)">${escH(p.title||'')}</div>
      </div>
      <span style="color:${dc};background:rgba(0,217,255,.08);border:1px solid ${dc}44;padding:3px 12px;border-radius:20px;font-size:11px;font-family:var(--font-mono);white-space:nowrap">${escH(p.difficulty||'')}</span>
    </div>
    <div style="color:var(--text-secondary);font-size:13px;line-height:1.8;margin-bottom:12px">${escH(p.description||'')}</div>
    ${concepts.length?`<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px">${concepts.map(c=>`<span style="background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.25);color:#a78bfa;padding:3px 9px;border-radius:6px;font-size:11px;font-family:var(--font-mono)">${escH(c)}</span>`).join('')}</div>`:''}
    ${steps.length?`<div style="margin-bottom:12px">${steps.map((s,si)=>`<div style="display:flex;gap:10px;margin-bottom:7px;align-items:flex-start"><span style="background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:white;min-width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0">${si+1}</span><span style="color:var(--text-secondary);font-size:12.5px;line-height:1.7">${escH(s)}</span></div>`).join('')}</div>`:''}
    ${p.code_snippet?`<pre style="background:rgba(0,0,0,.4);border:1px solid rgba(0,217,255,.15);border-radius:8px;padding:12px;font-family:var(--font-mono);font-size:11px;color:var(--accent-tertiary);overflow-x:auto;margin-bottom:12px">${escH(p.code_snippet)}</pre>`:''}
  </div>`;
}

async function runTheorem(){ await rp('t-btn','/api/theorem/prove',{theorem:V('t-name')||'Pythagorean Theorem'},'t-result',r=>r.proof,'Prove Theorem'); }
async function runCompetition(){ await rp('c-btn','/api/competition/problems',{category:V('c-cat'),count:parseInt(V('c-count'))},'c-result',r=>r.problems,'Generate Problems'); }
async function runQuiz(){ await rp('q-btn','/api/quiz/generate',{topic:V('q-topic')||'Calculus',count:parseInt(V('q-count'))},'q-result',r=>r.questions,'Start Quiz'); }
async function runVerify(){
  const problem=V('v-problem'), solution=V('v-solution');
  if(!problem||!solution){toast('Enter both problem and solution','err');return;}
  await rp('v-btn','/api/verify-solution',{problem,solution},'v-result',r=>r.verification,'Verify Solution');
}
async function runMistakes(){ await rp('mk-btn','/api/common-mistakes',{topic:V('mk-topic')||'Integration'},'mk-result',r=>r.mistakes,'Show Mistakes'); }

async function rp(btnId, url, payload, resId, extract, label){
  const btn=document.getElementById(btnId), box=document.getElementById(resId);
  setLoad(btn,true,'Loading...'); box.style.display='none';
  try{ showRes(resId, extract(await post(url,payload))||'No result.'); }
  catch(e){ showRes(resId,'‚ö†Ô∏è '+e.message,true); }
  finally{ setLoad(btn,false,label); }
}

function showRes(id, text, isErr=false){
  const box=document.getElementById(id); if(!box) return;
  box.style.display='block';
  box.style.borderColor=isErr?'rgba(255,107,107,.3)':'rgba(0,217,255,.15)';
  box.innerHTML=fmt(text);
  setTimeout(()=>{ renderMath(box); box.scrollTop=0; },80);
}

function setLoad(btn,on,label=''){
  if(!btn) return;
  btn.disabled=on;
  btn.innerHTML=on?`<span class="loading-spin"></span>${label}`:label;
}

/* ‚ïê‚ïê CHAT ‚ïê‚ïê */
async function sendMsg(){
  if(mode!=='ask'){handlePanelEnter();return;}
  const inp=document.getElementById('input'), text=inp.value.trim();
  if((!text&&!imgB64)||busy) return;
  document.getElementById('welcome')?.remove();
  addMsg('user',text||'üì∏ Image uploaded');
  inp.value=''; inp.style.height='auto';
  const ci=imgB64, ct=imgType; removeImg();
  chatHistory.push({role:'user',content:text||'Solve this image'});
  if(chatHistory.length>20) chatHistory=chatHistory.slice(-20);
  saveChatHistory();
  showTyping(); busy=true;
  try{
    const payload={messages:chatHistory};
    if(ci){payload.image_b64=ci;payload.image_type=ct;}
    const r=await post('/api/chat',payload);
    hideTyping();
    const ans=r.answer||'‚ö†Ô∏è No response.';
    chatHistory.push({role:'assistant',content:ans});
    if(chatHistory.length>20) chatHistory=chatHistory.slice(-20);
    saveChatHistory();
    addMsg('bot',ans);
  }catch(e){ hideTyping(); addMsg('bot','‚ö†Ô∏è Error: '+e.message); }
}

function handlePanelEnter(){
  const val=document.getElementById('input').value.trim(); if(!val) return;
  document.getElementById('input').value='';
  const map={formula:()=>{document.getElementById('f-topic').value=val;runFormula();},graph:()=>{document.getElementById('g-expr').value=val;runGraph();},mathematician:()=>{document.getElementById('m-name').value=val;runMathematician();},theorem:()=>{document.getElementById('t-name').value=val;runTheorem();},mistakes:()=>{document.getElementById('mk-topic').value=val;runMistakes();}};
  if(map[mode]) map[mode]();
}

function addMsg(role,text){
  const chat=document.getElementById('chat');
  const div=document.createElement('div'); div.className=`msg ${role}`;
  const av=role==='bot'?logoImg(34,8):'üë§';
  div.innerHTML=`<div class="avatar">${av}</div><div class="bubble"></div>`;
  div.querySelector('.bubble').innerHTML=fmt(text);
  chat.appendChild(div); chat.scrollTop=chat.scrollHeight;
  requestAnimationFrame(()=>{renderMath(div.querySelector('.bubble'));chat.scrollTop=chat.scrollHeight;});
}

function showTyping(){
  document.getElementById('send-btn').disabled=true;
  const chat=document.getElementById('chat');
  const div=document.createElement('div'); div.className='msg bot'; div.id='typing-ind';
  div.innerHTML=`<div class="avatar">${logoImg(34,8)}</div><div class="typing"><div class="td"></div><div class="td"></div><div class="td"></div></div>`;
  chat.appendChild(div); chat.scrollTop=chat.scrollHeight;
}

function hideTyping(){
  busy=false; document.getElementById('send-btn').disabled=false;
  document.getElementById('typing-ind')?.remove();
}

function fmt(text){
  if(!text) return '';
  let t=String(text);
  const blocks=[];
  const save=m=>{blocks.push(m);return`\x00B${blocks.length-1}\x00`;};
  t=t.replace(/\\\[[\s\S]*?\\\]/g,save);
  t=t.replace(/\\\([\s\S]*?\\\)/g,save);
  t=t.replace(/\$\$[\s\S]*?\$\$/g,save);
  t=t.replace(/\$[^\$\n]+?\$/g,save);
  t=t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  t=t.replace(/\x00B(\d+)\x00/g,(_,i)=>blocks[+i]);
  t=t.replace(/```[\w]*\n?([\s\S]*?)```/g,'<pre>$1</pre>');
  t=t.replace(/`([^`\n]+)`/g,'<code>$1</code>');
  t=t.replace(/\n/g,'<br>');
  return t;
}

function escH(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function esc(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
function V(id){ const el=document.getElementById(id); return el?el.value.trim():''; }
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}

async function quickChat(msg){
  if(mode!=='ask'){setMode('ask');setTimeout(()=>{document.getElementById('input').value=msg;sendMsg();},300);return;}
  document.getElementById('input').value=msg; await sendMsg();
}

async function post(url,data){
  const r=await fetch(API_BASE+url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(!r.ok) throw new Error(`Error ${r.status}`);
  return r.json();
}

function toast(msg,type='ok'){
  const t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300);},2500);
}

function handleImg(e){
  const file=e.target.files[0]; if(!file) return;
  if(mode!=='ask'){toast('Image upload only in Ask Anupam','info');return;}
  const r=new FileReader();
  r.onload=ev=>{const res=ev.target.result;imgB64=res.split(',')[1];imgType=file.type;document.getElementById('prev-img').src=res;document.getElementById('imgpreview').style.display='block';toast('Image ready ‚Äî press Send','ok');};
  r.readAsDataURL(file);
}

function removeImg(){
  imgB64=null;imgType=null;
  document.getElementById('imgpreview').style.display='none';
  document.getElementById('filein').value='';
}
</script>
</body>
</html>