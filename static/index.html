<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=1.0,user-scalable=no"/>
<title>MathSphere v5.0 â€” Ultimate Math Platform by Anupam Nigam</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"/>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<style>
/* â”€â”€ CSS VARIABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --bg:#07090e; --sur:#0d1018; --sur2:#12161f; --sur3:#181e2c;
  --bor:#1a2030; --bor2:#222b3d;
  --acc:#4f8ef7; --acc2:#7c5cfc; --acc3:#00d4a8; --acc4:#f7934f;
  --txt:#dde1f0; --txt2:#7d879e; --txt3:#404b60;
  --red:#e84040; --green:#2dd67a; --yellow:#f7c34f;
  --fH:'Syne',sans-serif; --fB:'DM Sans',sans-serif; --fM:'DM Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:var(--fB);font-size:14.5px;line-height:1.65;overflow:hidden}
.katex{color:var(--txt);font-size:1.04em}
.katex-display{margin:10px 0;overflow-x:auto;overflow-y:hidden}
.katex-display>.katex{text-align:left}

/* animated grid + glow background */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 90% 60% at 15% 0%,rgba(79,142,247,.09),transparent 55%),
             radial-gradient(ellipse 70% 50% at 85% 100%,rgba(124,92,252,.08),transparent 55%),
             radial-gradient(ellipse 50% 35% at 60% 40%,rgba(0,212,168,.05),transparent 50%);
  animation:bg 14s ease-in-out infinite alternate}
@keyframes bg{
  0%{background:radial-gradient(ellipse 90% 60% at 15% 0%,rgba(79,142,247,.09),transparent 55%),radial-gradient(ellipse 70% 50% at 85% 100%,rgba(124,92,252,.08),transparent 55%)}
  100%{background:radial-gradient(ellipse 90% 60% at 10% 25%,rgba(0,212,168,.07),transparent 55%),radial-gradient(ellipse 70% 50% at 90% 80%,rgba(79,142,247,.08),transparent 55%)}}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(255,255,255,.013) 1px,transparent 1px),
                   linear-gradient(90deg,rgba(255,255,255,.013) 1px,transparent 1px);
  background-size:44px 44px}

/* floating math symbols */
#particles{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.particle{position:absolute;font-family:var(--fM);color:rgba(79,142,247,.11);
  animation:drift linear infinite;user-select:none}
@keyframes drift{0%{transform:translateY(105vh);opacity:0}8%,92%{opacity:1}100%{transform:translateY(-10vh);opacity:0}}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{position:relative;z-index:1;display:flex;height:100vh;max-width:1120px;margin:0 auto}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar{width:244px;flex-shrink:0;border-right:1px solid var(--bor);
  background:rgba(7,9,14,.96);backdrop-filter:blur(28px);
  display:flex;flex-direction:column;overflow:hidden;transition:transform .3s ease;position:relative}
#sidebar::after{content:'';position:absolute;top:0;left:0;width:1px;height:100%;
  background:linear-gradient(180deg,transparent,var(--acc),var(--acc2),transparent);
  opacity:.3;animation:shine 5s ease-in-out infinite}
@keyframes shine{0%,100%{opacity:.1}50%{opacity:.5}}

.logo-wrap{padding:16px 14px 12px;border-bottom:1px solid var(--bor);display:flex;align-items:center;gap:10px}
.logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--acc),var(--acc2));
  border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;
  box-shadow:0 0 20px rgba(79,142,247,.3);animation:iconP 3s ease-in-out infinite}
@keyframes iconP{0%,100%{box-shadow:0 0 18px rgba(79,142,247,.3)}50%{box-shadow:0 0 30px rgba(79,142,247,.55)}}
.logo-name{font-family:var(--fH);font-weight:800;font-size:15px;letter-spacing:-.2px;
  background:linear-gradient(90deg,#dde1f0,#7d879e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.logo-by{font-size:9px;color:var(--txt3);font-family:var(--fM);letter-spacing:1px;text-transform:uppercase;margin-top:1px}

.sb-section{padding:10px 10px 4px;font-size:9px;color:var(--txt3);font-family:var(--fM);letter-spacing:1.5px;text-transform:uppercase}
.nav-btn{display:flex;align-items:center;gap:9px;width:100%;padding:8px 12px;border:none;
  background:none;color:var(--txt2);cursor:pointer;border-radius:8px;
  font-family:var(--fB);font-size:13px;transition:all .22s;text-align:left;position:relative;overflow:hidden}
.nav-btn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;
  background:linear-gradient(180deg,var(--acc),var(--acc2));border-radius:0 2px 2px 0;
  transform:scaleY(0);transition:transform .22s}
.nav-btn:hover{background:var(--sur2);color:var(--txt);transform:translateX(3px)}
.nav-btn.active{background:rgba(79,142,247,.12);color:var(--acc);border:1px solid rgba(79,142,247,.2)}
.nav-btn.active::before{transform:scaleY(1)}
.nav-btn .em{width:20px;text-align:center;font-size:14px;transition:transform .22s}
.nav-btn:hover .em{transform:scale(1.2) rotate(-5deg)}
.sb-scroll{flex:1;overflow-y:auto;padding:6px 8px;scrollbar-width:none}
.sb-scroll::-webkit-scrollbar{display:none}
.sb-footer{padding:12px 10px;border-top:1px solid var(--bor);display:flex;gap:7px;flex-wrap:wrap}
.soc-link{font-size:10px;color:var(--txt3);font-family:var(--fM);text-decoration:none;
  padding:3px 8px;border:1px solid var(--bor);border-radius:5px;transition:all .2s}
.soc-link:hover{color:var(--acc);border-color:var(--acc)}

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#topbar{display:flex;align-items:center;gap:10px;padding:12px 20px;
  border-bottom:1px solid var(--bor);background:var(--sur);backdrop-filter:blur(20px);flex-shrink:0}
#menu-toggle{display:none;background:none;border:1px solid var(--bor);color:var(--txt2);
  width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:15px;align-items:center;justify-content:center}
#mode-title{font-family:var(--fH);font-weight:700;font-size:16px;flex:1;transition:all .25s}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--acc3);
  box-shadow:0 0 6px var(--acc3);animation:dp 2s ease-in-out infinite;flex-shrink:0}
@keyframes dp{0%,100%{box-shadow:0 0 4px var(--acc3)}50%{box-shadow:0 0 10px var(--acc3),0 0 0 4px rgba(0,212,168,0)}}
#clear-btn{background:none;border:1px solid var(--bor);color:var(--txt3);padding:5px 10px;
  border-radius:6px;font-size:10px;font-family:var(--fM);cursor:pointer;
  letter-spacing:.5px;transition:all .2s}
#clear-btn:hover{border-color:var(--red);color:var(--red)}
#owner-name{font-family:var(--fH);font-weight:700;font-size:12px;color:var(--acc3);padding:4px 9px;border:1px solid var(--bor2);border-radius:999px;background:var(--sur2)}
#theme-btn{background:none;border:1px solid var(--bor);color:var(--txt3);padding:5px 10px;border-radius:6px;font-size:10px;font-family:var(--fM);cursor:pointer;letter-spacing:.5px;transition:all .2s}
#theme-btn:hover{border-color:var(--acc);color:var(--acc)}
body.light{
  --bg:#f5f7ff; --sur:#ffffff; --sur2:#eef2ff; --sur3:#e7ecfa;
  --bor:#d6ddf1; --bor2:#c3cde6;
  --txt:#1e2940; --txt2:#4b5a79; --txt3:#7a88a9;
}

/* â”€â”€ TAGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#tagsbar{display:flex;gap:7px;padding:9px 20px;border-bottom:1px solid var(--bor);
  background:var(--sur2);overflow-x:auto;flex-shrink:0;scrollbar-width:none}
#tagsbar::-webkit-scrollbar{display:none}
.tag{background:var(--sur2);border:1px solid var(--bor);color:var(--txt2);padding:4px 11px;
  border-radius:18px;font-size:10.5px;font-family:var(--fM);cursor:pointer;white-space:nowrap;transition:all .22s}
.tag:hover{background:var(--sur3);border-color:var(--acc);color:var(--acc);transform:translateY(-2px)}

/* â”€â”€ CHAT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat{flex:1;overflow-y:auto;padding:20px 20px 10px;display:flex;flex-direction:column;gap:16px;
  scrollbar-width:thin;scrollbar-color:var(--bor2) transparent}
#chat::-webkit-scrollbar{width:3px}
#chat::-webkit-scrollbar-thumb{background:var(--bor2);border-radius:3px}

/* â”€â”€ WELCOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;padding:40px 20px;text-align:center;animation:wIn .7s cubic-bezier(.4,0,.2,1) both}
@keyframes wIn{from{opacity:0;transform:translateY(24px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.big-icon-wrap{position:relative;margin-bottom:28px}
.big-icon{width:84px;height:84px;background:linear-gradient(135deg,var(--acc),var(--acc2));
  border-radius:22px;display:flex;align-items:center;justify-content:center;font-size:34px;
  box-shadow:0 0 50px rgba(79,142,247,.3);animation:flt 4s ease-in-out infinite;overflow:hidden;position:relative;z-index:1}
@keyframes flt{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-10px) rotate(2deg)}}
.orbit{position:absolute;top:50%;left:50%;border-radius:50%;border:1px solid;transform:translate(-50%,-50%)}
.orbit1{width:116px;height:116px;border-color:rgba(79,142,247,.25);animation:spin 8s linear infinite}
.orbit2{width:148px;height:148px;border-color:rgba(124,92,252,.18);animation:spin 14s linear infinite reverse}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
.orbit-dot{position:absolute;top:-3px;left:calc(50% - 3px);width:6px;height:6px;border-radius:50%}
.od1{background:var(--acc);box-shadow:0 0 8px var(--acc)}
.od2{background:var(--acc2);box-shadow:0 0 7px var(--acc2)}
#welcome h1{font-family:var(--fH);font-size:30px;font-weight:800;letter-spacing:-1px;margin-bottom:8px;
  background:linear-gradient(135deg,#dde1f0 30%,var(--acc) 70%,var(--acc2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
#welcome p{color:var(--txt2);max-width:440px;font-size:13.5px;line-height:1.7;margin-bottom:26px}
.feat-grid{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:500px}
.feat{background:var(--sur2);border:1px solid var(--bor);border-radius:7px;padding:5px 12px;
  font-size:11px;color:var(--txt2);font-family:var(--fM);cursor:default;transition:all .25s}
.feat:hover{background:var(--sur3);border-color:var(--acc);color:var(--acc)}

/* â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.msg{display:flex;gap:10px;animation:mIn .3s cubic-bezier(.4,0,.2,1)}
@keyframes mIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg.user{flex-direction:row-reverse}
.avatar{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;
  justify-content:center;font-size:13px;flex-shrink:0;margin-top:2px;overflow:hidden}
.msg.user .avatar{background:linear-gradient(135deg,#1a2540,#1e2f52);border:1px solid #253552}
.msg.bot  .avatar{background:linear-gradient(135deg,var(--acc),var(--acc2));box-shadow:0 0 14px rgba(79,142,247,.3)}
.bubble{max-width:79%;padding:12px 15px;border-radius:13px;font-size:13.5px;
  line-height:1.8;position:relative;overflow-wrap:break-word;min-width:0}
.msg.user .bubble{background:#131d35;border:1px solid #1e2d4a;border-top-right-radius:3px;color:var(--txt)}
.msg.bot  .bubble{background:var(--sur);border:1px solid var(--bor);border-top-left-radius:3px;color:var(--txt)}
.msg.bot  .bubble::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,var(--acc),var(--acc2),var(--acc3),transparent);
  border-radius:13px 13px 0 0;opacity:.5}
.bubble:hover{box-shadow:0 4px 20px rgba(79,142,247,.07)}

/* copy button on every bubble */
.copy-wrap{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap}
.copy-btn{background:rgba(79,142,247,.08);border:1px solid rgba(79,142,247,.25);
  color:var(--acc);padding:4px 12px;border-radius:6px;font-size:11px;
  cursor:pointer;font-family:var(--fM);transition:all .2s;white-space:nowrap}
.copy-btn:hover{background:rgba(79,142,247,.18);border-color:var(--acc);box-shadow:0 0 8px rgba(79,142,247,.2)}
.copy-btn:active{transform:scale(.95)}
.save-btn{background:rgba(0,212,168,.07);border:1px solid rgba(0,212,168,.2);
  color:var(--acc3);padding:4px 10px;border-radius:6px;font-size:11px;
  cursor:pointer;font-family:var(--fM);transition:all .2s}
.save-btn:hover{background:rgba(0,212,168,.16);border-color:var(--acc3)}

/* code blocks inside bubbles */
.bubble pre{background:var(--sur3);border:1px solid var(--bor2);border-radius:8px;
  padding:12px;margin:10px 0;overflow-x:auto;font-family:var(--fM);font-size:12px;
  line-height:1.55;color:#9dd0ff;position:relative}
.pre-copy{position:absolute;top:6px;right:8px;background:var(--acc);color:white;
  padding:2px 8px;border-radius:4px;font-size:10px;cursor:pointer;font-family:var(--fM);
  border:none;transition:all .2s}
.pre-copy:hover{background:var(--acc2)}
.bubble code{font-family:var(--fM);font-size:11.5px;background:var(--sur3);padding:2px 5px;border-radius:4px;color:var(--acc3)}
.bubble .sec{font-family:var(--fH);font-weight:600;font-size:12.5px;color:var(--acc);letter-spacing:.4px;margin:11px 0 4px;display:block}
.bubble hr{border:none;border-top:1px solid var(--bor);margin:9px 0}
.bubble a{color:var(--acc);text-decoration:none;border-bottom:1px solid rgba(79,142,247,.3);transition:all .2s}
.bubble a:hover{border-color:var(--acc)}

/* â”€â”€ TYPING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.typing{display:flex;gap:4px;padding:12px 14px;background:var(--sur);border:1px solid var(--bor);
  border-radius:13px;border-top-left-radius:3px;width:fit-content}
.td{width:5px;height:5px;border-radius:50%;background:var(--acc);animation:td 1.2s ease-in-out infinite}
.td:nth-child(2){animation-delay:.2s;background:var(--acc2)}
.td:nth-child(3){animation-delay:.4s;background:var(--acc3)}
@keyframes td{0%,60%,100%{transform:translateY(0) scale(.8);opacity:.4}30%{transform:translateY(-7px) scale(1);opacity:1}}

/* â”€â”€ QUIZ / CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.qcard{background:var(--sur2);border:1px solid var(--bor2);border-radius:13px;padding:18px;
  display:flex;flex-direction:column;gap:12px;animation:cIn .4s}
@keyframes cIn{from{opacity:0;transform:translateY(12px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
.qquestion{font-size:14px;line-height:1.8;color:var(--txt)}
.qopts{display:flex;flex-direction:column;gap:7px}
.qopt{background:var(--sur3);border:1px solid var(--bor2);border-radius:8px;padding:9px 14px;
  cursor:pointer;font-size:13px;color:var(--txt2);transition:all .22s;text-align:left;
  display:flex;gap:10px;align-items:flex-start;line-height:1.7}
.qopt:hover:not(:disabled){background:var(--sur2);border-color:var(--acc);color:var(--txt);transform:translateX(4px)}
.qopt.correct{background:rgba(45,214,122,.08);border-color:var(--green);color:var(--green)}
.qopt.wrong  {background:rgba(232,64,64,.08);border-color:var(--red);color:var(--red)}
.qopt:disabled{cursor:default}
.qletter{font-family:var(--fM);font-size:11px;font-weight:600;width:22px;height:22px;
  border-radius:5px;background:var(--bor2);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.qfooter{display:flex;justify-content:space-between;align-items:center}
.qprog{height:3px;background:var(--bor);border-radius:2px;overflow:hidden;margin:2px 0}
.qbar{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));transition:width .6s}
.qexpl{background:rgba(79,142,247,.06);border:1px solid rgba(79,142,247,.15);
  border-radius:8px;padding:10px 13px;font-size:12.5px;color:var(--txt2);display:none;line-height:1.7}
.qnext{background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:8px;
  color:white;padding:8px 18px;font-size:12.5px;cursor:pointer;font-family:var(--fB);
  box-shadow:0 0 14px rgba(79,142,247,.25);transition:all .22s}
.qnext:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(79,142,247,.4)}

/* â”€â”€ PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel{display:flex;flex-direction:column;gap:9px}
.ptitle{font-family:var(--fH);font-weight:700;font-size:14px;color:var(--txt);margin-bottom:4px}
.psubtitle{font-size:11px;color:var(--txt3);font-family:var(--fM);margin-bottom:4px}
.pbtn{background:var(--sur2);border:1px solid var(--bor);color:var(--txt2);border-radius:8px;
  padding:9px 13px;cursor:pointer;font-size:12.5px;transition:all .22s;
  text-align:left;font-family:var(--fB);position:relative;overflow:hidden}
.pbtn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;
  background:linear-gradient(180deg,var(--acc),var(--acc2));transform:scaleY(0);transition:transform .22s;border-radius:0 2px 2px 0}
.pbtn:hover{background:var(--sur3);border-color:var(--acc);color:var(--txt);padding-left:17px}
.pbtn:hover::before{transform:scaleY(1)}
.pgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.pbtn-sub{font-size:11px;color:var(--txt3);margin-top:2px;display:block;font-family:var(--fM)}

/* stage card for learning paths */
.stage-card{background:var(--sur3);border-radius:9px;padding:13px;border-left:3px solid var(--acc);margin:5px 0}
.stage-name{font-size:12.5px;font-weight:600;color:var(--acc);margin-bottom:5px}
.stage-item{font-size:11.5px;color:var(--txt2);margin:3px 0}
.stage-outcome{font-size:11px;color:var(--acc3);margin-top:5px}

/* theorem card */
.thm-card{background:var(--sur3);border-radius:9px;padding:13px;margin:7px 0;border:1px solid var(--bor2)}
.thm-label{font-size:10px;color:var(--acc);font-family:var(--fM);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px}
.thm-text{font-size:13px;color:var(--txt);line-height:1.7}
.thm-badge{display:inline-block;font-size:10px;font-family:var(--fM);
  padding:2px 8px;border-radius:4px;margin-right:4px;margin-top:4px}
.badge-hard{background:rgba(247,147,79,.12);border:1px solid rgba(247,147,79,.3);color:var(--acc4)}
.badge-mid {background:rgba(79,142,247,.12);border:1px solid rgba(79,142,247,.3);color:var(--acc)}
.badge-easy{background:rgba(45,214,122,.12);border:1px solid rgba(45,214,122,.3);color:var(--green)}

/* competition problem */
.comp-card{background:var(--sur3);border-radius:9px;padding:13px;margin:7px 0;border:1px solid var(--bor2);position:relative}
.comp-meta{font-size:10px;color:var(--txt3);font-family:var(--fM);margin-bottom:7px}
.comp-prob{font-size:13px;color:var(--txt);line-height:1.75}
.hint-toggle{background:none;border:1px solid var(--bor2);color:var(--txt3);font-size:11px;
  padding:4px 10px;border-radius:6px;cursor:pointer;font-family:var(--fM);margin-top:8px;transition:all .2s}
.hint-toggle:hover{border-color:var(--yellow);color:var(--yellow)}
.hint-box{background:rgba(247,195,79,.06);border:1px solid rgba(247,195,79,.2);border-radius:7px;
  padding:10px;margin-top:8px;font-size:12px;color:var(--txt2);display:none}
.ans-box{background:rgba(45,214,122,.06);border:1px solid rgba(45,214,122,.2);border-radius:7px;
  padding:10px;margin-top:8px;font-size:12px;color:var(--txt2);display:none}

/* result card */
.result-card{background:var(--sur2);border:1px solid var(--bor2);border-radius:13px;padding:24px;text-align:center}
.result-score{font-family:var(--fH);font-size:52px;font-weight:800;
  background:linear-gradient(135deg,var(--acc),var(--acc2));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text}

/* info row */
.info-row{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--txt2);margin:3px 0}
.info-label{font-size:10px;color:var(--txt3);font-family:var(--fM);min-width:80px}

/* â”€â”€ INPUT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#inputarea{padding:12px 20px 14px;border-top:1px solid var(--bor);
  background:rgba(7,9,14,.93);backdrop-filter:blur(22px);
  flex-shrink:0;z-index:999;will-change:transform;transform:translateZ(0)}
#imgpreview{display:none;margin-bottom:8px;position:relative}
#imgpreview img{width:70px;height:52px;object-fit:cover;border-radius:7px;border:1px solid var(--bor2)}
#imgpreview button{position:absolute;top:-4px;right:-4px;width:15px;height:15px;
  background:var(--red);border-radius:50%;border:none;color:white;font-size:9px;
  cursor:pointer;display:flex;align-items:center;justify-content:center}
.inp-wrap{display:flex;gap:8px;align-items:flex-end;background:var(--sur2);
  border:1px solid var(--bor2);border-radius:12px;padding:9px 9px 9px 15px;transition:border-color .25s,box-shadow .25s}
.inp-wrap:focus-within{border-color:var(--acc);box-shadow:0 0 0 3px rgba(79,142,247,.09)}
#input{flex:1;background:none;border:none;outline:none;color:var(--txt);
  font-family:var(--fB);font-size:13.5px;line-height:1.6;resize:none;
  max-height:120px;min-height:22px}
#input::placeholder{color:var(--txt3)}
.inp-btns{display:flex;gap:6px;align-items:center;flex-shrink:0}
.iico{width:32px;height:32px;background:var(--sur3);border:1px solid var(--bor);
  border-radius:7px;color:var(--txt3);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:14px;transition:all .22s}
.iico:hover{background:var(--sur2);border-color:var(--bor2);color:var(--txt2);transform:scale(1.08) rotate(-5deg)}
#send-btn{width:32px;height:32px;background:linear-gradient(135deg,var(--acc),var(--acc2));
  border:none;border-radius:7px;color:white;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:15px;
  box-shadow:0 0 14px rgba(79,142,247,.28);transition:all .22s}
#send-btn:hover{transform:scale(1.1) rotate(5deg);box-shadow:0 0 24px rgba(79,142,247,.5)}
#send-btn:active{transform:scale(.92)}
#send-btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
.inp-hint{text-align:center;margin-top:7px;font-size:9.5px;color:var(--txt3);font-family:var(--fM);letter-spacing:.5px}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{position:fixed;top:18px;right:18px;padding:9px 16px;border-radius:8px;
  font-size:12px;z-index:9999;font-family:var(--fM);animation:toastIn .3s ease;transition:opacity .3s}
@keyframes toastIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.toast.ok{background:var(--sur3);border:1px solid var(--green);color:var(--green)}
.toast.info{background:var(--sur3);border:1px solid var(--acc);color:var(--acc)}

/* bookmarks */
.bm-item{background:var(--sur2);border:1px solid var(--bor);border-radius:9px;padding:12px;margin:5px 0}
.bm-topic{font-size:10px;color:var(--acc);font-family:var(--fM);margin-bottom:4px}
.bm-content{font-size:12px;color:var(--txt2);line-height:1.6}
.bm-del{background:none;border:none;color:var(--txt3);cursor:pointer;font-size:11px;margin-top:5px;transition:color .2s}
.bm-del:hover{color:var(--red)}

/* mobile */
@media(max-width:700px){
  #sidebar{position:fixed;top:0;left:0;bottom:0;z-index:100;transform:translateX(-100%)}
  #sidebar.open{transform:translateX(0)}
  #menu-toggle{display:flex}
  .bubble{max-width:91%}
  #welcome h1{font-size:22px}
  .pgrid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="particles"></div>
<div id="app">

<!-- â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav id="sidebar">
  <div class="logo-wrap">
    <div class="logo-icon">
      <img src="/logo.png" style="width:34px;height:34px;object-fit:contain"
           onerror="this.style.display='none';this.parentNode.textContent='ğŸ§®'"/>
    </div>
    <div>
      <div class="logo-name">MathSphere</div>
      <div class="logo-by">By Anupam Nigam</div>
    </div>
  </div>

  <div class="sb-scroll">
    <div class="sb-section">LEARN</div>

    <button class="nav-btn"        id="nav-askanupam"   onclick="setMode('askanupam')">   <span class="em">ğŸ§ </span>Ask Anupam</button>
    <button class="nav-btn"        id="nav-formula"     onclick="setMode('formula')">     <span class="em">ğŸ“‹</span>Formula Sheet</button>
    <button class="nav-btn"        id="nav-revision"    onclick="setMode('revision')">    <span class="em">âš¡</span>Rapid Revision</button>
    <button class="nav-btn"        id="nav-conceptmap"  onclick="setMode('conceptmap')">  <span class="em">ğŸ—ºï¸</span>Concept Map</button>
    <button class="nav-btn"        id="nav-latex"       onclick="setMode('latex')">       <span class="em">ğŸ§¾</span>LaTeX Generator</button>

    <div class="sb-section">EXPLORE</div>
    <button class="nav-btn"        id="nav-mathematician" onclick="setMode('mathematician')"><span class="em">ğŸ§ </span>Mathematicians (16)</button>
    <button class="nav-btn"        id="nav-projects"    onclick="setMode('projects')">    <span class="em">ğŸš€</span>Projects (20)</button>
    <button class="nav-btn"        id="nav-theorem"     onclick="setMode('theorem')">     <span class="em">ğŸ“</span>Theorem Explorer</button>
    <button class="nav-btn"        id="nav-competition" onclick="setMode('competition')"> <span class="em">ğŸ†</span>Competition Math</button>
    <button class="nav-btn"        id="nav-learning"    onclick="setMode('learning')">    <span class="em">ğŸ“</span>Learning Paths</button>
    <button class="nav-btn"        id="nav-realworld"   onclick="setMode('realworld')">   <span class="em">ğŸŒ</span>Real World Maths</button>
    <button class="nav-btn"        id="nav-research"    onclick="setMode('research')">    <span class="em">ğŸ”¬</span>Research Hub</button>

    <div class="sb-section">PRACTICE</div>
    <button class="nav-btn"        id="nav-quiz"        onclick="setMode('quiz')">        <span class="em">ğŸ“</span>Quiz Mode</button>
    <button class="nav-btn"        id="nav-mocktest"    onclick="setMode('mocktest')">    <span class="em">ğŸ§ª</span>Mock Test (30 Q)</button>
    <button class="nav-btn"        id="nav-challenge"   onclick="setMode('challenge')">   <span class="em">ğŸ§©</span>Daily Challenge</button>
    <button class="nav-btn"        id="nav-pyq"         onclick="setMode('pyq')">         <span class="em">ğŸ“œ</span>PYQ Bank</button>

    <div class="sb-section">EXAMS</div>
    <button class="nav-btn" onclick="showExam('JAM')">  <span class="em">ğŸ“</span>IIT JAM</button>
    <button class="nav-btn" onclick="showExam('GATE')"> <span class="em">ğŸ”¬</span>GATE MA</button>
    <button class="nav-btn" onclick="showExam('CSIR')"> <span class="em">ğŸ“š</span>CSIR NET</button>

    <div class="sb-section">SAVED</div>
    <button class="nav-btn"        id="nav-bookmarks"   onclick="setMode('bookmarks')">   <span class="em">ğŸ”–</span>My Bookmarks</button>
  </div>

  <div class="sb-footer">
    <a class="soc-link" href="https://youtube.com/@pi_nomenal1729"   target="_blank">ğŸ“º YouTube</a>
    <a class="soc-link" href="https://instagram.com/pi_nomenal1729" target="_blank">ğŸ“¸ Insta</a>
    <a class="soc-link" href="https://www.anupamnigam.com"           target="_blank">ğŸŒ Site</a>
  </div>
</nav>

<!-- â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="main">
  <div id="topbar">
    <button id="menu-toggle" onclick="toggleSidebar()">â˜°</button>
    <div id="mode-title">ğŸ§  Ask Anupam</div>
    <div class="status-dot"></div>
    <span style="font-size:10px;color:var(--txt3);font-family:var(--fM)">ONLINE</span>
    <span id="owner-name">Anupam Nigam</span>
    <button id="theme-btn" onclick="toggleTheme()">ğŸŒ™ Dark</button>
    <button id="clear-btn" onclick="clearAll()">CLEAR</button>
  </div>
  <div id="tagsbar"></div>
  <div id="chat"></div>
  <div id="inputarea">
    <div id="imgpreview">
      <img id="prev-img" src="" alt=""/>
      <button onclick="removeImg()">âœ•</button>
    </div>
    <div class="inp-wrap">
      <textarea id="input" rows="1" placeholder="Ask any math question..."
                onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <div class="inp-btns">
        <input type="file" id="filein" accept="image/*" style="display:none" onchange="handleImg(event)"/>
        <button class="iico" onclick="document.getElementById('filein').click()" title="Upload image">ğŸ“¸</button>
        <button id="send-btn" onclick="sendMsg()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="inp-hint">MATHSPHERE v5.0 Â· BY ANUPAM NIGAM Â· youtube.com/@pi_nomenal1729</div>
  </div>
</div>

</div><!-- #app -->

<script>
/* â•â• PARTICLES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(()=>{
  const syms=['âˆ«','âˆ‘','Ï€','âˆ','âˆš','âˆ‚','âˆ‡','Î»','Î”','Î¸','Î±','Î²','Î³','Îµ','â‰ ','â‰ˆ','Â±','âŠ•','â„','â„¤'];
  const c=document.getElementById('particles');
  for(let i=0;i<20;i++){
    const p=document.createElement('div');p.className='particle';
    p.textContent=syms[Math.floor(Math.random()*syms.length)];
    p.style.cssText=`left:${Math.random()*100}%;font-size:${10+Math.random()*10}px;opacity:${.05+Math.random()*.1};animation-duration:${18+Math.random()*24}s;animation-delay:${-Math.random()*22}s`;
    c.appendChild(p);
  }
})();

/* â•â• KATEX RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMath(el){
  if(typeof renderMathInElement==='undefined')return;
  renderMathInElement(el,{
    delimiters:[
      {left:'\\[',right:'\\]',display:true},
      {left:'\\(',right:'\\)',display:false},
      {left:'$$',right:'$$',display:true},
      {left:'$', right:'$', display:false}
    ],throwOnError:false,errorColor:'#e84040',strict:false
  });
}

/* â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let mode='askanupam', chatHistory=[], imgB64=null, imgType=null, busy=false;
let quizState=null, mockState=null;
let bookmarks=JSON.parse(localStorage.getItem('ms_bm')||'[]');

const MODE_CFG={
  chat:         {title:'ğŸ’¬ Ask Anything',       ph:'Ask any question...'},
  askanupam:    {title:'ğŸ§  Ask Anupam',         ph:'Ask anything: math, coding, writing, or upload an image...'},
  formula:      {title:'ğŸ“‹ Formula Sheet',       ph:'Topic + exam, e.g. "Calculus JAM" or "Linear Algebra GATE"'},
  revision:     {title:'âš¡ Rapid Revision',       ph:'Type a topic for 10 key revision points...'},
  conceptmap:   {title:'ğŸ—ºï¸ Concept Map',          ph:'Type a topic to explore all its connections...'},
  latex:        {title:'ğŸ§¾ LaTeX Generator',      ph:'Describe what you need LaTeX code for...'},
  mathematician:{title:'ğŸ§  Mathematicians (16)',  ph:'Type a name or click a card...'},
  projects:     {title:'ğŸš€ Projects (20)',        ph:'Type a domain or click a project...'},
  theorem:      {title:'ğŸ“ Theorem Explorer',     ph:'Click a theorem to see full proof...'},
  competition:  {title:'ğŸ† Competition Math',     ph:'IMO Â· Putnam Â· AIME problems...'},
  learning:     {title:'ğŸ“ Learning Paths',       ph:'Select a learning path...'},
  realworld:    {title:'ğŸŒ Real World Maths',     ph:'See where maths is used in industry...'},
  research:     {title:'ğŸ”¬ Research Hub',         ph:'Ask about research areas, open problems...'},
  quiz:         {title:'ğŸ“ Quiz Mode',            ph:''},
  mocktest:     {title:'ğŸ§ª Mock Test (30 Q)',      ph:''},
  challenge:    {title:'ğŸ§© Daily Challenge',      ph:'Type your solution here...'},
  pyq:          {title:'ğŸ“œ PYQ Bank',             ph:''},
  bookmarks:    {title:'ğŸ”– My Bookmarks',         ph:''},
};

window.onload=()=>{initTheme();setMode('askanupam');renderTagsBar();};

/* â•â• WELCOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showWelcome(){
  document.getElementById('chat').innerHTML=`
  <div id="welcome">
    <div class="big-icon-wrap">
      <div class="orbit orbit1"><div class="orbit-dot od1"></div></div>
      <div class="orbit orbit2"><div class="orbit-dot od2" style="top:auto;bottom:-3px"></div></div>
      <div class="big-icon">
        <img src="/logo.png" style="width:60px;height:60px;object-fit:contain"
             onerror="this.style.display='none';this.parentNode.textContent='ğŸ§®'"/>
      </div>
    </div>
    <h1>MathSphere</h1>
    <p>Your complete AI mathematics platform â€” step-by-step solutions, exam prep, career guidance, theorem explorer, competition problems, and much more. By Anupam Nigam.</p>
    <div class="feat-grid">
      <div class="feat">âš¡ Groq AI</div>
      <div class="feat">ğŸ§  16 Mathematicians</div>
      <div class="feat">ğŸš€ 20 Projects</div>
      <div class="feat">ğŸ“ Theorem Explorer</div>
      <div class="feat">ğŸ† IMO Â· Putnam Â· AIME</div>
      <div class="feat">ğŸ“ JAM Â· GATE Â· CSIR</div>
      <div class="feat">ğŸ“‹ Copy Everything</div>
      <div class="feat">ğŸ“¸ Image Solving</div>
    </div>
  </div>`;
}

/* â•â• MODE SWITCHING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setMode(m){
  mode=m;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const nb=document.getElementById(`nav-${m}`);if(nb)nb.classList.add('active');
  const cfg=MODE_CFG[m]||MODE_CFG.chat;
  const mt=document.getElementById('mode-title');
  mt.style.opacity='0';mt.style.transform='translateY(-5px)';
  setTimeout(()=>{mt.textContent=cfg.title;mt.style.opacity='1';mt.style.transform='translateY(0)';},150);
  document.getElementById('input').placeholder=cfg.ph||'Type here...';
  document.getElementById('sidebar').classList.remove('open');
  renderTagsBar();

  if(m==='mathematician'){loadMathematicians();return;}
  if(m==='projects')     {loadProjects();return;}
  if(m==='theorem')      {loadTheorems();return;}
  if(m==='competition')  {loadCompetition('IMO');return;}
  if(m==='learning')     {loadLearningPaths();return;}
  if(m==='realworld')    {loadRealWorld();return;}
  if(m==='research')     {loadResearchHub();return;}
  if(m==='quiz')         {showQuizTopics();return;}
  if(m==='mocktest')     {showMockTopics();return;}
  if(m==='challenge')    {loadChallenge();return;}
  if(m==='pyq')          {showPYQTopics();return;}
  if(m==='bookmarks')    {showBookmarks();return;}
  clearAll();
}

function clearAll(){chatHistory=[];imgB64=null;imgType=null;removeImg();showWelcome();}
function rmWelcome(){const w=document.getElementById('welcome');if(w)w.remove();}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}

document.addEventListener('click',e=>{
  const sb=document.getElementById('sidebar');
  if(window.innerWidth<=700&&sb.classList.contains('open')&&
     !sb.contains(e.target)&&!document.getElementById('menu-toggle').contains(e.target))
    sb.classList.remove('open');
});

/* â•â• TAGS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTagsBar(){
  const bar=document.getElementById('tagsbar');
  const tags={
    chat:        [['âˆ« Integration','Explain integration by parts with worked example'],
                  ['Î» Eigenvalues','Explain eigenvalues and eigenvectors'],
                  ['Îµ-Î´ Limits','Explain epsilon-delta definition of limit'],
                  ['âˆ‘ Fourier','Explain Fourier series with example'],
                  ['ğŸ² Probability','Explain Bayes theorem with real example'],
                  ['ğŸ”¢ Number Theory','Explain prime numbers and RSA encryption']],
    askanupam:   [['ğŸ“ Solve Maths','Solve this calculus question step by step: evaluate integral of x^2 sin x dx'],
                  ['ğŸ§  Explain Clearly','Explain black holes to a class 8 student with examples'],
                  ['ğŸ’» Coding Help','Write a simple Python script for Fibonacci using recursion and iteration'],
                  ['ğŸ“ Writing Help','Improve this paragraph to professional English and keep same meaning']],              
    formula:     [['Calculus JAM','Calculus JAM'],['Linear Algebra GATE','Linear Algebra GATE'],
                  ['Real Analysis CSIR','Real Analysis CSIR'],['Calculus GATE','Calculus GATE']],
    competition: [['IMO','IMO'],['PUTNAM','PUTNAM'],['AIME','AIME']],
    quiz:        [['Calculus'],['Linear Algebra'],['Real Analysis'],['Algebra'],['Probability'],['Complex Analysis']],
    mocktest:    [['JAM'],['GATE'],['CSIR']],
    pyq:         [['JAM'],['GATE'],['CSIR']],
  };
  if(tags[mode]){
    bar.innerHTML=tags[mode].map(([label,val])=>{
      if(mode==='competition') return `<div class="tag" onclick="loadCompetition('${val}')">${label}</div>`;
      if(mode==='quiz')        return `<div class="tag" onclick="startQuiz('${label}')">${label}</div>`;
      if(mode==='mocktest')    return `<div class="tag" onclick="startMock('${label}')">${label}</div>`;
      if(mode==='pyq')        return `<div class="tag" onclick="loadPYQ('${label}')">${label}</div>`;
      return `<div class="tag" onclick="quickSend('${escQ(val||label)}')">${label}</div>`;
    }).join('');
  } else {
    bar.innerHTML='';
  }
}

/* â•â• SEND MESSAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendMsg(){
  const inp=document.getElementById('input');
  const text=inp.value.trim();
  if((!text&&!imgB64)||busy)return;
  rmWelcome();
  addMsg('user',text||'ğŸ“¸ [Image uploaded]');
  inp.value='';inp.style.height='auto';
  const curImg=imgB64,curType=imgType;removeImg();
  chatHistory.push({role:'user',content:text||'Please solve this problem from the image.'});
  showTyping();
  try{
    let answer;
    if(mode==='formula'){
      const parts=text.split(' ');
      const exams=['JAM','GATE','CSIR'];
      const exam=parts.find(p=>exams.includes(p.toUpperCase()))||'JAM';
      const topic=parts.filter(p=>!exams.includes(p.toUpperCase())).join(' ')||text;
      const r=await api('/api/formula',{topic,exam});answer=r.answer;
    } else if(mode==='revision'){
      const r=await api('/api/revision',{topic:text});answer=r.answer;
    } else if(mode==='conceptmap'){
      const r=await api('/api/conceptmap',{topic:text});answer=r.answer;
    } else if(mode==='latex'){
      const r=await api('/api/latex',{text});answer=r.answer;
    } else if(mode==='research'){
      const r=await api('/api/research',{question:text});answer=r.answer;
    } else {
      const payload={messages:chatHistory.slice(-16),mode: mode==='askanupam' ? 'ask_anupam' : 'normal'};
      if(curImg){payload.image_b64=curImg;payload.image_type=curType;}
      const r=await api('/api/chat',payload);answer=r.answer;
    }
    hideTyping();
    chatHistory.push({role:'assistant',content:answer});
    addMsg('bot',answer);
  } catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

/* â•â• MATHEMATICIAN EXPLORER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadMathematicians(){
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/mathematicians')).json();hideTyping();
    const html=`<div class="panel">
      <div class="ptitle">ğŸ§  Mathematicians Explorer (${d.total})</div>
      <div class="psubtitle">Click any name to view full biography, research papers, and legacy</div>
      <div class="pgrid">${d.mathematicians.map(m=>
        `<button class="pbtn" onclick="loadMathDetail('${escQ(m.name)}')">
          ${m.name}
          <span class="pbtn-sub">${m.period} Â· ${m.country}</span>
          <span class="pbtn-sub">${m.fields.slice(0,2).join(', ')}</span>
        </button>`).join('')}
      </div>
    </div>`;
    addBotHTML(html);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

async function loadMathDetail(name){
  showTyping();
  try{
    const d=await (await fetch('/api/mathematician/'+encodeURIComponent(name))).json();hideTyping();
    const resLinks=d.resources?d.resources.map(r=>`<a href="${r.split(': ')[1]}" target="_blank">${r.split(': ')[0]}</a>`).join(' Â· '):'';
    const id='md-'+Date.now();
    const html=`<div class="qcard">
      <div style="display:flex;gap:14px;align-items:flex-start">
        <img src="${d.image}" style="width:70px;height:80px;object-fit:cover;border-radius:9px;border:1px solid var(--bor2);flex-shrink:0"
             onerror="this.style.display='none'" loading="lazy"/>
        <div style="min-width:0">
          <div style="font-size:18px;font-weight:700;color:var(--txt)">${d.name}</div>
          <div style="font-size:12px;color:var(--acc);font-family:var(--fM);margin:3px 0">${d.period} Â· ${d.country}</div>
          <div style="font-size:11px;color:var(--acc2)">${(d.fields||[]).join(' Â· ')}</div>
        </div>
      </div>
      <div style="color:var(--txt2);font-size:13px;line-height:1.7;margin:8px 0" id="${id}-c">${escHtml(d.contribution)}</div>
      <div class="thm-card">
        <div class="thm-label">KEY RESULTS</div>
        <div class="thm-text" id="${id}-k">${escHtml(d.keyresults)}</div>
      </div>
      <div style="background:var(--sur3);border-left:3px solid var(--acc2);padding:10px 13px;border-radius:0 8px 8px 0;font-style:italic;color:var(--txt2);font-size:13px">"${escHtml(d.quote)}"</div>
      <div style="font-size:11px;color:var(--acc3)">ğŸŒ Impact: ${escHtml(d.impact)}</div>
      ${resLinks?`<div style="font-size:11px;color:var(--txt3);margin-top:4px">ğŸ“š ${resLinks}</div>`:''}
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button class="qnext" onclick="loadMathematicians()" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)">â† All Mathematicians</button>
        <button class="qnext" onclick="askAboutMath('${escQ(d.name)}')">Ask AI about ${d.name.split(' ').pop()}</button>
      </div>
    </div>`;
    addBotHTML(html);
    setTimeout(()=>{
      [id+'-c',id+'-k'].forEach(i=>{const el=document.getElementById(i);if(el)renderMath(el);});
    },100);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

function askAboutMath(name){
  mode='chat';
  document.getElementById('input').value=`Tell me deeply about ${name}'s mathematical contributions and how they impact modern mathematics`;
  sendMsg();
}

/* â•â• PROJECTS EXPLORER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadProjects(){
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/projects')).json();hideTyping();
    const diffs={'Advanced':'badge-hard','Intermediate':'badge-mid','Very Advanced':'badge-hard','Easy':'badge-easy'};
    const html=`<div class="panel">
      <div class="ptitle">ğŸš€ Math Projects (${d.total})</div>
      <div class="psubtitle">Real-world projects with companies, salaries, and career paths</div>
      ${d.projects.map(p=>`
        <button class="pbtn" onclick="loadProjectDetail(${p.id})">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <span>${p.id}. ${p.title}</span>
            <span class="thm-badge ${diffs[p.difficulty]||'badge-mid'}">${p.difficulty}</span>
          </div>
          <span class="pbtn-sub">${p.math.slice(0,3).join(' Â· ')}</span>
          <span class="pbtn-sub" style="color:var(--green)">ğŸ’° ${p.salary.split('|')[0].trim()}</span>
        </button>`).join('')}
    </div>`;
    addBotHTML(html);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

async function loadProjectDetail(pid){
  showTyping();
  try{
    const r=await api('/api/project/'+pid,{});hideTyping();
    const p=r.project;
    const id='prj-'+Date.now();
    const explHtml=`<div class="panel">
      <div class="ptitle">ğŸš€ ${p.title}</div>
      <div class="info-row"><span class="info-label">MATH TOPICS</span>${p.math.join(' Â· ')}</div>
      <div class="info-row"><span class="info-label">DESCRIPTION</span>${escHtml(p.desc)}</div>
      <div class="info-row"><span class="info-label">REAL-WORLD</span>${escHtml(p.real)}</div>
      <div class="info-row"><span class="info-label">COMPANIES</span><span style="color:var(--acc2)">${escHtml(p.companies)}</span></div>
      <div class="info-row"><span class="info-label">SALARIES</span><span style="color:var(--green)">${escHtml(p.salary)}</span></div>
      <hr style="border-color:var(--bor);margin:8px 0"/>
      <div style="font-size:12.5px;color:var(--txt2);line-height:1.8" id="${id}-exp">${fmt(r.explanation)}</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button class="qnext" onclick="loadProjects()" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)">â† All Projects</button>
        <button class="copy-btn" onclick="copyTxt(document.getElementById('${id}-exp').innerText)">ğŸ“‹ Copy</button>
      </div>
    </div>`;
    addBotHTML(explHtml);
    setTimeout(()=>{const el=document.getElementById(`${id}-exp`);if(el)renderMath(el);},100);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

/* â•â• THEOREM EXPLORER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadTheorems(){
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/theorems')).json();hideTyping();
    const html=`<div class="panel">
      <div class="ptitle">ğŸ“ Theorem Explorer (${d.total})</div>
      <div class="psubtitle">Full statements, proofs, exam relevance, and applications</div>
      ${d.theorems.map(t=>`<button class="pbtn" onclick="loadTheoremDetail('${escQ(t)}')">${t}</button>`).join('')}
    </div>`;
    addBotHTML(html);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

async function loadTheoremDetail(name){
  showTyping();
  try{
    const d=await (await fetch('/api/theorem/'+encodeURIComponent(name))).json();hideTyping();
    const diff={'Basic':'badge-easy','Core':'badge-easy','Intermediate':'badge-mid','Advanced':'badge-hard','Hard':'badge-hard','Very Hard':'badge-hard'}[d.difficulty]||'badge-mid';
    const ids={s:'s'+Date.now(),p:'p'+Date.now(),f:'f'+Date.now()};
    const html=`<div class="panel">
      <div class="ptitle">ğŸ“ ${d.name}</div>
      <div style="margin-bottom:2px">
        <span class="thm-badge ${diff}">${d.difficulty}</span>
        <span class="thm-badge" style="background:rgba(0,212,168,.1);border:1px solid rgba(0,212,168,.3);color:var(--acc3)">ğŸ“‹ ${d.exam_relevance||'Key theorem'}</span>
      </div>
      <div class="thm-card">
        <div class="thm-label">STATEMENT</div>
        <div class="thm-text" id="${ids.s}">${escHtml(d.statement)}</div>
      </div>
      <div class="thm-card">
        <div class="thm-label">PROOF SKETCH</div>
        <div class="thm-text" id="${ids.p}">${escHtml(d.proof_sketch)}</div>
      </div>
      <div class="thm-card">
        <div class="thm-label">FORMAL PROOF</div>
        <div class="thm-text" id="${ids.f}">${escHtml(d.formal_proof)}</div>
      </div>
      <div class="thm-card" style="border-color:rgba(0,212,168,.2)">
        <div class="thm-label">APPLICATIONS</div>
        <div class="thm-text">${escHtml(d.applications)}</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button class="qnext" onclick="loadTheorems()" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)">â† All Theorems</button>
        <button class="qnext" onclick="askAboutTheorem('${escQ(d.name)}')">Ask AI to explain</button>
        <button class="copy-btn" onclick="copyTxt('${escQ(d.name+':\\n'+d.statement+'\\n\\nProof: '+d.proof_sketch)}')">ğŸ“‹ Copy</button>
      </div>
    </div>`;
    addBotHTML(html);
    setTimeout(()=>{Object.values(ids).forEach(id=>{const el=document.getElementById(id);if(el)renderMath(el);});},100);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

function askAboutTheorem(name){
  mode='chat';
  document.getElementById('input').value=`Explain ${name} in depth with all the details, intuition, proof, and real-world applications`;
  sendMsg();
}

/* â•â• COMPETITION MATH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadCompetition(cat){
  setModeTitle(`ğŸ† Competition Math â€” ${cat}`);
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/competition/'+cat)).json();hideTyping();
    const tagBar=document.getElementById('tagsbar');
    tagBar.innerHTML=['IMO','PUTNAM','AIME'].map(c=>
      `<div class="tag" onclick="loadCompetition('${c}')" style="${cat===c?'border-color:var(--acc);color:var(--acc)':''}">${c}</div>`).join('');

    const html=`<div class="panel">
      <div class="ptitle">ğŸ† ${cat} Problems (${d.total})</div>
      <div class="psubtitle">
        ${cat==='IMO'?'International Mathematical Olympiad â€” world\'s hardest math competition':
          cat==='PUTNAM'?'William Lowell Putnam Examination â€” top US/Canada university math competition':
          'American Invitational Mathematics Examination â€” leading to USA(J)MO'}
      </div>
      ${d.problems.map((p,i)=>{
        const metaLine=p.session?`${p.year} ${p.session}`:p.number?`${p.year} Problem ${p.number}`:`Problem ${i+1}`;
        const diffBadge={Hard:'badge-hard',Medium:'badge-mid','Very Hard':'badge-hard',Easy:'badge-easy'}[p.difficulty]||'badge-mid';
        const pid='cp'+i+Date.now();
        return `<div class="comp-card">
          <div class="comp-meta">${metaLine} Â· <span class="thm-badge ${diffBadge}">${p.difficulty}</span></div>
          <div class="comp-prob" id="prob-${pid}">${escHtml(p.problem)}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="hint-toggle" onclick="toggleHint('${pid}')">ğŸ’¡ Hint</button>
            <button class="hint-toggle" onclick="toggleAns('${pid}')" style="color:var(--green);border-color:rgba(45,214,122,.3)">âœ… Answer</button>
            <button class="copy-btn" onclick="copyTxt(document.getElementById('prob-${pid}').innerText)">ğŸ“‹ Copy Problem</button>
            <button class="copy-btn" onclick="solveCompProblem('${escQ(p.problem)}')">ğŸ¤– Ask AI to Solve</button>
          </div>
          <div class="hint-box" id="hint-${pid}" style="display:none">${escHtml(p.hint)}</div>
          <div class="ans-box"  id="ans-${pid}"  style="display:none" >${escHtml(p.answer||'Work through the hint to find the answer!')}</div>
        </div>`;
      }).join('')}
    </div>`;
    addBotHTML(html);
    setTimeout(()=>{
      document.querySelectorAll('[id^="prob-"]').forEach(el=>renderMath(el));
    },100);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

function toggleHint(pid){
  const h=document.getElementById('hint-'+pid);
  if(h){h.style.display=h.style.display==='none'?'block':'none';if(h.style.display==='block')renderMath(h);}
}
function toggleAns(pid){
  const a=document.getElementById('ans-'+pid);
  if(a){a.style.display=a.style.display==='none'?'block':'none';if(a.style.display==='block')renderMath(a);}
}
function solveCompProblem(prob){
  mode='chat';
  document.getElementById('input').value='Solve this competition problem with full solution:\n\n'+prob;
  sendMsg();
}

/* â•â• LEARNING PATHS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadLearningPaths(){
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/learning-paths')).json();hideTyping();
    const html=`<div class="panel">
      <div class="ptitle">ğŸ“ Learning Paths (${d.total})</div>
      <div class="psubtitle">Complete roadmaps from undergraduate to research/industry with salary milestones</div>
      ${d.paths.map(p=>`
        <button class="pbtn" onclick="loadPathDetail('${escQ(p.name)}')">
          ${p.name}
          <span class="pbtn-sub">${escHtml(p.overview)}</span>
        </button>`).join('')}
    </div>`;
    addBotHTML(html);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

async function loadPathDetail(name){
  showTyping();
  try{
    const d=await (await fetch('/api/learning-path/'+encodeURIComponent(name))).json();hideTyping();
    const stagesHtml=(d.stages||[]).map((s,i)=>`
      <div class="stage-card">
        <div class="stage-name">Stage ${i+1}: ${escHtml(s.name)}</div>
        <div class="stage-item">ğŸ¯ <strong>Goal:</strong> ${escHtml(s.goal)}</div>
        <div class="stage-item">ğŸ“š <strong>Subjects:</strong> ${escHtml(s.subjects.join(' Â· '))}</div>
        <div class="stage-item">ğŸ’¡ <strong>Tips:</strong> ${escHtml(s.tips)}</div>
        <div class="stage-outcome">âœ… ${escHtml(s.outcome)}</div>
      </div>`).join('');

    const html=`<div class="panel">
      <div class="ptitle">ğŸ“ ${escHtml(d.name)}</div>
      <div style="font-size:12px;color:var(--txt2);margin:4px 0">${escHtml(d.overview)}</div>
      <div style="font-size:12px;color:var(--txt3)">â± ${escHtml(d.total_time)}</div>
      <div style="font-size:12.5px;color:var(--green);margin:4px 0">ğŸ’° ${escHtml(d.salary_journey)}</div>
      ${stagesHtml}
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button class="qnext" onclick="loadLearningPaths()" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)">â† All Paths</button>
        <button class="copy-btn" onclick="copySection('${escQ(d.name)}')">ğŸ“‹ Copy Path</button>
      </div>
    </div>`;
    addBotHTML(html);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

/* â•â• REAL WORLD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadRealWorld(){
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/realworld')).json();hideTyping();
    const id='rw-'+Date.now();
    const html=`<div class="panel">
      <div class="ptitle">ğŸŒ Real World Mathematics</div>
      <div class="qcard">
        <div style="font-size:11px;color:var(--acc);font-family:var(--fM)">CONCEPT</div>
        <div style="font-size:18px;font-weight:700;color:var(--txt)">${escHtml(d.concept)}</div>
        <div style="font-size:13px;font-weight:600;color:var(--acc2)">Application: ${escHtml(d.application)}</div>
        <div style="color:var(--txt2);font-size:13px;line-height:1.7;margin:8px 0" id="${id}">${escHtml(d.explanation)}</div>
        <div class="info-row"><span class="info-label">COMPANIES</span><span style="color:var(--acc2)">${escHtml(d.companies)}</span></div>
        <div class="info-row"><span class="info-label">IMPACT</span>${escHtml(d.impact)}</div>
        <div class="info-row"><span class="info-label">SALARY</span><span style="color:var(--green)">${escHtml(d.salary)}</span></div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="qnext" onclick="loadRealWorld()">Next Application â†’</button>
          <button class="copy-btn" onclick="copyTxt(document.getElementById('${id}').innerText)">ğŸ“‹ Copy</button>
          <button class="qnext" onclick="askAboutRealWorld('${escQ(d.concept)}')" style="background:var(--acc2)">ğŸ¤– Ask AI</button>
        </div>
      </div>
    </div>`;
    addBotHTML(html);
    setTimeout(()=>{const el=document.getElementById(id);if(el)renderMath(el);},100);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

function askAboutRealWorld(concept){
  mode='chat';
  document.getElementById('input').value=`Explain in detail how ${concept} is used in the real world. Include all the mathematics with LaTeX formulas.`;
  sendMsg();
}

/* â•â• RESEARCH HUB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadResearchHub(){
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/research-hub')).json();hideTyping();
    const html=`<div class="panel">
      <div class="ptitle">ğŸ”¬ Research Hub (${d.total_topics} Topics)</div>
      <div class="psubtitle">Explore active research areas in mathematics. Click to see all topics.</div>
      ${d.categories.map(cat=>`
        <button class="pbtn" onclick="loadResearchCat('${escQ(cat)}')">
          ${cat}
          <span class="pbtn-sub">Click to explore research topics â†’</span>
        </button>`).join('')}
      <div style="margin-top:8px;padding:12px;background:var(--sur3);border-radius:8px;font-size:12px;color:var(--txt2)">
        ğŸ’¡ You can also type any research question in the input below to get a detailed AI explanation.
      </div>
    </div>`;
    addBotHTML(html);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

async function loadResearchCat(cat){
  showTyping();
  try{
    const d=await (await fetch('/api/research-hub/'+encodeURIComponent(cat))).json();hideTyping();
    const html=`<div class="panel">
      <div class="ptitle">ğŸ”¬ ${escHtml(d.category)} (${d.total} Topics)</div>
      ${d.topics.map((t,i)=>`
        <button class="pbtn" onclick="askResearchTopic('${escQ(t)}')">
          ${i+1}. ${escHtml(t)}
          <span class="pbtn-sub">Click to explore with AI â†’</span>
        </button>`).join('')}
      <button class="qnext" onclick="loadResearchHub()" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor);margin-top:4px">â† All Categories</button>
    </div>`;
    addBotHTML(html);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

function askResearchTopic(t){
  mode='research';
  document.getElementById('input').value='Tell me about research in: '+t;
  sendMsg();
}

/* â•â• EXAM INFO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showExam(exam){
  setModeTitle('ğŸ“ Exam Info â€” '+exam);
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/exam/'+exam)).json();hideTyping();
    const html=`<div class="panel">
      <div class="ptitle">ğŸ“ ${escHtml(d.full_name)}</div>
      <div class="qcard">
        <div class="info-row"><span class="info-label">BODY</span>${escHtml(d.conducting_body)}</div>
        <div class="info-row"><span class="info-label">ELIGIBILITY</span>${escHtml(d.eligibility)}</div>
        <div class="info-row"><span class="info-label">PATTERN</span><span style="white-space:pre-line">${escHtml(d.pattern)}</span></div>
        <div class="info-row"><span class="info-label">SYLLABUS</span>${escHtml(d.syllabus)}</div>
        <div class="info-row"><span class="info-label">WEIGHTAGE</span>${escHtml(d.weightage)}</div>
        <div>
          <div class="info-label" style="display:block;margin-bottom:5px">TOP BOOKS</div>
          ${(d.top_books||[]).map(b=>`<div style="font-size:12px;color:var(--txt2);padding:2px 0">ğŸ“– ${escHtml(b)}</div>`).join('')}
        </div>
        <div style="background:rgba(0,212,168,.06);border:1px solid rgba(0,212,168,.2);border-radius:8px;padding:10px;font-size:12.5px;color:var(--txt2)">
          ğŸ’¡ <strong style="color:var(--acc3)">Strategy:</strong> ${escHtml(d.strategy||'')}
        </div>
        <div style="margin-top:8px">
          <a href="${d.website}" target="_blank" style="color:var(--acc);font-size:13px">ğŸ”— Official Website: ${d.website}</a>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="qnext" onclick="loadPYQ('${exam}')">ğŸ“œ View PYQs</button>
          <button class="qnext" onclick="startMock('${exam}')" style="background:var(--acc2)">ğŸ§ª Take Mock Test</button>
        </div>
      </div>
    </div>`;
    addBotHTML(html);
    document.getElementById('sidebar').classList.remove('open');
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

/* â•â• QUIZ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showQuizTopics(){
  rmWelcome();document.getElementById('chat').innerHTML='';
  const topics=['Calculus','Linear Algebra','Real Analysis','Abstract Algebra',
                'Probability','Number Theory','Complex Analysis','Statistics'];
  addBotHTML(`<div class="panel">
    <div class="ptitle">ğŸ“ Quiz Mode</div>
    <div class="psubtitle">5 questions Â· Immediate feedback Â· Step-by-step explanations</div>
    <div class="pgrid">${topics.map(t=>`<button class="pbtn" onclick="startQuiz('${t}')">${t}</button>`).join('')}</div>
  </div>`);
}

async function startQuiz(topic){
  document.getElementById('chat').innerHTML='';
  quizState={topic,q:0,total:5,score:0};
  addMsg('bot',`ğŸ“ Starting ${topic} Quiz â€” 5 questions! Karo shuru! ğŸš€`);
  await nextQuizQ();
}

async function nextQuizQ(){
  showTyping();
  try{
    const r=await api('/api/quiz/question',{topic:quizState.topic,difficulty:'medium',q_num:quizState.q+1,total:quizState.total});
    hideTyping();quizState.q++;quizState.curAns=r.answer;quizState.curExpl=r.explanation;
    renderQuizCard(r.question,r.answer,r.explanation);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error. '+e.message,true);}
}

function renderQuizCard(question,answer,explanation){
  const lines=question.split('\n').filter(l=>l.trim());
  const qLine=lines.find(l=>l.startsWith('Q:'))||lines[0]||'';
  const opts=lines.filter(l=>/^[A-D]\)/.test(l.trim()));
  const id='qz'+Date.now();
  const html=`<div class="qcard" id="${id}">
    <div class="psubtitle">Q ${quizState.q}/${quizState.total} Â· ${quizState.topic}</div>
    <div class="qprog"><div class="qbar" style="width:${(quizState.q/quizState.total)*100}%"></div></div>
    <div class="qquestion" id="${id}q">${escHtml(qLine.replace(/^Q:\s*/,''))}</div>
    <div class="qopts">${opts.map(o=>{
      const let_=o.trim()[0],txt=o.trim().slice(2).trim();
      return `<button class="qopt" id="${id}${let_}" onclick="pickAns('${id}','${let_}','${answer}')" data-l="${let_}">
        <span class="qletter">${let_}</span><span id="${id}opt${let_}">${escHtml(txt)}</span></button>`;
    }).join('')}</div>
    <div class="qexpl" id="${id}ex"></div>
    <div class="qfooter">
      <span style="font-size:11px;color:var(--txt3);font-family:var(--fM)">Score: <span id="${id}sc">${quizState.score}</span>/${quizState.q-1}</span>
      <button class="qnext" id="${id}nx" style="display:none" onclick="quizNext('${id}')">${quizState.q>=quizState.total?'See Result â†’':'Next â†’'}</button>
    </div>
  </div>`;
  addBotHTML(html);
  setTimeout(()=>{const el=document.getElementById(id);if(el)renderMath(el);},120);
}

function pickAns(id,chosen,correct){
  ['A','B','C','D'].forEach(l=>{const b=document.getElementById(id+l);if(b){b.disabled=true;
    if(l===correct)b.classList.add('correct');else if(l===chosen&&l!==correct)b.classList.add('wrong');}});
  const ok=chosen===correct;if(ok)quizState.score++;
  const ex=document.getElementById(id+'ex');
  if(ex){ex.style.display='block';ex.innerHTML=(ok?'âœ… Bilkul sahi! ':'âŒ Wrong. Answer: '+correct+'. ')+escHtml(quizState.curExpl||'');renderMath(ex);}
  const sc=document.getElementById(id+'sc');if(sc)sc.textContent=quizState.score;
  document.getElementById(id+'nx').style.display='block';
}

async function quizNext(id){document.getElementById(id+'nx').style.display='none';
  if(quizState.q>=quizState.total)showQuizResult();else await nextQuizQ();}

function showQuizResult(){
  const s=quizState.score,t=quizState.total,pct=Math.round(s/t*100);
  const msg=pct===100?'Perfect! Ekdum zabardast! ğŸ†':pct>=80?'Bahut achha! Excellent! ğŸŒŸ':pct>=60?'Achha kiya! Keep going! ğŸ’ª':'Aur practice karo! ğŸ“š';
  const stars='â­'.repeat(Math.min(s,5))+'â˜†'.repeat(5-Math.min(s,5));
  addBotHTML(`<div class="result-card">
    <div style="font-size:13px;color:var(--txt2);margin-bottom:4px">ğŸ“ Quiz Complete â€” ${quizState.topic}</div>
    <div class="result-score">${s}/${t}</div>
    <div style="font-size:24px;margin:8px 0">${stars}</div>
    <div style="font-size:14px;color:var(--txt2);margin-bottom:16px">${pct}% Â· ${msg}</div>
    <button class="qnext" onclick="startQuiz('${quizState.topic}')">Try Again</button>
    &nbsp;&nbsp;
    <button class="qnext" onclick="showQuizTopics()" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)">Change Topic</button>
  </div>`);
  quizState=null;
}

/* â•â• MOCK TEST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showMockTopics(){
  rmWelcome();document.getElementById('chat').innerHTML='';
  addBotHTML(`<div class="panel">
    <div class="ptitle">ğŸ§ª Mock Test â€” 30 Questions</div>
    <div class="psubtitle">Full-length exam simulation with immediate feedback after each question</div>
    ${['JAM','GATE','CSIR'].map(e=>`<button class="pbtn" onclick="startMock('${e}')">ğŸ“ ${e} Mock Test (30 Questions, Mixed Topics)</button>`).join('')}
  </div>`);
}

async function startMock(exam){
  document.getElementById('chat').innerHTML='';
  mockState={exam,q:0,total:30,score:0,topics:[]};
  addMsg('bot',`ğŸ§ª ${exam} Mock Test shuru! 30 Questions Â· Answer each to continue Â· Type STOP to end early.`);
  await nextMockQ();
}

function getMockTopic(exam){
  const topics={
    JAM: ['Real Analysis','Linear Algebra','Calculus','Group Theory','Complex Analysis','Probability'],
    GATE:['Calculus','Linear Algebra','Complex Analysis','PDE','ODE','Numerical Analysis'],
    CSIR:['Real Analysis','Topology','Abstract Algebra','Functional Analysis','Complex Analysis']
  };
  const list=topics[exam]||topics['JAM'];
  return list[Math.floor(Math.random()*list.length)];
}

async function nextMockQ(){
  const topic=getMockTopic(mockState.exam);mockState.curTopic=topic;
  showTyping();
  try{
    const r=await api('/api/quiz/question',{topic,difficulty:'hard',q_num:mockState.q+1,total:mockState.total});
    hideTyping();mockState.q++;mockState.curAns=r.answer;mockState.curExpl=r.explanation;
    const lines=r.question.split('\n').filter(l=>l.trim());
    const qLine=lines.find(l=>l.startsWith('Q:'))||lines[0]||'';
    const opts=lines.filter(l=>/^[A-D]\)/.test(l.trim()));
    const id='mk'+Date.now();
    const html=`<div class="qcard" id="${id}">
      <div class="psubtitle">${mockState.exam} Mock Â· Q${mockState.q}/${mockState.total} Â· ${topic} | Score: <span id="${id}sc">${mockState.score}</span></div>
      <div class="qprog"><div class="qbar" style="width:${(mockState.q/mockState.total)*100}%"></div></div>
      <div class="qquestion" id="${id}q">${escHtml(qLine.replace(/^Q:\s*/,''))}</div>
      <div class="qopts">${opts.map(o=>{const l=o.trim()[0],t=o.trim().slice(2).trim();
        return `<button class="qopt" id="${id}${l}" onclick="pickMock('${id}','${l}')" data-l="${l}">
          <span class="qletter">${l}</span><span>${escHtml(t)}</span></button>`;
      }).join('')}</div>
      <div class="qexpl" id="${id}ex"></div>
      <div class="qfooter">
        <span style="font-size:11px;color:var(--txt3);font-family:var(--fM)">Type STOP in chat to end</span>
        <button class="qnext" id="${id}nx" style="display:none" onclick="mockNext('${id}')">${mockState.q>=mockState.total?'See Result â†’':'Next â†’'}</button>
      </div>
    </div>`;
    addBotHTML(html);
    setTimeout(()=>{const el=document.getElementById(id);if(el)renderMath(el);},120);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error. '+e.message,true);}
}

function pickMock(id,chosen){
  if(!mockState)return;
  const correct=mockState.curAns;
  ['A','B','C','D'].forEach(l=>{const b=document.getElementById(id+l);if(b){b.disabled=true;
    if(l===correct)b.classList.add('correct');else if(l===chosen&&l!==correct)b.classList.add('wrong');}});
  const ok=chosen===correct;if(ok)mockState.score++;else mockState.topics.push(mockState.curTopic);
  const ex=document.getElementById(id+'ex');
  if(ex){ex.style.display='block';ex.innerHTML=(ok?'âœ… Sahi! ':'âŒ Wrong. Answer: '+correct+'. ')+escHtml(mockState.curExpl||'');renderMath(ex);}
  const sc=document.getElementById(id+'sc');if(sc)sc.textContent=mockState.score;
  document.getElementById(id+'nx').style.display='block';
}

async function mockNext(id){document.getElementById(id+'nx').style.display='none';
  if(mockState.q>=mockState.total)showMockResult();else await nextMockQ();}

function showMockResult(){
  const s=mockState.score,t=mockState.total,pct=Math.round(s/t*100);
  const grade=pct>=80?'Outstanding! ğŸ†':pct>=60?'Achha kiya! ğŸ’ª':'Aur mehnat karo! ğŸ“š';
  const weak=[...new Set(mockState.topics)].slice(0,4).join(', ')||'None â€” perfect!';
  addBotHTML(`<div class="result-card">
    <div style="font-size:13px;color:var(--txt2);margin-bottom:4px">ğŸ§ª ${mockState.exam} Mock Test Complete</div>
    <div class="result-score">${s}/${t}</div>
    <div style="font-size:20px;margin:6px 0">${pct}%</div>
    <div style="font-size:14px;color:var(--txt2);margin-bottom:10px">${grade}</div>
    ${weak!=='None â€” perfect!'?`<div style="font-size:12px;color:var(--txt2);background:var(--sur3);padding:10px;border-radius:8px;margin-bottom:12px">âš ï¸ Revise these topics: ${weak}</div>`:''}
    <button class="qnext" onclick="startMock('${mockState.exam}')">Retry Same Exam</button>
    &nbsp;&nbsp;
    <button class="qnext" onclick="showMockTopics()" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)">Change Exam</button>
  </div>`);
  mockState=null;
}

/* â•â• PYQ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showPYQTopics(){
  rmWelcome();document.getElementById('chat').innerHTML='';
  addBotHTML(`<div class="panel">
    <div class="ptitle">ğŸ“œ Previous Year Questions</div>
    <div class="psubtitle">AI-generated realistic PYQs with complete solutions</div>
    ${['JAM','GATE','CSIR'].map(e=>`<button class="pbtn" onclick="loadPYQ('${e}')">ğŸ“ ${e} PYQs</button>`).join('')}
  </div>`);
}

async function loadPYQ(exam){
  rmWelcome();showTyping();
  try{
    const d=await (await fetch('/api/pyq?exam='+exam)).json();hideTyping();
    const qid='pq'+Date.now();const aid='pa'+Date.now();
    const html=`<div class="qcard">
      <div class="psubtitle">ğŸ“œ ${exam} Â· ~${d.year} Â· ${escHtml(d.topic)}</div>
      <div class="thm-card"><div class="thm-label">QUESTION</div><div class="thm-text" id="${qid}">${escHtml(d.q)}</div></div>
      <div class="thm-card" style="border-color:rgba(45,214,122,.2)"><div class="thm-label" style="color:var(--green)">SOLUTION</div><div class="thm-text" id="${aid}">${escHtml(d.a)}</div></div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button class="qnext" onclick="loadPYQ('${exam}')">Next Question â†’</button>
        <button class="copy-btn" onclick="copyTxt(document.getElementById('${qid}').innerText+'\\n\\nSolution:\\n'+document.getElementById('${aid}').innerText)">ğŸ“‹ Copy Q+A</button>
        <button class="save-btn" onclick="saveBm('${exam} PYQ',document.getElementById('${qid}').innerText+'\\n\\nSolution:\\n'+document.getElementById('${aid}').innerText)">ğŸ”– Save</button>
      </div>
    </div>`;
    addBotHTML(html);
    setTimeout(()=>{[qid,aid].forEach(i=>{const el=document.getElementById(i);if(el)renderMath(el);});},100);
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

/* â•â• CHALLENGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadChallenge(){
  rmWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await (await fetch('/api/challenge')).json();hideTyping();
    const cid='ch'+Date.now();
    addBotHTML(`<div class="qcard">
      <div class="ptitle">ğŸ§© Aaj Ka Challenge!</div>
      <div class="thm-card"><div class="thm-text" id="${cid}">${escHtml(d.challenge)}</div></div>
      <div style="font-size:12px;color:var(--txt3);margin:4px 0">Apna solution chat mein type karo below!</div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button class="qnext" onclick="loadChallenge()">New Challenge</button>
        <button class="copy-btn" onclick="copyTxt(document.getElementById('${cid}').innerText)">ğŸ“‹ Copy</button>
        <button class="save-btn" onclick="saveBm('Daily Challenge',document.getElementById('${cid}').innerText)">ğŸ”– Save</button>
      </div>
    </div>`);
    setTimeout(()=>{const el=document.getElementById(cid);if(el)renderMath(el);},100);
    mode='chat';
  }catch(e){hideTyping();addMsg('bot','âš ï¸ Error: '+e.message,true);}
}

/* â•â• BOOKMARKS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showBookmarks(){
  rmWelcome();document.getElementById('chat').innerHTML='';
  if(!bookmarks.length){
    addBotHTML(`<div class="qcard"><div class="ptitle">ğŸ”– My Bookmarks</div>
      <div style="color:var(--txt2);font-size:13px;margin-top:8px">Abhi koi bookmark nahi hai!<br>Kisi bhi response mein ğŸ”– Save click karo to save it here.</div>
    </div>`);return;
  }
  let html=`<div class="panel"><div class="ptitle">ğŸ”– My Bookmarks (${bookmarks.length})</div>`;
  [...bookmarks].reverse().forEach((b,ri)=>{
    const i=bookmarks.length-1-ri;
    html+=`<div class="bm-item">
      <div class="bm-topic">${escHtml(b.topic)} Â· ${escHtml(b.date)}</div>
      <div class="bm-content">${escHtml(b.content.substring(0,280))}${b.content.length>280?'...':''}</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="copy-btn" onclick="copyTxt('${escQ(b.content)}')">ğŸ“‹ Copy</button>
        <button class="bm-del" onclick="delBm(${i})">ğŸ—‘ Delete</button>
      </div>
    </div>`;
  });
  html+=`<button class="qnext" onclick="clrBm()" style="background:var(--red);margin-top:6px;font-size:12px;padding:6px 14px">Clear All</button></div>`;
  addBotHTML(html);
}

function saveBm(topic,content){
  bookmarks.push({topic,content,date:new Date().toLocaleDateString()});
  if(bookmarks.length>40)bookmarks.shift();
  localStorage.setItem('ms_bm',JSON.stringify(bookmarks));
  toast('ğŸ”– Saved!','ok');
}

function delBm(i){bookmarks.splice(i,1);localStorage.setItem('ms_bm',JSON.stringify(bookmarks));showBookmarks();}
function clrBm(){if(confirm('Delete all bookmarks?')){bookmarks=[];localStorage.setItem('ms_bm','[]');showBookmarks();}}

/* â•â• COPY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function copyTxt(text){
  navigator.clipboard.writeText(text).then(()=>toast('ğŸ“‹ Copied!','ok')).catch(()=>{
    const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();
    try{document.execCommand('copy');toast('ğŸ“‹ Copied!','ok');}catch(e){toast('Copy failed','info');}
    document.body.removeChild(ta);
  });
}

function copySection(title){
  const nodes=document.querySelectorAll('.stage-card');
  let text=title+'\n\n';
  nodes.forEach(n=>text+=n.innerText+'\n\n');
  copyTxt(text||title);
}

function toast(msg,type='ok'){
  const t=document.createElement('div');
  t.className=`toast ${type}`;t.textContent=msg;document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300);},2000);
}

/* â•â• DOM HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addMsg(role,text,isErr=false){
  rmWelcome();
  const chat=document.getElementById('chat');
  const div=document.createElement('div');div.className=`msg ${role}`;
  const avHtml=role==='user'
    ?'<div class="avatar" style="font-size:16px">ğŸ‘¤</div>'
    :`<div class="avatar"><img src="/logo.png" style="width:28px;height:28px;object-fit:contain" onerror="this.parentNode.innerHTML='ğŸ§®'"/></div>`;
  div.innerHTML=avHtml+`<div class="bubble"></div>`;
  const bubble=div.querySelector('.bubble');
  bubble.innerHTML=fmt(text);

  if(role==='bot'&&!isErr){
    const cw=document.createElement('div');cw.className='copy-wrap';
    const cb=document.createElement('button');cb.className='copy-btn';cb.textContent='ğŸ“‹ Copy';
    cb.onclick=()=>copyTxt(text);
    const sb=document.createElement('button');sb.className='save-btn';sb.textContent='ğŸ”– Save';
    sb.onclick=()=>saveBm(MODE_CFG[mode]?.title||mode,text);
    cw.appendChild(cb);cw.appendChild(sb);bubble.appendChild(cw);
  }

  // make pre elements have copy buttons
  bubble.querySelectorAll('pre').forEach(pre=>{
    const cb=document.createElement('button');cb.className='pre-copy';cb.textContent='Copy';
    cb.onclick=()=>copyTxt(pre.innerText);pre.style.position='relative';pre.appendChild(cb);
  });

  chat.appendChild(div);chat.scrollTop=chat.scrollHeight;
  requestAnimationFrame(()=>{renderMath(bubble);chat.scrollTop=chat.scrollHeight;});
}

function addBotHTML(html){
  rmWelcome();
  const chat=document.getElementById('chat');
  const div=document.createElement('div');div.className='msg bot';
  div.innerHTML=`<div class="avatar"><img src="/logo.png" style="width:28px;height:28px;object-fit:contain" onerror="this.parentNode.innerHTML='ğŸ§®'"/></div><div class="bubble">${html}</div>`;
  chat.appendChild(div);chat.scrollTop=chat.scrollHeight;
  // wire copy buttons on pre
  div.querySelectorAll('pre').forEach(pre=>{
    const cb=document.createElement('button');cb.className='pre-copy';cb.textContent='Copy';
    cb.onclick=()=>copyTxt(pre.innerText);pre.style.position='relative';pre.appendChild(cb);
  });
}

function showTyping(){
  busy=true;document.getElementById('send-btn').disabled=true;
  const chat=document.getElementById('chat');
  const div=document.createElement('div');div.className='msg bot';div.id='typing-ind';
  div.innerHTML=`<div class="avatar"><img src="/logo.png" style="width:28px;height:28px;object-fit:contain" onerror="this.parentNode.innerHTML='ğŸ§®'"/></div><div class="typing"><div class="td"></div><div class="td"></div><div class="td"></div></div>`;
  chat.appendChild(div);chat.scrollTop=chat.scrollHeight;
}

function hideTyping(){
  busy=false;document.getElementById('send-btn').disabled=false;
  const t=document.getElementById('typing-ind');if(t)t.remove();
}

function setModeTitle(title){
  const mt=document.getElementById('mode-title');
  mt.style.opacity='0';setTimeout(()=>{mt.textContent=title;mt.style.opacity='1';},150);
}

/* â•â• TEXT FORMATTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(text){
  if(!text)return '';
  const latexBlocks=[];let t=text;

  // protect LaTeX
  t=t.replace(/\\\[([\s\S]*?)\\\]/g,m=>{latexBlocks.push(m);return`\x00L${latexBlocks.length-1}\x00`;});
  t=t.replace(/\\\(([\s\S]*?)\\\)/g,m=>{latexBlocks.push(m);return`\x00L${latexBlocks.length-1}\x00`;});
  t=t.replace(/\$\$([\s\S]*?)\$\$/g,m=>{latexBlocks.push(m);return`\x00L${latexBlocks.length-1}\x00`;});
  t=t.replace(/\$([^\$\n]+?)\$/g,m=>{latexBlocks.push(m);return`\x00L${latexBlocks.length-1}\x00`;});

  t=t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // restore LaTeX
  t=t.replace(/\x00L(\d+)\x00/g,(_,i)=>latexBlocks[parseInt(i)]);

  // links
  t=t.replace(/(https?:\/\/[^\s<&"]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');

  // code blocks
  t=t.replace(/```([\s\S]*?)```/g,'<pre>$1</pre>');
  t=t.replace(/`([^`\n]+)`/g,'<code>$1</code>');

  // section headers (lines starting with emoji)
  t=t.replace(/^(ğŸ“Œ|ğŸ’¡|ğŸ“–|ğŸ“|âœï¸|ğŸ“š|ğŸ“|âœ…|âš ï¸|ğŸ¯|ğŸ”¢|ğŸ”·|ğŸ“Š|ğŸ†|ğŸ§©|ğŸŒ|ğŸ”¬|ğŸ’¼|ğŸŒ|â­|ğŸ› ï¸|ğŸ”)\s+(.+)$/gm,'<span class="sec">$1 $2</span>');

  t=t.replace(/\n/g,'<br>');
  return t;
}
function initTheme(){
  const t=localStorage.getItem('ms_theme')||'dark';
  document.body.classList.toggle('light', t==='light');
  const b=document.getElementById('theme-btn');
  if(b) b.textContent = t==='light' ? 'â˜€ï¸ Light' : 'ğŸŒ™ Dark';
}

function toggleTheme(){
  const nowLight=!document.body.classList.contains('light');
  document.body.classList.toggle('light', nowLight);
  localStorage.setItem('ms_theme', nowLight?'light':'dark');
  const b=document.getElementById('theme-btn');
  if(b) b.textContent = nowLight ? 'â˜€ï¸ Light' : 'ğŸŒ™ Dark';
}
/* â•â• UTILITIES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function escHtml(s){if(!s)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escQ(s){return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;').replace(/\n/g,'\\n');}

function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function handleKey(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();
    if(mockState&&document.getElementById('input').value.trim().toUpperCase()==='STOP'){
      document.getElementById('input').value='';showMockResult();return;}
    sendMsg();
  }
}
async function quickSend(msg){
  document.getElementById('input').value=msg;await sendMsg();
}

async function api(url,data){
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||`Server error ${r.status}`);}
  return r.json();
}

/* â•â• IMAGE UPLOAD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleImg(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{const res=ev.target.result;imgB64=res.split(',')[1];imgType=file.type;
    document.getElementById('prev-img').src=res;document.getElementById('imgpreview').style.display='block';
    document.getElementById('input').placeholder='Image ke baare mein poocho...';};
  r.readAsDataURL(file);
}

function removeImg(){
  imgB64=null;imgType=null;
  document.getElementById('imgpreview').style.display='none';
  document.getElementById('filein').value='';
  document.getElementById('input').placeholder=MODE_CFG[mode]?.ph||'Type here...';
}

document.addEventListener('paste',e=>{
  const items=e.clipboardData?.items;if(!items)return;
  for(const it of items){
    if(it.type.startsWith('image/')){
      const file=it.getAsFile();const r=new FileReader();
      r.onload=ev=>{const res=ev.target.result;imgB64=res.split(',')[1];imgType=file.type;
        document.getElementById('prev-img').src=res;document.getElementById('imgpreview').style.display='block';};
      r.readAsDataURL(file);break;
    }
  }
});
</script>
</body>
</html>