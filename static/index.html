<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=1.0,user-scalable=no"/>
<title>MathSphere ‚Äî AI Mathematics Tutor by Anupam Nigam</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet"/>

<!-- KaTeX for math rendering -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"/>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>

<style>
:root{
  --bg:#07090e;--sur:#0d1018;--sur2:#12161f;--sur3:#181e2c;
  --bor:#1a2030;--bor2:#222b3d;
  --acc:#4f8ef7;--acc2:#7c5cfc;--acc3:#00d4a8;--acc4:#f7934f;
  --txt:#dde1f0;--txt2:#7d879e;--txt3:#404b60;
  --red:#e84040;--green:#2dd67a;--yellow:#f7c34f;
  --font-head:'Syne',sans-serif;
  --font-body:'DM Sans',sans-serif;
  --font-mono:'DM Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:var(--font-body);font-size:14.5px;line-height:1.65;overflow:hidden}

/* KaTeX overrides for dark theme */
.katex{color:var(--txt);font-size:1.05em}
.katex-display{margin:10px 0;overflow-x:auto;overflow-y:hidden}
.katex-display>.katex{text-align:left}

/* ‚îÄ‚îÄ ANIMATED BACKGROUND ‚îÄ‚îÄ */
body::before{content:'';position:fixed;inset:0;
  background:radial-gradient(ellipse 90% 60% at 15% 0%,rgba(79,142,247,.09) 0%,transparent 55%),
             radial-gradient(ellipse 70% 50% at 85% 100%,rgba(124,92,252,.08) 0%,transparent 55%),
             radial-gradient(ellipse 50% 35% at 60% 40%,rgba(0,212,168,.05) 0%,transparent 50%);
  pointer-events:none;z-index:0;animation:bgShift 12s ease-in-out infinite alternate}
@keyframes bgShift{
  0%{background:radial-gradient(ellipse 90% 60% at 15% 0%,rgba(79,142,247,.09) 0%,transparent 55%),radial-gradient(ellipse 70% 50% at 85% 100%,rgba(124,92,252,.08) 0%,transparent 55%),radial-gradient(ellipse 50% 35% at 60% 40%,rgba(0,212,168,.05) 0%,transparent 50%)}
  50%{background:radial-gradient(ellipse 90% 60% at 30% 10%,rgba(124,92,252,.09) 0%,transparent 55%),radial-gradient(ellipse 70% 50% at 70% 90%,rgba(79,142,247,.08) 0%,transparent 55%),radial-gradient(ellipse 50% 35% at 50% 50%,rgba(0,212,168,.05) 0%,transparent 50%)}
  100%{background:radial-gradient(ellipse 90% 60% at 10% 20%,rgba(0,212,168,.07) 0%,transparent 55%),radial-gradient(ellipse 70% 50% at 90% 80%,rgba(79,142,247,.08) 0%,transparent 55%),radial-gradient(ellipse 50% 35% at 60% 30%,rgba(124,92,252,.05) 0%,transparent 50%)}
}
body::after{content:'';position:fixed;inset:0;
  background-image:linear-gradient(rgba(255,255,255,.013) 1px,transparent 1px),
                   linear-gradient(90deg,rgba(255,255,255,.013) 1px,transparent 1px);
  background-size:44px 44px;pointer-events:none;z-index:0}

#particles{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.particle{position:absolute;font-family:var(--font-mono);font-size:13px;color:rgba(79,142,247,.12);
  animation:particleDrift linear infinite;user-select:none}
@keyframes particleDrift{
  0%{transform:translateY(100vh) rotate(0deg);opacity:0}
  10%{opacity:1}90%{opacity:.8}
  100%{transform:translateY(-10vh) rotate(360deg);opacity:0}}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app{position:relative;z-index:1;display:flex;height:100vh;max-width:1100px;margin:0 auto}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar{width:240px;flex-shrink:0;border-right:1px solid var(--bor);
  background:rgba(7,9,14,.94);backdrop-filter:blur(24px);
  display:flex;flex-direction:column;overflow:hidden;
  transition:transform .3s ease;position:relative}
#sidebar::before{content:'';position:absolute;top:0;left:0;width:1px;height:100%;
  background:linear-gradient(180deg,transparent,var(--acc),var(--acc2),transparent);
  opacity:.4;animation:sidebarShimmer 4s ease-in-out infinite}
@keyframes sidebarShimmer{0%,100%{opacity:.15}50%{opacity:.55}}

.sidebar-logo{padding:18px 16px 12px;border-bottom:1px solid var(--bor);display:flex;align-items:center;gap:10px}
.sidebar-logo .icon{width:36px;height:36px;background:linear-gradient(135deg,var(--acc),var(--acc2));
  border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;
  box-shadow:0 0 18px rgba(79,142,247,.3);animation:iconPulse 3s ease-in-out infinite;overflow:hidden}
@keyframes iconPulse{
  0%,100%{box-shadow:0 0 18px rgba(79,142,247,.3),0 0 0 0 rgba(79,142,247,.15)}
  50%{box-shadow:0 0 28px rgba(79,142,247,.5),0 0 0 6px rgba(79,142,247,0)}}
.sidebar-logo .name{font-family:var(--font-head);font-weight:800;font-size:15px;letter-spacing:-.2px;
  background:linear-gradient(90deg,#dde1f0,#7d879e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.sidebar-logo .by{font-size:9px;color:var(--txt3);font-family:var(--font-mono);letter-spacing:1px;text-transform:uppercase;margin-top:1px}
.sidebar-section{padding:10px 10px 4px;font-size:9px;color:var(--txt3);font-family:var(--font-mono);letter-spacing:1.5px;text-transform:uppercase}
.nav-btn{display:flex;align-items:center;gap:9px;width:100%;padding:8px 12px;border:none;background:none;
  color:var(--txt2);cursor:pointer;border-radius:8px;font-family:var(--font-body);font-size:13px;
  transition:all .22s cubic-bezier(.4,0,.2,1);text-align:left;position:relative;overflow:hidden}
.nav-btn::after{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;
  background:linear-gradient(180deg,var(--acc),var(--acc2));border-radius:0 2px 2px 0;
  transform:scaleY(0);transition:transform .22s cubic-bezier(.4,0,.2,1)}
.nav-btn:hover{background:var(--sur2);color:var(--txt);transform:translateX(3px)}
.nav-btn.active{background:rgba(79,142,247,.12);color:var(--acc);border:1px solid rgba(79,142,247,.2)}
.nav-btn.active::after{transform:scaleY(1)}
.nav-btn .emoji{width:20px;text-align:center;font-size:14px;transition:transform .22s}
.nav-btn:hover .emoji{transform:scale(1.2) rotate(-5deg)}
.sidebar-scroll{flex:1;overflow-y:auto;padding:6px 8px;scrollbar-width:none}
.sidebar-scroll::-webkit-scrollbar{display:none}
.sidebar-footer{padding:12px;border-top:1px solid var(--bor)}
.social-links{display:flex;gap:8px;flex-wrap:wrap}
.social-link{font-size:10px;color:var(--txt3);font-family:var(--font-mono);text-decoration:none;
  padding:3px 7px;border:1px solid var(--bor);border-radius:4px;transition:all .2s;position:relative;overflow:hidden}
.social-link::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--acc),var(--acc2));opacity:0;transition:opacity .2s}
.social-link:hover{color:white;border-color:var(--acc)}
.social-link:hover::before{opacity:.15}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#topbar{display:flex;align-items:center;gap:10px;padding:12px 20px;
  border-bottom:1px solid var(--bor);background:rgba(7,9,14,.88);backdrop-filter:blur(20px);flex-shrink:0;
  animation:slideDown .5s cubic-bezier(.4,0,.2,1) both}
@keyframes slideDown{from{transform:translateY(-100%);opacity:0}to{transform:translateY(0);opacity:1}}
#menu-toggle{display:none;background:none;border:1px solid var(--bor);color:var(--txt2);
  width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:15px;align-items:center;justify-content:center}
#mode-title{font-family:var(--font-head);font-weight:700;font-size:16px;flex:1;transition:all .3s cubic-bezier(.4,0,.2,1)}
.status{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--txt3);font-family:var(--font-mono)}
.dot{width:6px;height:6px;border-radius:50%;background:var(--acc3);box-shadow:0 0 6px var(--acc3);animation:dotPulse 2s ease-in-out infinite}
@keyframes dotPulse{
  0%,100%{box-shadow:0 0 4px var(--acc3),0 0 0 0 rgba(0,212,168,.4)}
  50%{box-shadow:0 0 10px var(--acc3),0 0 0 5px rgba(0,212,168,0)}}
#clear-btn{background:none;border:1px solid var(--bor);color:var(--txt3);padding:5px 10px;
  border-radius:6px;font-size:10px;font-family:var(--font-mono);cursor:pointer;transition:all .2s;letter-spacing:.5px}
#clear-btn:hover{border-color:var(--red);color:var(--red);background:rgba(232,64,64,.06);transform:scale(.97)}

/* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
#chat{flex:1;overflow-y:auto;padding:20px 20px 10px;display:flex;flex-direction:column;gap:16px;
  scrollbar-width:thin;scrollbar-color:var(--bor2) transparent}
#chat::-webkit-scrollbar{width:3px}
#chat::-webkit-scrollbar-thumb{background:var(--bor2);border-radius:3px}

/* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
#welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;padding:40px 20px;text-align:center;animation:welcomeIn .7s cubic-bezier(.4,0,.2,1) both}
@keyframes welcomeIn{from{opacity:0;transform:translateY(24px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
#welcome .icon-wrap{position:relative;margin-bottom:24px}
#welcome .big-icon{width:80px;height:80px;background:linear-gradient(135deg,var(--acc),var(--acc2));
  border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;
  box-shadow:0 0 40px rgba(79,142,247,.3),0 0 80px rgba(124,92,252,.12);
  animation:float 4s ease-in-out infinite;position:relative;z-index:1;overflow:hidden}
@keyframes float{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-9px) rotate(2deg)}}
#welcome .orbit-ring{position:absolute;top:50%;left:50%;width:110px;height:110px;
  margin:-55px 0 0 -55px;border-radius:50%;border:1px solid rgba(79,142,247,.2);animation:orbitSpin 8s linear infinite}
@keyframes orbitSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
#welcome .orbit-dot{position:absolute;top:-3px;left:50%;width:6px;height:6px;margin-left:-3px;border-radius:50%;background:var(--acc);box-shadow:0 0 8px var(--acc)}
#welcome .orbit-ring2{position:absolute;top:50%;left:50%;width:140px;height:140px;
  margin:-70px 0 0 -70px;border-radius:50%;border:1px solid rgba(124,92,252,.15);animation:orbitSpin 14s linear infinite reverse}
#welcome .orbit-dot2{position:absolute;top:-3px;left:50%;width:5px;height:5px;margin-left:-2.5px;border-radius:50%;background:var(--acc2);box-shadow:0 0 7px var(--acc2)}
#welcome h1{font-family:var(--font-head);font-size:30px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,#dde1f0 30%,var(--acc) 70%,var(--acc2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
#welcome p{color:var(--txt2);max-width:420px;font-size:13.5px;line-height:1.7;margin-bottom:28px}
.feat-grid{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:480px}
.feat{background:var(--sur2);border:1px solid var(--bor);border-radius:7px;padding:6px 12px;
  font-size:11px;color:var(--txt2);font-family:var(--font-mono);
  transition:all .25s cubic-bezier(.4,0,.2,1);cursor:default;animation:featIn .5s cubic-bezier(.4,0,.2,1) both}
.feat:hover{background:var(--sur3);border-color:var(--acc);color:var(--acc);transform:translateY(-2px);box-shadow:0 4px 14px rgba(79,142,247,.12)}
@keyframes featIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.feat:nth-child(1){animation-delay:.05s}.feat:nth-child(2){animation-delay:.1s}
.feat:nth-child(3){animation-delay:.15s}.feat:nth-child(4){animation-delay:.2s}
.feat:nth-child(5){animation-delay:.25s}.feat:nth-child(6){animation-delay:.3s}
.feat:nth-child(7){animation-delay:.35s}.feat:nth-child(8){animation-delay:.4s}

/* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
.msg{display:flex;gap:10px;animation:msgIn .3s cubic-bezier(.4,0,.2,1) both}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg.user{flex-direction:row-reverse}
.avatar{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;
  font-size:13px;flex-shrink:0;margin-top:2px;transition:transform .2s;overflow:hidden}
.msg:hover .avatar{transform:scale(1.1)}
.msg.user .avatar{background:linear-gradient(135deg,#1a2540,#1e2f52);border:1px solid #253552}
.msg.bot .avatar{background:linear-gradient(135deg,var(--acc),var(--acc2));
  box-shadow:0 0 12px rgba(79,142,247,.3);animation:avatarGlow 3s ease-in-out infinite}
@keyframes avatarGlow{0%,100%{box-shadow:0 0 10px rgba(79,142,247,.25)}50%{box-shadow:0 0 18px rgba(79,142,247,.5)}}
.bubble{max-width:78%;padding:12px 15px;border-radius:13px;font-size:13.5px;line-height:1.8;position:relative;transition:box-shadow .2s}
.msg.user .bubble{background:#131d35;border:1px solid #1e2d4a;border-top-right-radius:3px;color:var(--txt)}
.msg.bot .bubble{background:var(--sur);border:1px solid var(--bor);border-top-left-radius:3px;color:var(--txt)}
.msg.bot .bubble:hover{box-shadow:0 4px 20px rgba(79,142,247,.08)}
.msg.bot .bubble::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,var(--acc),var(--acc2),var(--acc3),transparent);
  border-radius:13px 13px 0 0;opacity:.5;background-size:200% 100%;animation:bubbleBarShimmer 4s linear infinite}
@keyframes bubbleBarShimmer{0%{background-position:0% 0%}100%{background-position:200% 0%}}

/* Rich formatting */
.bubble pre{background:var(--sur3);border:1px solid var(--bor2);border-radius:7px;padding:11px;
  margin:10px 0;overflow-x:auto;font-family:var(--font-mono);font-size:12px;line-height:1.55;color:#9dd0ff}
.bubble code{font-family:var(--font-mono);font-size:11.5px;background:var(--sur3);padding:2px 5px;border-radius:4px;color:var(--acc3)}
.bubble .sec{font-family:var(--font-head);font-weight:600;font-size:12.5px;color:var(--acc);letter-spacing:.4px;margin:11px 0 4px;display:block}
.bubble hr{border:none;border-top:1px solid var(--bor);margin:9px 0}
.bubble a{color:var(--acc);text-decoration:none;border-bottom:1px solid rgba(79,142,247,.3);transition:all .2s}
.bubble a:hover{border-color:var(--acc)}

/* ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ */
.typing{display:flex;gap:4px;padding:12px 14px;background:var(--sur);border:1px solid var(--bor);
  border-radius:13px;border-top-left-radius:3px;width:fit-content}
.tdot{width:5px;height:5px;border-radius:50%;background:var(--acc);animation:tdot 1.2s ease-in-out infinite}
.tdot:nth-child(2){animation-delay:.2s;background:var(--acc2)}
.tdot:nth-child(3){animation-delay:.4s;background:var(--acc3)}
@keyframes tdot{0%,60%,100%{transform:translateY(0) scale(.8);opacity:.4}30%{transform:translateY(-7px) scale(1);opacity:1}}

/* ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ */
.quiz-card{background:var(--sur2);border:1px solid var(--bor2);border-radius:13px;padding:18px;
  display:flex;flex-direction:column;gap:12px;animation:cardIn .4s cubic-bezier(.4,0,.2,1) both}
@keyframes cardIn{from{opacity:0;transform:translateY(12px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
.quiz-q{font-size:14px;line-height:1.8;color:var(--txt)}
.quiz-opts{display:flex;flex-direction:column;gap:7px}
.quiz-opt{background:var(--sur3);border:1px solid var(--bor2);border-radius:8px;padding:9px 14px;
  cursor:pointer;font-size:13px;color:var(--txt2);transition:all .22s cubic-bezier(.4,0,.2,1);
  text-align:left;display:flex;gap:10px;align-items:center;position:relative;overflow:hidden;line-height:1.7}
.quiz-opt::before{content:'';position:absolute;left:-100%;top:0;bottom:0;width:100%;
  background:linear-gradient(90deg,transparent,rgba(79,142,247,.06),transparent);transition:left .4s}
.quiz-opt:hover:not(:disabled){background:var(--sur2);border-color:var(--acc);color:var(--txt);transform:translateX(4px)}
.quiz-opt:hover:not(:disabled)::before{left:100%}
.quiz-opt.correct{background:rgba(45,214,122,.08);border-color:var(--green);color:var(--green);animation:correctFlash .4s ease}
.quiz-opt.wrong{background:rgba(232,64,64,.08);border-color:var(--red);color:var(--red);animation:wrongShake .3s ease}
@keyframes correctFlash{0%,100%{transform:translateX(0)}25%{transform:translateX(4px) scale(1.01)}50%{transform:translateX(-2px)}}
@keyframes wrongShake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-4px)}40%,80%{transform:translateX(4px)}}
.quiz-opt:disabled{cursor:default}
.quiz-letter{font-family:var(--font-mono);font-size:11px;font-weight:600;width:22px;height:22px;
  border-radius:5px;background:var(--bor2);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .2s}
.quiz-footer{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--txt2)}
.quiz-score{font-family:var(--font-mono);font-size:11px;color:var(--acc)}
.quiz-expl{background:rgba(79,142,247,.06);border:1px solid rgba(79,142,247,.15);border-radius:8px;
  padding:10px 13px;font-size:12.5px;color:var(--txt2);display:none;line-height:1.7}
.quiz-next{background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:8px;
  color:white;padding:8px 18px;font-size:12.5px;cursor:pointer;font-family:var(--font-body);
  box-shadow:0 0 14px rgba(79,142,247,.25);transition:all .22s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
.quiz-next:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 6px 22px rgba(79,142,247,.4)}
.quiz-next:active{transform:translateY(0) scale(.98)}

/* ‚îÄ‚îÄ MOCK ‚îÄ‚îÄ */
.mock-info{font-size:11px;color:var(--txt3);font-family:var(--font-mono)}
.mock-progress{height:3px;background:var(--bor);border-radius:2px;overflow:hidden;margin:4px 0}
.mock-bar{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));transition:width .6s cubic-bezier(.4,0,.2,1)}

/* ‚îÄ‚îÄ RESULT ‚îÄ‚îÄ */
.result-card{background:var(--sur2);border:1px solid var(--bor2);border-radius:13px;padding:22px;text-align:center;animation:resultIn .5s cubic-bezier(.4,0,.2,1) both}
@keyframes resultIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
.result-score{font-family:var(--font-head);font-size:48px;font-weight:800;
  background:linear-gradient(135deg,var(--acc),var(--acc2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  animation:scorePop .5s cubic-bezier(.4,0,.2,1) .15s both}
@keyframes scorePop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.result-stars{font-size:22px;margin:8px 0;animation:starsIn .4s .3s both}
@keyframes starsIn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
.result-label{font-size:14px;color:var(--txt2);margin-bottom:14px}
.result-restart{background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:8px;
  color:white;padding:9px 22px;font-size:13px;cursor:pointer;font-family:var(--font-body);
  transition:all .22s;box-shadow:0 0 14px rgba(79,142,247,.25)}
.result-restart:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(79,142,247,.4)}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel{display:flex;flex-direction:column;gap:10px;padding:4px 0}
.panel-title{font-family:var(--font-head);font-weight:700;font-size:14px;color:var(--txt);margin-bottom:4px}
.panel-btn{background:var(--sur2);border:1px solid var(--bor);color:var(--txt2);border-radius:8px;
  padding:9px 13px;cursor:pointer;font-size:12.5px;font-family:var(--font-body);
  transition:all .22s cubic-bezier(.4,0,.2,1);text-align:left;position:relative;overflow:hidden}
.panel-btn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;
  background:linear-gradient(180deg,var(--acc),var(--acc2));transform:scaleY(0);transition:transform .22s;border-radius:0 2px 2px 0}
.panel-btn:hover{background:var(--sur3);border-color:var(--acc);color:var(--txt);padding-left:18px}
.panel-btn:hover::before{transform:scaleY(1)}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
#inputarea{padding:12px 20px 16px;border-top:1px solid var(--bor);background:rgba(7,9,14,.92);backdrop-filter:blur(20px);flex-shrink:0;animation:slideUp .5s cubic-bezier(.4,0,.2,1) .1s both;position:relative;z-index:999;will-change:transform;transform:translateZ(0)}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
#img-preview{display:none;position:relative;margin-bottom:8px}
#img-preview img{width:72px;height:54px;object-fit:cover;border-radius:7px;border:1px solid var(--bor2)}
#img-preview button{position:absolute;top:-4px;right:-4px;width:15px;height:15px;
  background:var(--red);border-radius:50%;border:none;color:white;font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.input-wrap{display:flex;gap:8px;align-items:flex-end;background:var(--sur2);
  border:1px solid var(--bor2);border-radius:12px;padding:9px 9px 9px 15px;
  transition:border-color .25s,box-shadow .25s,transform .15s}
.input-wrap:focus-within{border-color:var(--acc);box-shadow:0 0 0 3px rgba(79,142,247,.09),0 0 22px rgba(79,142,247,.09)}#input{flex:1;background:none;border:none;outline:none;color:var(--txt);
  font-family:var(--font-body);font-size:13.5px;line-height:1.6;resize:none;max-height:120px;min-height:22px}
#input::placeholder{color:var(--txt3)}
.inp-btns{display:flex;gap:6px;align-items:center;flex-shrink:0}
.inp-icon{width:32px;height:32px;background:var(--sur3);border:1px solid var(--bor);border-radius:7px;
  color:var(--txt3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .22s cubic-bezier(.4,0,.2,1)}
.inp-icon:hover{background:var(--sur2);border-color:var(--bor2);color:var(--txt2);transform:scale(1.08) rotate(-5deg)}
#send-btn{width:32px;height:32px;background:linear-gradient(135deg,var(--acc),var(--acc2));
  border:none;border-radius:7px;color:white;cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:15px;box-shadow:0 0 14px rgba(79,142,247,.28);
  transition:all .22s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
#send-btn:hover{transform:scale(1.1) rotate(5deg);box-shadow:0 0 22px rgba(79,142,247,.5)}
#send-btn:active{transform:scale(.93) rotate(0deg)}
#send-btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
.inp-hint{text-align:center;margin-top:7px;font-size:9.5px;color:var(--txt3);font-family:var(--font-mono);letter-spacing:.5px}

/* ‚îÄ‚îÄ TAGS BAR ‚îÄ‚îÄ */
#tagsbar{display:flex;gap:7px;padding:9px 20px;border-bottom:1px solid var(--bor);
  background:rgba(7,9,14,.72);overflow-x:auto;flex-shrink:0;scrollbar-width:none;
  animation:slideDown .5s cubic-bezier(.4,0,.2,1) .05s both}
#tagsbar::-webkit-scrollbar{display:none}
.tag{background:var(--sur2);border:1px solid var(--bor);color:var(--txt2);padding:4px 11px;
  border-radius:18px;font-size:10.5px;font-family:var(--font-mono);cursor:pointer;white-space:nowrap;transition:all .22s cubic-bezier(.4,0,.2,1)}
.tag:hover{background:var(--sur3);border-color:var(--acc);color:var(--acc);box-shadow:0 0 12px rgba(79,142,247,.15);transform:translateY(-2px) scale(1.04)}
.tag:active{transform:translateY(0) scale(.97)}

/* ‚îÄ‚îÄ BOOKMARKS ‚îÄ‚îÄ */
.bm-item{background:var(--sur2);border:1px solid var(--bor);border-radius:9px;padding:12px;margin:5px 0;transition:border-color .2s}
.bm-item:hover{border-color:var(--bor2)}
.bm-topic{font-size:10px;color:var(--acc);font-family:var(--font-mono);margin-bottom:4px}
.bm-content{font-size:12px;color:var(--txt2);line-height:1.6}
.bm-delete{background:none;border:none;color:var(--txt3);cursor:pointer;font-size:11px;margin-top:6px;transition:color .2s}
.bm-delete:hover{color:var(--red)}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.notif-toast{position:fixed;top:16px;right:16px;background:var(--sur3);border:1px solid var(--bor2);
  color:var(--txt);padding:10px 16px;border-radius:8px;font-size:12px;z-index:9999;
  font-family:var(--font-mono);animation:toastIn .3s cubic-bezier(.4,0,.2,1)}
@keyframes toastIn{from{transform:translateX(110%) scale(.9);opacity:0}to{transform:translateX(0) scale(1);opacity:1}}

#mode-flash{position:fixed;inset:0;background:rgba(79,142,247,.04);pointer-events:none;z-index:50;opacity:0;transition:opacity .2s}
#mode-flash.active{opacity:1}

@media(max-width:700px){
  #sidebar{position:fixed;top:0;left:0;bottom:0;z-index:100;transform:translateX(-100%)}
  #sidebar.open{transform:translateX(0)}
  #menu-toggle{display:flex}
  .bubble{max-width:90%}
  #welcome h1{font-size:22px}
}
</style>
</head>
<body>
<div id="particles"></div>
<div id="mode-flash"></div>

<div id="app">
<nav id="sidebar">
  <div class="sidebar-logo">
    <div class="icon">
      <img src="/static/logo.png" style="width:34px;height:34px;object-fit:contain;" onerror="this.style.display='none';this.parentNode.textContent='üßÆ'"/>
    </div>
    <div>
      <div class="name">MathSphere</div>
      <div class="by">By Anupam Nigam</div>
    </div>
  </div>
  <div class="sidebar-scroll">
    <div class="sidebar-section">Learn</div>
    <button class="nav-btn active" onclick="setMode('chat')" id="nav-chat"><span class="emoji">üí¨</span>Ask Anything</button>
    <button class="nav-btn" onclick="setMode('calculator')" id="nav-calculator"><span class="emoji">üßÆ</span>Step Calculator</button>
    <button class="nav-btn" onclick="setMode('formula')" id="nav-formula"><span class="emoji">üìã</span>Formula Sheet</button>
    <button class="nav-btn" onclick="setMode('revision')" id="nav-revision"><span class="emoji">‚ö°</span>Rapid Revision</button>
    <button class="nav-btn" onclick="setMode('conceptmap')" id="nav-conceptmap"><span class="emoji">üó∫Ô∏è</span>Concept Map</button>
    <button class="nav-btn" onclick="setMode('compare')" id="nav-compare"><span class="emoji">‚öñÔ∏è</span>Compare Concepts</button>
    <button class="nav-btn" onclick="setMode('verify')" id="nav-verify"><span class="emoji">üîç</span>Verify My Claim</button>
    <button class="nav-btn" onclick="setMode('latex')" id="nav-latex"><span class="emoji">üßæ</span>LaTeX Generator</button>
    <button class="nav-btn" onclick="setMode('projects')" id="nav-projects"><span class="emoji">üöÄ</span>Math Projects</button>
    <div class="sidebar-section">Practice</div>
    <button class="nav-btn" onclick="setMode('quiz')" id="nav-quiz"><span class="emoji">üèÜ</span>Quiz Mode</button>
    <button class="nav-btn" onclick="setMode('mocktest')" id="nav-mocktest"><span class="emoji">üìù</span>Mock Test</button>
    <button class="nav-btn" onclick="setMode('challenge')" id="nav-challenge"><span class="emoji">üß©</span>Daily Challenge</button>
    <button class="nav-btn" onclick="setMode('proof')" id="nav-proof"><span class="emoji">‚úçÔ∏è</span>Proof Builder</button>
    <button class="nav-btn" onclick="setMode('debate')" id="nav-debate"><span class="emoji">üó£Ô∏è</span>Math Debate</button>
    <button class="nav-btn" onclick="setMode('pyq')" id="nav-pyq"><span class="emoji">üìú</span>PYQ Bank</button>
    <div class="sidebar-section">Exams</div>
    <button class="nav-btn" onclick="showExam('JAM')"><span class="emoji">üéì</span>IIT JAM</button>
    <button class="nav-btn" onclick="showExam('GATE')"><span class="emoji">üî¨</span>GATE Maths</button>
    <button class="nav-btn" onclick="showExam('CSIR')"><span class="emoji">üìö</span>CSIR NET</button>
    <div class="sidebar-section">Explore</div>
    <button class="nav-btn" onclick="setMode('mathematician')" id="nav-mathematician"><span class="emoji">üß†</span>Mathematician</button>
    <button class="nav-btn" onclick="setMode('realworld')" id="nav-realworld"><span class="emoji">üåç</span>Real World Maths</button>
    <button class="nav-btn" onclick="setMode('debate')" id="nav-paradox"><span class="emoji">üåÄ</span>Paradoxes</button>
    <button class="nav-btn" onclick="setMode('research')" id="nav-research"><span class="emoji">üî¨</span>Research Hub</button>
    <button class="nav-btn" onclick="setMode('bookmarks')" id="nav-bookmarks"><span class="emoji">üîñ</span>My Bookmarks</button>
  </div>
  <div class="sidebar-footer">
    <div class="social-links">
      <a class="social-link" href="https://youtube.com/@pi_nomenal1729" target="_blank">YouTube</a>
      <a class="social-link" href="https://instagram.com/pi_nomenal1729" target="_blank">Instagram</a>
      <a class="social-link" href="https://www.anupamnigam.com" target="_blank">Website</a>
    </div>
  </div>
</nav>

<div id="main">
  <div id="topbar">
    <button id="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div id="mode-title">üí¨ Ask Anything</div>
    <div class="status"><div class="dot"></div><span style="font-size:10px">ONLINE</span></div>
    <button id="clear-btn" onclick="clearChat()">CLEAR</button>
  </div>
  <div id="tagsbar"></div>
  <div id="chat"></div>
  <div id="inputarea">
    <div id="img-preview">
      <img id="prev-img" src="" alt=""/>
      <button onclick="removeImg()">‚úï</button>
    </div>
    <div class="input-wrap">
      <textarea id="input" rows="1" placeholder="Ask any math question..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <div class="inp-btns">
        <input type="file" id="file-in" accept="image/*" style="display:none" onchange="handleImg(event)"/>
        <button class="inp-icon" onclick="document.getElementById('file-in').click()" title="Upload problem image">üì∏</button>
        <button id="send-btn" onclick="sendMsg()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
    <div class="inp-hint">MATHSPHERE ¬∑ BY ANUPAM NIGAM ¬∑ youtube.com/@pi_nomenal1729</div>
  </div>
</div>
</div>

<script>
// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ
(function(){
  const syms=['‚à´','‚àë','œÄ','‚àû','‚àö','‚àÇ','‚àá','Œª','Œî','Œ∏','Œ±','Œ≤','Œ≥','Œµ','‚â†','‚âà','¬±','‚äï','‚à©','‚à™'];
  const c=document.getElementById('particles');
  for(let i=0;i<18;i++){
    const p=document.createElement('div');p.className='particle';
    p.textContent=syms[Math.floor(Math.random()*syms.length)];
    p.style.left=Math.random()*100+'%';
    p.style.animationDuration=(18+Math.random()*24)+'s';
    p.style.animationDelay=(-Math.random()*20)+'s';
    p.style.fontSize=(10+Math.random()*10)+'px';
    p.style.opacity=(.05+Math.random()*.1).toString();
    c.appendChild(p);
  }
})();

// ‚îÄ‚îÄ KATEX RENDER ‚îÄ‚îÄ
function renderMath(el){
  if(typeof renderMathInElement !== 'undefined'){
    renderMathInElement(el,{
      delimiters:[
        {left:'\\[',right:'\\]',display:true},
        {left:'\\(',right:'\\)',display:false},
        {left:'$$',right:'$$',display:true},
        {left:'$',right:'$',display:false}
      ],
      throwOnError:false,
      errorColor:'#e84040',
      strict:false
    });
  }
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let mode='chat',chatHistory=[],imgB64=null,imgType=null,busy=false;
let quizState=null,mockState=null,proofHistory=[],debateHistory=[];
let bookmarks=JSON.parse(localStorage.getItem('ms_bookmarks')||'[]');

const PROMPTS={
  chat:{title:'üí¨ Ask Anything',ph:'Ask any math question...'},
  calculator:{title:'üßÆ Step Calculator',ph:'Type a math problem to solve step by step...'},
  formula:{title:'üìã Formula Sheet',ph:'Type a topic (e.g. Calculus, Linear Algebra)...'},
  revision:{title:'‚ö° Rapid Revision',ph:'Type a topic for TOP 10 revision points...'},
  conceptmap:{title:'üó∫Ô∏è Concept Map',ph:'Type a topic to see how it connects...'},
  compare:{title:'‚öñÔ∏è Compare Concepts',ph:'e.g. Continuity vs Uniform Continuity'},
  verify:{title:'üîç Verify My Claim',ph:'Type a mathematical claim to verify...'},
  latex:{title:'üßæ LaTeX Generator',ph:'Describe what you need LaTeX code for...'},
  projects:{title:'üöÄ Math Projects',ph:'Type a domain (e.g. Machine Learning, Cryptography)...'},
  proof:{title:'‚úçÔ∏è Proof Builder',ph:'Type the theorem you want to prove...'},
  debate:{title:'üó£Ô∏è Math Debate',ph:'Type your argument about the paradox...'},
  research:{title:'üî¨ Research Hub',ph:'Ask about research papers, proofs, topics...'},
  bookmarks:{title:'üîñ My Bookmarks',ph:''},
};

window.onload=()=>{showWelcome();renderTagsForMode();};

function showWelcome(){
  document.getElementById('chat').innerHTML=`
    <div id="welcome">
      <div class="icon-wrap">
        <div class="orbit-ring"><div class="orbit-dot"></div></div>
        <div class="orbit-ring2"><div class="orbit-dot2"></div></div>
        <div class="big-icon">
          <img src="/static/logo.png" style="width:60px;height:60px;object-fit:contain;" onerror="this.style.display='none';this.parentNode.textContent='üßÆ'"/>
        </div>
      </div>
      <h1>MathSphere</h1>
      <p>Your AI-powered mathematics companion ‚Äî step-by-step solutions, exam prep, proofs, quizzes and more. Built by Anupam Nigam.</p>
      <div class="feat-grid">
        <div class="feat">‚ö° Groq AI</div><div class="feat">üìê Step-by-step</div>
        <div class="feat">üéì JAM ¬∑ GATE ¬∑ CSIR</div><div class="feat">üì∏ Image solving</div>
        <div class="feat">üèÜ Quiz + Mock Test</div><div class="feat">üåç Hinglish</div>
        <div class="feat">üìã Formula Sheets</div><div class="feat">‚úçÔ∏è Proof Builder</div>
      </div>
    </div>`;
}

function flashMode(){
  const f=document.getElementById('mode-flash');
  f.classList.add('active');setTimeout(()=>f.classList.remove('active'),200);
}

function setMode(m){
  mode=m;flashMode();
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const nb=document.getElementById(`nav-${m}`);if(nb)nb.classList.add('active');
  const cfg=PROMPTS[m]||PROMPTS.chat;
  const te=document.getElementById('mode-title');
  te.style.opacity='0';te.style.transform='translateY(-6px)';
  setTimeout(()=>{te.textContent=cfg.title;te.style.opacity='1';te.style.transform='translateY(0)';},150);
  document.getElementById('input').placeholder=cfg.ph||'Type here...';
  document.getElementById('sidebar').classList.remove('open');
  renderTagsForMode();
  if(m==='quiz'){showQuizTopics();return;}
  if(m==='mocktest'){showMockTopics();return;}
  if(m==='challenge'){fetchChallenge();return;}
  if(m==='pyq'){showPYQTopics();return;}
  if(m==='mathematician'){fetchMathematician();return;}
  if(m==='realworld'){fetchRealWorld();return;}
  if(m==='bookmarks'){showBookmarks();return;}
  if(m==='debate'){showParadoxPicker();return;}
  clearChat();
}

function renderTagsForMode(){
  const bar=document.getElementById('tagsbar');
  if(mode==='quiz'){
    bar.innerHTML=['Calculus','Linear Algebra','Real Analysis','Algebra','Probability','Number Theory','Complex Analysis','Statistics']
      .map(t=>`<div class="tag" onclick="startQuiz('${t}')">${t}</div>`).join('');
  }else if(mode==='mocktest'){
    bar.innerHTML=['JAM','GATE','CSIR'].map(e=>`<div class="tag" onclick="startMock('${e}')">${e} Mock</div>`).join('');
  }else if(mode==='pyq'){
    bar.innerHTML=['JAM','GATE','CSIR'].map(e=>`<div class="tag" onclick="fetchPYQ('${e}')">${e} PYQs</div>`).join('');
  }else{
    bar.innerHTML=[
      ['‚à´ Integration','Explain integration by parts with a full example'],
      ['Œª Eigenvalues','Explain eigenvalues and eigenvectors with example'],
      ['Œµ-Œ¥ Analysis','Explain epsilon-delta definition of limit'],
      ['‚äï Algebra','Explain groups, rings and fields in abstract algebra'],
      ['‚àë Fourier','Explain Fourier series with a worked example'],
      ['üéØ Probability','Explain Bayes theorem with a real example'],
      ['üåÄ Topology','Explain open sets and metric spaces'],
    ].map(([l,q])=>`<div class="tag" onclick="quickSend('${q}')">${l}</div>`).join('');
  }
}

function clearChat(){chatHistory=[];proofHistory=[];debateHistory=[];showWelcome();}

function removeWelcome(){
  const w=document.getElementById('welcome');
  if(w)w.remove();
}

async function sendMsg(){
  const inp=document.getElementById('input');
  const text=inp.value.trim();
  if((!text&&!imgB64)||busy)return;
  removeWelcome();
  addMsg('user',text||'üì∏ [Image sent]');
  inp.value='';inp.style.height='auto';
  const curImg=imgB64,curType=imgType;removeImg();
  chatHistory.push({role:'user',content:text||'Solve this image problem.'});
  showTyping();
  try{
    let answer;
    if(mode==='calculator'){const r=await post('/api/calculator',{problem:text});answer=r.answer;}
    else if(mode==='formula'){const r=await post('/api/formula',{topic:text});answer=r.answer;}
    else if(mode==='revision'){const r=await post('/api/revision',{topic:text});answer=r.answer;}
    else if(mode==='conceptmap'){const r=await post('/api/conceptmap',{topic:text});answer=r.answer;}
    else if(mode==='compare'){const r=await post('/api/compare',{concepts:text});answer=r.answer;}
    else if(mode==='verify'){const r=await post('/api/verify',{claim:text});answer=r.answer;}
    else if(mode==='latex'){const r=await post('/api/latex',{text:text});answer=r.answer;}
    else if(mode==='projects'){const r=await post('/api/projects',{domain:text});answer=r.answer;}
    else if(mode==='proof'){
      proofHistory.push({role:'user',content:text});
      const r=await post('/api/proof',{theorem:text,history:proofHistory.slice(-10)});
      answer=r.answer;proofHistory.push({role:'assistant',content:answer});
    }else if(mode==='debate'){
      debateHistory.push({role:'user',content:text});
      const r=await post('/api/debate',{argument:text,history:debateHistory.slice(-10)});
      answer=r.answer;debateHistory.push({role:'assistant',content:answer});
    }else if(mode==='research'){const r=await post('/api/research',{question:text});answer=r.answer;}
    else{
      const payload={messages:chatHistory.slice(-16),mode:'normal'};
      if(curImg){payload.image_b64=curImg;payload.image_type=curType;}
      const r=await post('/api/chat',payload);answer=r.answer;
    }
    hideTyping();
    chatHistory.push({role:'assistant',content:answer});
    addMsg('bot',answer);
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error: '+e.message,true);}
}

// ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ
function showQuizTopics(){
  removeWelcome();document.getElementById('chat').innerHTML='';
  const topics=['Calculus','Linear Algebra','Real Analysis','Algebra','Probability','Number Theory','Complex Analysis','Statistics','Differential Equations','Topology'];
  addBotHTML(`<div class="panel">
    <div class="panel-title">üèÜ Quiz Mode ‚Äî Select a Topic</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      ${topics.map(t=>`<button class="panel-btn" onclick="startQuiz('${t}')">${t}</button>`).join('')}
    </div>
  </div>`);
}

async function startQuiz(topic){
  document.getElementById('chat').innerHTML='';
  quizState={topic,q:0,total:5,score:0,difficulty:'medium'};
  addMsg('bot',`üèÜ Starting ${topic} Quiz ‚Äî 5 questions!\nSelect A, B, C or D for each question.`);
  await nextQuizQuestion();
}

async function nextQuizQuestion(){
  showTyping();
  try{
    const r=await post('/api/quiz/question',{topic:quizState.topic,difficulty:quizState.difficulty,q_num:quizState.q+1,total:quizState.total});
    hideTyping();quizState.q++;quizState.currentAnswer=r.answer;quizState.currentExpl=r.explanation;
    renderQuizQuestion(r.question,r.answer,r.explanation);
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error generating question.',true);}
}

function renderQuizQuestion(question,answer,explanation){
  const lines=question.split('\n').filter(l=>l.trim());
  const qLine=lines.find(l=>l.startsWith('Q:'))||lines[0];
  const opts=lines.filter(l=>/^[A-D]\)/.test(l.trim()));
  const id='quiz-'+Date.now();
  const html=`<div class="quiz-card" id="${id}">
    <div class="mock-info">Question ${quizState.q} of ${quizState.total}</div>
    <div class="mock-progress"><div class="mock-bar" style="width:${(quizState.q/quizState.total)*100}%"></div></div>
    <div class="quiz-q" id="${id}-q">${escHtml(qLine.replace(/^Q:\s*/,''))}</div>
    <div class="quiz-opts">
      ${opts.map(o=>{const letter=o.trim()[0],text=o.trim().slice(2).trim();
        return `<button class="quiz-opt" id="${id}-${letter}" onclick="checkAnswer('${id}','${letter}','${answer}','${escQ(explanation)}')" data-letter="${letter}">
          <span class="quiz-letter">${letter}</span><span id="${id}-opt-${letter}">${escHtml(text)}</span>
        </button>`;}).join('')}
    </div>
    <div class="quiz-expl" id="${id}-expl"></div>
    <div class="quiz-footer">
      <span class="quiz-score">Score: ${quizState.score}/${quizState.q-1}</span>
      <button class="quiz-next" id="${id}-next" style="display:none" onclick="quizNext('${id}')">Next ‚Üí</button>
    </div>
  </div>`;
  addBotHTML(html);
  setTimeout(()=>{
    const card=document.getElementById(id);
    if(card)renderMath(card);
  },100);
}

function checkAnswer(id,chosen,correct,explanation){
  ['A','B','C','D'].forEach(l=>{
    const btn=document.getElementById(`${id}-${l}`);
    if(btn){btn.disabled=true;
      if(l===correct)btn.classList.add('correct');
      else if(l===chosen&&chosen!==correct)btn.classList.add('wrong');}
  });
  const isCorrect=chosen===correct;
  if(isCorrect)quizState.score++;
  const expl=document.getElementById(`${id}-expl`);
  if(expl){
    expl.style.display='block';
    expl.innerHTML=(isCorrect?'‚úÖ Bilkul sahi! Correct! ':'‚ùå Wrong. Answer: '+correct+'. ')+escHtml(explanation||'');
    renderMath(expl);
  }
  document.getElementById(`${id}-next`).style.display='block';
  const sc=document.querySelector(`#${id} .quiz-score`);
  if(sc)sc.textContent=`Score: ${quizState.score}/${quizState.q}`;
}

async function quizNext(id){
  document.getElementById(`${id}-next`).style.display='none';
  if(quizState.q>=quizState.total)showQuizResult();
  else await nextQuizQuestion();
}

function showQuizResult(){
  const s=quizState.score,t=quizState.total,pct=Math.round((s/t)*100);
  const stars='‚≠ê'.repeat(Math.min(s,5))+'‚òÜ'.repeat(5-Math.min(s,5));
  const remark=pct===100?'Perfect score! Ekdum zabardast! üèÜ':pct>=80?'Bahut achha! Excellent! üåü':pct>=60?'Achha kiya! Keep it up! üí™':'Thoda aur practice karo! üìö';
  addBotHTML(`<div class="result-card">
    <div style="font-size:13px;color:var(--txt2);margin-bottom:8px">üèÜ Quiz Complete ‚Äî ${quizState.topic}</div>
    <div class="result-score">${s}/${t}</div>
    <div class="result-stars">${stars}</div>
    <div class="result-label">${pct}% ¬∑ ${remark}</div>
    <button class="result-restart" onclick="startQuiz('${quizState.topic}')">Try Again</button>
    &nbsp;
    <button class="result-restart" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)" onclick="showQuizTopics()">Change Topic</button>
  </div>`);
  quizState=null;
}

// ‚îÄ‚îÄ MOCK TEST ‚îÄ‚îÄ
function showMockTopics(){
  removeWelcome();document.getElementById('chat').innerHTML='';
  addBotHTML(`<div class="panel">
    <div class="panel-title">üìù Mock Test ‚Äî Select Exam</div>
    ${['JAM','GATE','CSIR'].map(e=>`<button class="panel-btn" onclick="startMock('${e}')">üéì ${e} Full Mock Test (30 Questions)</button>`).join('')}
  </div>`);
}

async function startMock(exam){
  document.getElementById('chat').innerHTML='';
  mockState={exam,q:0,total:30,score:0,wrongTopics:[]};
  addMsg('bot',`üìù ${exam} Mock Test shuru karte hain ‚Äî 30 Questions!\nA, B, C ya D click karke answer do.\nSTOP type karo test khatam karne ke liye.`);
  await nextMockQuestion();
}

async function nextMockQuestion(){
  showTyping();
  try{
    const r=await post('/api/quiz/question',{topic:getMockTopic(mockState.exam),difficulty:'hard',q_num:mockState.q+1,total:mockState.total});
    hideTyping();mockState.q++;mockState.currentAnswer=r.answer;mockState.currentExpl=r.explanation;
    renderMockQuestion(r.question,mockState.q);
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error. STOP type karo test khatam karne ke liye.',true);}
}

function getMockTopic(exam){
  const topics={JAM:['Real Analysis','Linear Algebra','Calculus','Differential Equations','Probability','Statistics'],
    GATE:['Calculus','Linear Algebra','Complex Analysis','PDE','ODE','Combinatorics','Numerical Analysis'],
    CSIR:['Real Analysis','Topology','Algebra','Complex Analysis','Functional Analysis','Probability']};
  const list=topics[exam]||topics.JAM;
  return list[Math.floor(Math.random()*list.length)];
}

function renderMockQuestion(question,qNum){
  const lines=question.split('\n').filter(l=>l.trim());
  const qLine=lines.find(l=>l.startsWith('Q:'))||lines[0];
  const opts=lines.filter(l=>/^[A-D]\)/.test(l.trim()));
  const id='mock-'+Date.now();
  const html=`<div class="quiz-card" id="${id}">
    <div class="mock-info">${mockState.exam} Mock ‚Äî Q${qNum}/${mockState.total} | Score: ${mockState.score}</div>
    <div class="mock-progress"><div class="mock-bar" style="width:${(qNum/mockState.total)*100}%"></div></div>
    <div class="quiz-q">${escHtml(qLine.replace(/^Q:\s*/,''))}</div>
    <div class="quiz-opts">
      ${opts.map(o=>{const letter=o.trim()[0],text=o.trim().slice(2).trim();
        return `<button class="quiz-opt" id="${id}-${letter}" onclick="checkMock('${id}','${letter}')" data-letter="${letter}">
          <span class="quiz-letter">${letter}</span>${escHtml(text)}</button>`;}).join('')}
    </div>
    <div class="quiz-expl" id="${id}-expl"></div>
    <div class="quiz-footer">
      <span class="mock-info">STOP type karo test khatam karne ke liye</span>
      <button class="quiz-next" id="${id}-next" style="display:none" onclick="mockNext('${id}')">${qNum>=mockState.total?'See Result':'Next ‚Üí'}</button>
    </div>
  </div>`;
  addBotHTML(html);
  setTimeout(()=>{const card=document.getElementById(id);if(card)renderMath(card);},100);
}

function checkMock(id,chosen){
  if(!mockState)return;
  const correct=mockState.currentAnswer;
  ['A','B','C','D'].forEach(l=>{const btn=document.getElementById(`${id}-${l}`);
    if(btn){btn.disabled=true;if(l===correct)btn.classList.add('correct');else if(l===chosen&&chosen!==correct)btn.classList.add('wrong');}});
  const isCorrect=chosen===correct;
  if(isCorrect)mockState.score++;else mockState.wrongTopics.push(getMockTopic(mockState.exam));
  const expl=document.getElementById(`${id}-expl`);
  if(expl){expl.style.display='block';expl.innerHTML=(isCorrect?'‚úÖ Bilkul sahi! ':'‚ùå Wrong. Answer: '+correct+'. ')+escHtml(mockState.currentExpl||'');renderMath(expl);}
  document.getElementById(`${id}-next`).style.display='block';
}

async function mockNext(id){
  document.getElementById(`${id}-next`).style.display='none';
  if(mockState.q>=mockState.total)showMockResult();else await nextMockQuestion();
}

function showMockResult(){
  const s=mockState.score,t=mockState.total,pct=Math.round((s/t)*100);
  const grade=pct>=80?'Outstanding! Bahut zabardast! üèÜ':pct>=60?'Achha kiya! Keep practicing! üí™':'Aur mehnat karo! üìö';
  const weak=[...new Set(mockState.wrongTopics)].slice(0,4).join(', ')||'None';
  addBotHTML(`<div class="result-card">
    <div style="font-size:13px;color:var(--txt2);margin-bottom:8px">üìù ${mockState.exam} Mock Test Complete</div>
    <div class="result-score">${s}/${t}</div>
    <div class="result-stars">${pct}%</div>
    <div class="result-label">${grade}</div>
    ${weak!=='None'?`<div style="font-size:12px;color:var(--txt2);margin:8px 0">‚ö†Ô∏è Revise karo: ${weak}</div>`:''}
    <button class="result-restart" onclick="startMock('${mockState.exam}')">Retry</button>
    &nbsp;
    <button class="result-restart" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)" onclick="showMockTopics()">Change Exam</button>
  </div>`);
  mockState=null;
}

// ‚îÄ‚îÄ PYQ ‚îÄ‚îÄ
function showPYQTopics(){
  removeWelcome();document.getElementById('chat').innerHTML='';
  addBotHTML(`<div class="panel">
    <div class="panel-title">üìú Previous Year Questions</div>
    ${['JAM','GATE','CSIR'].map(e=>`<button class="panel-btn" onclick="fetchPYQ('${e}')">üéì ${e} Previous Year Questions</button>`).join('')}
  </div>`);
}

async function fetchPYQ(exam){
  removeWelcome();showTyping();
  try{
    const r=await fetch(`/api/pyq?exam=${exam}`);const d=await r.json();hideTyping();
    const html=`<div class="quiz-card">
      <div class="mock-info">üìú ${exam} PYQ ‚Äî ${d.year} | Topic: ${d.topic}</div>
      <div class="quiz-q" style="margin:10px 0" id="pyq-q-${Date.now()}"><strong>Question:</strong><br>${escHtml(d.q)}</div>
      <div class="quiz-expl" style="display:block" id="pyq-a-${Date.now()}"><strong>‚úÖ Solution:</strong><br>${escHtml(d.a)}</div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="quiz-next" onclick="fetchPYQ('${exam}')">Next Question ‚Üí</button>
        <button class="quiz-next" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)" onclick="saveBookmark('${exam} PYQ','${escQ(d.q+'\\n\\nSolution: '+d.a)}')">üîñ Save</button>
      </div>
    </div>`;
    addBotHTML(html);
    setTimeout(()=>{const last=document.getElementById('chat').lastElementChild;if(last)renderMath(last);},100);
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error loading PYQ.',true);}
}

// ‚îÄ‚îÄ CHALLENGE ‚îÄ‚îÄ
async function fetchChallenge(){
  removeWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const r=await fetch('/api/challenge');const d=await r.json();hideTyping();
    const cid='ch-'+Date.now();
    addBotHTML(`<div class="quiz-card">
      <div class="panel-title">üß© Aaj ka Math Challenge!</div>
      <div class="quiz-q" style="margin:10px 0" id="${cid}">${escHtml(d.challenge)}</div>
      <div style="color:var(--txt3);font-size:12px">Apna solution chat mein type karo ‚Äî main check karunga!</div>
      <div style="margin-top:10px">
        <button class="quiz-next" onclick="fetchChallenge()">New Challenge</button>
        &nbsp;
        <button class="quiz-next" style="background:var(--sur3);color:var(--txt2);border:1px solid var(--bor)" onclick="saveBookmark('Daily Challenge','${escQ(d.challenge)}')">üîñ Save</button>
      </div>
    </div>`);
    setTimeout(()=>{const el=document.getElementById(cid);if(el)renderMath(el);},100);
    mode='chat';
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error.',true);}
}

// ‚îÄ‚îÄ MATHEMATICIAN ‚îÄ‚îÄ
async function fetchMathematician(){
  removeWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await(await fetch('/api/mathematician')).json();hideTyping();
    addBotHTML(`<div class="quiz-card">
      <div class="panel-title">üß† Mathematician of the Week</div>
      <div style="margin:10px 0">
        <div style="font-size:18px;font-weight:700;color:var(--txt)">${d.name}</div>
        <div style="font-size:12px;color:var(--acc);font-family:var(--font-mono);margin:3px 0">${d.period} ¬∑ ${d.country}</div>
        <div style="margin:12px 0;color:var(--txt2);font-size:13px;line-height:1.7">${d.contribution}</div>
        <div style="background:var(--sur3);border-left:3px solid var(--acc2);padding:10px 13px;border-radius:0 8px 8px 0;font-style:italic;color:var(--txt2);font-size:13px">"${d.quote}"</div>
      </div>
      <button class="quiz-next" onclick="fetchMathematician()">Next Mathematician</button>
    </div>`);
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error.',true);}
}

// ‚îÄ‚îÄ REAL WORLD ‚îÄ‚îÄ
async function fetchRealWorld(){
  removeWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await(await fetch('/api/realworld')).json();hideTyping();
    addBotHTML(`<div class="quiz-card">
      <div class="panel-title">üåç Real World Mathematics</div>
      <div style="margin:10px 0">
        <div style="font-size:13px;color:var(--acc);font-family:var(--font-mono)">Concept: ${d.concept}</div>
        <div style="font-size:16px;font-weight:700;color:var(--txt);margin:4px 0">Used in: ${d.application}</div>
        <div style="margin:12px 0;color:var(--txt2);font-size:13px;line-height:1.7">${d.explanation}</div>
      </div>
      <button class="quiz-next" onclick="fetchRealWorld()">Next Application</button>
    </div>`);
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error.',true);}
}

// ‚îÄ‚îÄ PARADOX ‚îÄ‚îÄ
async function showParadoxPicker(){
  removeWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const paradoxes=await(await fetch('/api/paradoxes')).json();hideTyping();
    addBotHTML(`<div class="panel">
      <div class="panel-title">üó£Ô∏è Math Debate Club ‚Äî Pick a Paradox</div>
      ${paradoxes.map(p=>`<button class="panel-btn" onclick="startDebate('${escQ(p.name)}','${escQ(p.statement)}','${escQ(p.teaser)}')">${p.name}</button>`).join('')}
      <button class="panel-btn" onclick="startRandomDebate()">üé≤ Random Paradox!</button>
    </div>`);
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error.',true);}
}

async function startRandomDebate(){
  const d=await(await fetch('/api/paradox')).json();
  startDebate(d.name,d.statement,d.teaser);
}

function startDebate(name,statement,teaser){
  debateHistory=[];document.getElementById('chat').innerHTML='';
  addBotHTML(`<div class="quiz-card">
    <div class="panel-title">üó£Ô∏è ${name}</div>
    <div style="background:var(--sur3);border-left:3px solid var(--acc4);padding:10px 13px;border-radius:0 8px 8px 0;margin:10px 0;color:var(--acc4);font-size:13px"><strong>Teaser:</strong> ${teaser}</div>
    <div style="color:var(--txt2);font-size:13px;line-height:1.7;margin:8px 0">${statement}</div>
    <div style="font-size:12px;color:var(--txt3);margin-top:10px">Tumhara kya kehna hai? Type karo apna argument!</div>
  </div>`);
  mode='debate';
}

// ‚îÄ‚îÄ EXAM INFO ‚îÄ‚îÄ
async function showExam(exam){
  removeWelcome();document.getElementById('chat').innerHTML='';showTyping();
  try{
    const d=await(await fetch(`/api/exam/${exam}`)).json();hideTyping();
    const html=`<div class="quiz-card">
      <div class="panel-title">üéì ${d.full_name}</div>
      <div style="display:grid;gap:12px;margin-top:12px">
        <div><div style="font-size:10px;color:var(--acc);font-family:var(--font-mono);margin-bottom:3px">CONDUCTING BODY</div><div style="color:var(--txt2);font-size:13px">${d.conducting_body}</div></div>
        <div><div style="font-size:10px;color:var(--acc);font-family:var(--font-mono);margin-bottom:3px">ELIGIBILITY</div><div style="color:var(--txt2);font-size:13px">${d.eligibility}</div></div>
        <div><div style="font-size:10px;color:var(--acc);font-family:var(--font-mono);margin-bottom:3px">EXAM PATTERN</div><div style="color:var(--txt2);font-size:13px;white-space:pre-line">${d.pattern}</div></div>
        <div><div style="font-size:10px;color:var(--acc);font-family:var(--font-mono);margin-bottom:3px">SYLLABUS</div><div style="color:var(--txt2);font-size:13px">${d.syllabus}</div></div>
        <div><div style="font-size:10px;color:var(--acc);font-family:var(--font-mono);margin-bottom:3px">TOPIC WEIGHTAGE</div><div style="color:var(--txt2);font-size:13px;white-space:pre-line">${d.weightage}</div></div>
        <div><div style="font-size:10px;color:var(--acc);font-family:var(--font-mono);margin-bottom:3px">RECOMMENDED BOOKS</div><div style="color:var(--txt2);font-size:13px">${d.books}</div></div>
        <div><a href="${d.website}" target="_blank" style="color:var(--acc);font-size:13px">üîó Official Website: ${d.website}</a></div>
      </div>
      <div style="margin-top:14px;display:flex;gap:8px">
        <button class="quiz-next" onclick="fetchPYQ('${exam}')">üìú View PYQs</button>
        <button class="quiz-next" onclick="startMock('${exam}')" style="background:var(--acc2)">üìù Take Mock Test</button>
      </div>
    </div>`;
    addBotHTML(html);
    document.getElementById('sidebar').classList.remove('open');
  }catch(e){hideTyping();addMsg('bot','‚ö†Ô∏è Error.',true);}
}

// ‚îÄ‚îÄ BOOKMARKS ‚îÄ‚îÄ
function showBookmarks(){
  removeWelcome();document.getElementById('chat').innerHTML='';
  if(!bookmarks.length){
    addBotHTML(`<div class="quiz-card"><div class="panel-title">üîñ My Bookmarks</div>
      <div style="color:var(--txt2);font-size:13px;margin-top:8px">Abhi koi bookmark nahi hai!<br>Kisi bhi answer ke neeche üîñ Save button click karo.</div>
    </div>`);return;
  }
  let html=`<div class="quiz-card"><div class="panel-title">üîñ My Bookmarks (${bookmarks.length})</div>`;
  bookmarks.slice().reverse().forEach((b,i)=>{
    html+=`<div class="bm-item">
      <div class="bm-topic">${b.topic} ¬∑ ${b.date}</div>
      <div class="bm-content">${b.content.substring(0,300)}${b.content.length>300?'...':''}</div>
      <button class="bm-delete" onclick="deleteBookmark(${bookmarks.length-1-i})">üóë Delete</button>
    </div>`;
  });
  html+=`<button class="quiz-next" style="background:var(--red);margin-top:4px" onclick="clearBookmarks()">Clear All</button></div>`;
  addBotHTML(html);
}

function saveBookmark(topic,content){
  bookmarks.push({topic,content,date:new Date().toLocaleDateString()});
  if(bookmarks.length>30)bookmarks.shift();
  localStorage.setItem('ms_bookmarks',JSON.stringify(bookmarks));
  showNotif('üîñ Bookmark save ho gaya!');
}

function saveLastMsg(){
  const bots=document.querySelectorAll('.msg.bot .bubble');
  if(!bots.length){showNotif('Kuch save karne ke liye nahi hai!');return;}
  const last=bots[bots.length-1].innerText;
  saveBookmark(mode==='chat'?'Math Answer':PROMPTS[mode]?.title||mode,last);
}

function deleteBookmark(idx){bookmarks.splice(idx,1);localStorage.setItem('ms_bookmarks',JSON.stringify(bookmarks));showBookmarks();}
function clearBookmarks(){if(confirm('Saare bookmarks delete karo?')){bookmarks=[];localStorage.setItem('ms_bookmarks','[]');showBookmarks();}}

function showNotif(msg){
  const n=document.createElement('div');n.className='notif-toast';n.textContent=msg;
  document.body.appendChild(n);
  setTimeout(()=>{n.style.opacity='0';n.style.transform='translateX(110%)';n.style.transition='all .3s';setTimeout(()=>n.remove(),300);},2000);
}

// ‚îÄ‚îÄ DOM HELPERS ‚îÄ‚îÄ
function addMsg(role,text,isErr=false){
  removeWelcome();
  const chat=document.getElementById('chat');
  const div=document.createElement('div');div.className=`msg ${role}`;
  const avatarContent = role==='user'
    ? 'üë§'
    : `<img src="/static/logo.png" style="width:26px;height:26px;object-fit:contain;" onerror="this.style.display='none';this.parentNode.textContent='üßÆ'"/>`;
  div.innerHTML=`<div class="avatar">${avatarContent}</div><div class="bubble${isErr?' error-bubble':''}"></div>`;
  const bubble=div.querySelector('.bubble');
  bubble.innerHTML=fmt(text);
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  requestAnimationFrame(()=>{renderMath(bubble);chat.scrollTop=chat.scrollHeight;});
  if(role==='bot'&&!isErr){
    const savebtn=document.createElement('div');savebtn.style.cssText='margin-top:8px';
    savebtn.innerHTML=`<button onclick="saveLastMsg()" style="background:none;border:1px solid var(--bor);color:var(--txt3);padding:3px 9px;border-radius:5px;font-size:10px;cursor:pointer;font-family:var(--font-mono);transition:all .2s" onmouseover="this.style.borderColor='var(--acc)';this.style.color='var(--acc)'" onmouseout="this.style.borderColor='var(--bor)';this.style.color='var(--txt3)'">üîñ Save</button>`;
    bubble.appendChild(savebtn);
  }
}

function addBotHTML(html){
  removeWelcome();
  const chat=document.getElementById('chat');
  const div=document.createElement('div');div.className='msg bot';
  div.innerHTML=`<div class="avatar"><img src="/static/logo.png" style="width:26px;height:26px;object-fit:contain;" onerror="this.style.display='none';this.parentNode.textContent='üßÆ'"/></div><div class="bubble">${html}</div>`;
  chat.appendChild(div);chat.scrollTop=chat.scrollHeight;
}

function showTyping(){
  busy=true;document.getElementById('send-btn').disabled=true;
  const chat=document.getElementById('chat');
  const div=document.createElement('div');div.className='msg bot';div.id='typing-ind';
  div.innerHTML=`<div class="avatar"><img src="/static/logo.png" style="width:26px;height:26px;object-fit:contain;" onerror="this.style.display='none';this.parentNode.textContent='üßÆ'"/></div><div class="typing"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div>`;
  chat.appendChild(div);chat.scrollTop=chat.scrollHeight;
}

function hideTyping(){
  busy=false;document.getElementById('send-btn').disabled=false;
  const t=document.getElementById('typing-ind');if(t)t.remove();
}

function escHtml(text){
  if(!text)return '';
  return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function fmt(text){
  if(!text)return '';
  const latexBlocks=[];
  let t=text;
  t=t.replace(/\\\[([\s\S]*?)\\\]/g,(m)=>{latexBlocks.push(m);return `\x00LATEX${latexBlocks.length-1}\x00`;});
  t=t.replace(/\\\(([\s\S]*?)\\\)/g,(m)=>{latexBlocks.push(m);return `\x00LATEX${latexBlocks.length-1}\x00`;});
  t=t.replace(/\$\$([\s\S]*?)\$\$/g,(m)=>{latexBlocks.push(m);return `\x00LATEX${latexBlocks.length-1}\x00`;});
  t=t.replace(/\$([^\$\n]+?)\$/g,(m)=>{latexBlocks.push(m);return `\x00LATEX${latexBlocks.length-1}\x00`;});
  t=t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  t=t.replace(/\x00LATEX(\d+)\x00/g,(_,i)=>latexBlocks[parseInt(i)]);
  t=t.replace(/(https?:\/\/[^\s<&]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');
  t=t.replace(/```([\s\S]*?)```/g,'<pre>$1</pre>');
  t=t.replace(/`([^`\n]+)`/g,'<code>$1</code>');
  t=t.replace(/(‚óÜ‚îÅ+‚óÜ)/g,'<hr>');
  t=t.replace(/^(üìå|üí°|üìñ|üìê|‚úèÔ∏è|üìö|üìù|‚úÖ|‚ö†Ô∏è|üéØ|üî¢|üî∑|üìä|üèÜ|üß©|üåê|üî¨)\s+(.+)$/gm,'<span class="sec">$1 $2</span>');
  t=t.replace(/\n/g,'<br>');
  return t;
}

function escQ(s){return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;').replace(/\n/g,'\\n');}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}

async function quickSend(msg){
  if(mode!=='chat')setMode('chat');
  document.getElementById('input').value=msg;
  await sendMsg();
}

// ‚îÄ‚îÄ IMAGE ‚îÄ‚îÄ
function handleImg(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{const res=ev.target.result;imgB64=res.split(',')[1];imgType=file.type;
    document.getElementById('prev-img').src=res;
    document.getElementById('img-preview').style.display='block';
    document.getElementById('input').placeholder='Is image ke baare mein poocho...';};
  r.readAsDataURL(file);
}

function removeImg(){
  imgB64=null;imgType=null;
  document.getElementById('img-preview').style.display='none';
  document.getElementById('file-in').value='';
  document.getElementById('input').placeholder=(PROMPTS[mode]||PROMPTS.chat).ph;
}

document.addEventListener('paste',e=>{
  const items=e.clipboardData?.items;if(!items)return;
  for(const it of items){
    if(it.type.startsWith('image/')){
      const file=it.getAsFile();const r=new FileReader();
      r.onload=ev=>{const res=ev.target.result;imgB64=res.split(',')[1];imgType=file.type;
        document.getElementById('prev-img').src=res;document.getElementById('img-preview').style.display='block';};
      r.readAsDataURL(file);
    }
  }
});

// ‚îÄ‚îÄ MISC ‚îÄ‚îÄ
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}
document.getElementById('app').addEventListener('click',e=>{
  if(window.innerWidth<=700&&!document.getElementById('sidebar').contains(e.target)&&
     !document.getElementById('menu-toggle').contains(e.target)){
    document.getElementById('sidebar').classList.remove('open');}
});

async function post(url,data){
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(!r.ok){const err=await r.json().catch(()=>({}));throw new Error(err.error||`Server error ${r.status}`);}
  return r.json();
}

function checkStop(text){
  if(text.trim().toUpperCase()==='STOP'){
    if(mockState){showMockResult();return true;}
    if(quizState){showQuizResult();return true;}
  }return false;
}

// ‚îÄ‚îÄ EXAM OPTIONS (Step 2C) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EXAM_OPTIONS = {
    jam: [
        { label: 'üìñ Syllabus', onclick: 'showExam("JAM")' },
        { label: 'üìö Study Materials', onclick: 'showMaterials("JAM")' },
        { label: 'üìù PYQ Mock Test', onclick: 'startPYQMockTest("JAM")' },
        { label: 'üí° Concept Checker', onclick: 'showConceptTopics("JAM")' },
        { label: 'üìä Progress Tracker', onclick: 'showProgressTracker("JAM")' },
        { label: '‚ùì Ask Expert', onclick: 'setMode("chat")' }
    ],
    gate: [
        { label: 'üìñ Syllabus', onclick: 'showExam("GATE")' },
        { label: 'üìö Study Materials', onclick: 'showMaterials("GATE")' },
        { label: 'üìù PYQ Mock Test', onclick: 'startPYQMockTest("GATE")' },
        { label: 'üí° Concept Checker', onclick: 'showConceptTopics("GATE")' },
        { label: 'üìä Progress Tracker', onclick: 'showProgressTracker("GATE")' },
        { label: '‚ùì Ask Expert', onclick: 'setMode("chat")' }
    ],
    net: [
        { label: 'üìñ Syllabus', onclick: 'showExam("CSIR")' },
        { label: 'üìö Study Materials', onclick: 'showMaterials("NET")' },
        { label: 'üìù PYQ Mock Test', onclick: 'startPYQMockTest("NET")' },
        { label: 'üí° Concept Checker', onclick: 'showConceptTopics("NET")' },
        { label: 'üìä Progress Tracker', onclick: 'showProgressTracker("NET")' },
        { label: '‚ùì Ask Expert', onclick: 'setMode("chat")' }
    ],
    boards: [
        { label: 'üìö Study Materials', onclick: 'showMaterials("BOARDS")' },
        { label: 'üìù Mock Tests', onclick: 'startPYQMockTest("BOARDS")' },
        { label: 'üí° Concept Checker', onclick: 'showConceptTopics("BOARDS")' },
        { label: 'üìä Progress Tracker', onclick: 'showProgressTracker("BOARDS")' },
        { label: '‚ùì Ask Expert', onclick: 'setMode("chat")' }
    ],
    general: [
        { label: 'üí¨ Ask Anything', onclick: 'setMode("chat")' },
        { label: 'üìà Plot Function', onclick: 'showGraphPrompt()' },
        { label: 'üßÆ Calculator', onclick: 'setMode("calculator")' }
    ]
};

// ‚îÄ‚îÄ HELPER FUNCTIONS FOR NEW FEATURES (Step 2E) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showConceptTopics(exam) {
    removeWelcome();
    const topicMap = {
        "JAM": ["Limits and Continuity", "Derivatives"],
        "GATE": ["Linear Algebra"],
        "NET": ["Analysis"]
    };
    const topics = topicMap[exam] || [];
    let html = `<div class="panel">
        <div class="panel-title">üí° Select Topic for Concept Check</div>
        ${topics.map(t => `<button class="panel-btn" onclick="startConceptChecker('${exam}', '${t}')">${t}</button>`).join('')}
    </div>`;
    addBotHTML(html);
}

function showGraphPrompt() {
    removeWelcome();
    let html = `<div class="panel">
        <div class="panel-title">üìà Function Plotter</div>
        <div style="margin: 15px 0; color: var(--txt2); font-size: 12px;">
            Enter a function to plot (use 'x' as variable)<br>
            Examples: x**2, x**2-4*x+3, sin(x), cos(x), exp(x)
        </div>
        <input id="equation-input" type="text" placeholder="e.g., x**2 - 4*x + 3" style="width: 100%; padding: 10px; border: 1px solid var(--bor); border-radius: 8px; background: var(--sur2); color: var(--txt); margin: 10px 0; font-family: monospace;">
        <button onclick="const eq = document.getElementById('equation-input').value; if(eq) plotFunction2D(eq); else alert('Please enter an equation');" style="width: 100%; padding: 10px; background: var(--acc); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
            üìä Plot Function
        </button>
    </div>`;
    addBotHTML(html);
}

// ‚îÄ‚îÄ PYQ MOCK TEST SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let currentMockTest = null;
let mockTestTimer = null;
let mockTestStartTime = null;

async function startPYQMockTest(exam) {
    removeWelcome();
    showTyping();
    try {
        const r = await fetch(`/api/pyq-mock/${exam}`);
        const data = await r.json();
        hideTyping();
        currentMockTest = {
            ...data,
            answers: {},
            currentQuestion: 0,
            startTime: Date.now()
        };
        displayMockTestUI();
        startMockTimer();
    } catch (e) {
        hideTyping();
        addMsg('bot', '‚ö†Ô∏è Error loading mock test.', true);
    }
}

function startMockTimer() {
    mockTestStartTime = Date.now();
    const duration = currentMockTest.duration * 60 * 1000;
    const endTime = mockTestStartTime + duration;
    mockTestTimer = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now;
        if (remaining <= 0) {
            clearInterval(mockTestTimer);
            submitMockTest();
            return;
        }
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        const timerEl = document.getElementById('mock-timer');
        if (timerEl) timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        if (remaining < 5 * 60 * 1000) {
            if (timerEl) timerEl.style.color = 'var(--red)';
        }
    }, 1000);
}

function displayMockTestUI() {
    const q = currentMockTest.currentQuestion;
    const question = currentMockTest.questions[q];
    let html = `
        <div class="quiz-card" style="position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <span style="color: var(--txt2);">${currentMockTest.exam} MOCK TEST</span><br>
                    <strong>Question ${q + 1} of ${currentMockTest.total_questions}</strong>
                </div>
                <div style="font-size: 20px; font-weight: bold; color: var(--red);" id="mock-timer">60:00</div>
            </div>
            <div style="width: 100%; height: 4px; background: var(--bor); border-radius: 2px; overflow: hidden; margin-bottom: 15px;">
                <div style="width: ${((q + 1) / currentMockTest.total_questions) * 100}%; height: 100%; background: var(--acc); transition: width 0.3s;"></div>
            </div>
            <div style="margin: 20px 0;">
                <h3 style="margin-bottom: 15px; line-height: 1.7;">${question.question}</h3>
                <p style="color: var(--txt3); font-size: 12px; margin-bottom: 10px;">Topic: <strong>${question.topic}</strong> | Year: <strong>${question.year}</strong></p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; margin: 20px 0;">
                ${['A', 'B', 'C', 'D'].map(option => `
                    <label style="padding: 12px; border: 2px solid var(--bor); border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="mock-answer-${q}" value="${option}"
                            ${currentMockTest.answers[q] === option ? 'checked' : ''}
                            onchange="currentMockTest.answers[${q}] = this.value;"
                            style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1;"><strong>${option})</strong> (Select option)</span>
                    </label>
                `).join('')}
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: space-between;">
                <button onclick="previousMockQuestion()" ${q === 0 ? 'disabled' : ''}
                    style="padding: 10px 20px; background: var(--sur3); border: 1px solid var(--bor); border-radius: 8px; color: var(--txt2); cursor: pointer;">
                    ‚Üê Previous
                </button>
                <div style="display: flex; gap: 10px;">
                    ${q < currentMockTest.total_questions - 1 ? `
                        <button onclick="nextMockQuestion()"
                            style="padding: 10px 20px; background: var(--acc); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                            Next ‚Üí
                        </button>
                    ` : `
                        <button onclick="submitMockTest()"
                            style="padding: 10px 20px; background: var(--green); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                            ‚úì SUBMIT TEST
                        </button>
                    `}
                </div>
            </div>
        </div>
    `;
    addBotHTML(html);
}

function nextMockQuestion() {
    if (currentMockTest.currentQuestion < currentMockTest.total_questions - 1) {
        currentMockTest.currentQuestion++;
        document.getElementById('chat').lastElementChild.remove();
        displayMockTestUI();
    }
}

function previousMockQuestion() {
    if (currentMockTest.currentQuestion > 0) {
        currentMockTest.currentQuestion--;
        document.getElementById('chat').lastElementChild.remove();
        displayMockTestUI();
    }
}

async function submitMockTest() {
    clearInterval(mockTestTimer);
    const duration = (Date.now() - mockTestStartTime) / 1000 / 60;
    showTyping();
    try {
        const r = await fetch(`/api/pyq-submit/${currentMockTest.exam}/${currentMockTest.test_id}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ answers: currentMockTest.answers, duration: duration })
        });
        const result = await r.json();
        hideTyping();
        document.getElementById('chat').lastElementChild.remove();
        let html = `
            <div class="result-card" style="text-align: center;">
                <div style="font-size: 14px; color: var(--txt2); margin-bottom: 15px;">
                    üìù ${currentMockTest.exam} MOCK TEST RESULT
                </div>
                <div style="font-size: 48px; font-weight: 800; color: var(--acc); margin: 20px 0;">
                    ${result.score}/${result.total}
                </div>
                <div style="font-size: 32px; margin: 10px 0;">
                    ${result.percentage >= 80 ? '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê' : result.percentage >= 60 ? '‚≠ê‚≠ê‚≠ê‚≠ê' : result.percentage >= 40 ? '‚≠ê‚≠ê‚≠ê' : '‚≠ê‚≠ê'}
                </div>
                <div style="font-size: 18px; color: var(--txt); margin: 15px 0;">${result.percentage.toFixed(1)}%</div>
                <div style="color: var(--txt2); margin: 15px 0;">${result.feedback}</div>
                <div style="margin: 20px 0; padding: 15px; background: var(--sur3); border-radius: 8px; text-align: left;">
                    <div style="color: var(--acc); font-weight: 600; margin-bottom: 8px;">üí™ Strong Areas:</div>
                    <div style="color: var(--txt2); margin-bottom: 15px;">${result.strong_areas.join(', ') || 'None identified'}</div>
                    <div style="color: var(--red); font-weight: 600; margin-bottom: 8px;">üìå Weak Areas (Focus Here):</div>
                    <div style="color: var(--txt2);">${result.weak_areas.join(', ') || 'None identified'}</div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="startPYQMockTest('${currentMockTest.exam}')"
                        style="padding: 10px 20px; background: var(--acc); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üîÑ Retry Test
                    </button>
                    <button onclick="setMode('chat')"
                        style="padding: 10px 20px; background: var(--sur3); color: var(--txt2); border: 1px solid var(--bor); border-radius: 8px; cursor: pointer;">
                        Ask Doubt
                    </button>
                </div>
            </div>
        `;
        addBotHTML(html);
        currentMockTest = null;
    } catch (e) {
        hideTyping();
        addMsg('bot', '‚ö†Ô∏è Error submitting test.', true);
    }
}

// ‚îÄ‚îÄ CONCEPT CHECKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function startConceptChecker(exam, topic) {
    removeWelcome();
    showTyping();
    try {
        const r = await fetch(`/api/concept-check/${exam}/${topic}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        const data = await r.json();
        hideTyping();
        let html = `
            <div class="quiz-card">
                <h2>üí° Concept Checker: ${topic}</h2>
                <p style="color: var(--txt2); margin: 10px 0; font-size: 13px;">
                    ‚úì Pass Score: ${data.pass_score}% (${Math.ceil(data.total_questions * data.pass_score / 100)} out of ${data.total_questions} correct)
                </p>
                <form id="concept-form" onsubmit="submitConceptChecker(event, '${exam}', '${topic}', ${data.total_questions})">
                    ${data.questions.map((q, i) => `
                        <div style="margin: 20px 0; padding: 15px; background: var(--sur3); border-radius: 8px;">
                            <h4 style="margin-bottom: 12px;">Q${i+1}: ${q.question}</h4>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${Object.entries(q.options).map(([key, value]) => `
                                    <label style="padding: 10px; border: 1px solid var(--bor); border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; gap: 10px;">
                                        <input type="radio" name="cc-q${i}" value="${key}" required style="cursor: pointer;">
                                        <span><strong>${key})</strong> ${value}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    <button type="submit" style="width: 100%; padding: 12px; background: var(--acc); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 20px; font-size: 14px;">
                        ‚úì Check My Understanding
                    </button>
                </form>
            </div>
        `;
        addBotHTML(html);
    } catch (e) {
        hideTyping();
        addMsg('bot', '‚ö†Ô∏è Error loading concept check.', true);
    }
}

async function submitConceptChecker(event, exam, topic, totalQuestions) {
    event.preventDefault();
    showTyping();
    try {
        const answers = {};
        for (let i = 0; i < totalQuestions; i++) {
            const selected = document.querySelector(`input[name="cc-q${i}"]:checked`);
            if (selected) answers[`Q${i+1}`] = selected.value;
        }
        const r = await fetch(`/api/concept-check/submit/${exam}/${topic}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({answers: answers})
        });
        const result = await r.json();
        hideTyping();
        document.getElementById('chat').lastElementChild.remove();
        const passed = result.percentage >= 80;
        let html = `
            <div class="result-card" style="text-align: center;">
                <h2 style="color: ${passed ? 'var(--green)' : 'var(--yellow)'};">
                    ${passed ? '‚úÖ CONCEPT CLEAR!' : '‚ö†Ô∏è NEEDS REVIEW'}
                </h2>
                <div style="font-size: 42px; font-weight: 800; color: var(--acc); margin: 15px 0;">
                    ${result.score}/${result.total}
                </div>
                <div style="font-size: 24px; margin: 10px 0;">${result.percentage.toFixed(1)}%</div>
                <div style="color: var(--txt2); margin: 15px 0; font-size: 13px;">${result.message}</div>
                <div style="margin: 20px 0; padding: 15px; background: var(--sur3); border-radius: 8px; text-align: left; max-height: 300px; overflow-y: auto;">
                    ${result.feedback.map(f => `
                        <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--bor);">
                            <div style="color: ${f.status.includes('‚úÖ') ? 'var(--green)' : 'var(--red)'}; font-weight: 600; margin-bottom: 5px;">${f.status}</div>
                            <div style="color: var(--txt2); font-size: 12px; margin: 5px 0;"><strong>Q:</strong> ${f.question}</div>
                            <div style="color: var(--txt3); font-size: 11px;">Your answer: <strong>${f.your_answer || 'Not answered'}</strong> | Correct: <strong>${f.correct_answer}</strong></div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    ${!passed ? `
                        <button onclick="startConceptChecker('${exam}', '${topic}')"
                            style="padding: 10px 20px; background: var(--acc); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Try Again
                        </button>
                    ` : ''}
                    <button onclick="setMode('chat')"
                        style="padding: 10px 20px; background: var(--sur3); color: var(--txt2); border: 1px solid var(--bor); border-radius: 8px; cursor: pointer;">
                        Ask Questions
                    </button>
                </div>
            </div>
        `;
        addBotHTML(html);
    } catch (e) {
        hideTyping();
        addMsg('bot', '‚ö†Ô∏è Error submitting concept check.', true);
    }
}

// ‚îÄ‚îÄ PROGRESS TRACKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function showProgressTracker(exam) {
    removeWelcome();
    showTyping();
    try {
        const r = await fetch(`/api/tracker/${exam}`);
        const data = await r.json();
        hideTyping();
        let html = `
            <div class="tracker" style="background: var(--sur2); border: 1px solid var(--bor); border-radius: 12px; padding: 20px;">
                <h2>üìä ${exam} Progress Tracker</h2>
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Overall Progress</span>
                        <strong>${data.overall_progress.toFixed(1)}%</strong>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--bor); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${data.overall_progress}%; height: 100%; background: linear-gradient(90deg, var(--acc), var(--acc2)); transition: width 0.5s;"></div>
                    </div>
                </div>
                ${Object.entries(data.topics).map(([topic, subtopics]) => `
                    <div style="margin: 20px 0;">
                        <h3 style="color: var(--acc); margin-bottom: 12px;">üìö ${topic}</h3>
                        ${Object.entries(subtopics).map(([subtopic, status]) => {
                            const completed = [status.definition_learned, status.concept_check_passed, status.practice_done, status.pyq_attempted].filter(s => s).length;
                            return `
                                <div style="margin: 10px 0; padding: 12px; background: var(--sur3); border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">${subtopic}</span>
                                        <span style="color: var(--txt3); font-size: 12px;">${completed}/4 completed</span>
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        ${[
                                            ['definition_learned', 'üìñ Definition'],
                                            ['concept_check_passed', 'üí° Concept'],
                                            ['practice_done', 'üß™ Practice'],
                                            ['pyq_attempted', 'üìù PYQ Test']
                                        ].map(([key, label]) => `
                                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; padding: 6px 10px; background: ${status[key] ? 'rgba(45, 214, 122, 0.1)' : 'rgba(125, 135, 158, 0.1)'}; border-radius: 6px; transition: all 0.2s;">
                                                <input type="checkbox" ${status[key] ? 'checked' : ''}
                                                    onchange="updateTracker('${exam}', '${topic}', '${subtopic}', '${key}', this.checked)"
                                                    style="cursor: pointer; width: 16px; height: 16px;">
                                                <span>${label}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `).join('')}
            </div>
        `;
        addBotHTML(html);
    } catch (e) {
        hideTyping();
        addMsg('bot', '‚ö†Ô∏è Error loading tracker.', true);
    }
}

async function updateTracker(exam, topic, subtopic, item, status) {
    try {
        const r = await fetch('/api/tracker/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ exam, topic, subtopic, item, status })
        });
        const result = await r.json();
        if (result.status === 'success') showProgressTracker(exam);
    } catch (e) {
        console.error('Error updating tracker:', e);
    }
}

// ‚îÄ‚îÄ GRAPH VISUALIZATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function plotFunction2D(equation) {
    removeWelcome();
    showTyping();
    try {
        const r = await fetch('/api/plot-2d', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ equation, x_min: -10, x_max: 10 })
        });
        const data = await r.json();
        hideTyping();
        if (data.error) { addMsg('bot', `‚ö†Ô∏è ${data.error}`, true); return; }
        let html = `
            <div style="background: var(--sur2); border: 1px solid var(--bor); border-radius: 12px; padding: 20px; margin: 10px 0;">
                <h3>üìä Function Graph: f(x) = ${equation}</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <svg width="100%" height="400" style="border: 1px solid #ddd; border-radius: 8px;" id="graph-plot"></svg>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                    <div style="background: var(--sur3); padding: 12px; border-radius: 8px;">
                        <div style="color: var(--txt3); font-size: 12px; margin-bottom: 5px;">üìç ROOTS</div>
                        <div style="color: var(--txt); font-weight: 600;">${data.roots.length > 0 ? data.roots.map(r => `x = ${r}`).join(', ') : 'No real roots'}</div>
                    </div>
                    <div style="background: var(--sur3); padding: 12px; border-radius: 8px;">
                        <div style="color: var(--txt3); font-size: 12px; margin-bottom: 5px;">üîÑ CRITICAL POINTS</div>
                        <div style="color: var(--txt); font-weight: 600;">${data.critical_points.length > 0 ? `Found: ${data.critical_points.length}` : 'None found'}</div>
                    </div>
                    <div style="background: var(--sur3); padding: 12px; border-radius: 8px;">
                        <div style="color: var(--txt3); font-size: 12px; margin-bottom: 5px;">üìà DOMAIN</div>
                        <div style="color: var(--txt); font-weight: 600;">${data.analysis.domain}</div>
                    </div>
                    <div style="background: var(--sur3); padding: 12px; border-radius: 8px;">
                        <div style="color: var(--txt3); font-size: 12px; margin-bottom: 5px;">üéØ Y-INTERCEPT</div>
                        <div style="color: var(--txt); font-weight: 600;">${data.analysis.y_intercept !== null ? `y = ${data.analysis.y_intercept.toFixed(2)}` : 'Undefined'}</div>
                    </div>
                </div>
                ${data.critical_points.length > 0 ? `
                    <div style="background: var(--sur3); padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <div style="color: var(--txt3); font-size: 12px; margin-bottom: 8px;">üìå CRITICAL POINTS DETAILS</div>
                        ${data.critical_points.map(cp => `
                            <div style="color: var(--txt2); font-size: 12px; margin: 5px 0;">
                                <strong>x = ${cp.x.toFixed(4)}</strong>, f(x) = ${cp.y.toFixed(4)} [${cp.type.toUpperCase()}]
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
        addBotHTML(html);
        setTimeout(() => { drawPlot(data); }, 100);
    } catch (e) {
        hideTyping();
        addMsg('bot', `‚ö†Ô∏è Error: ${e.message}`, true);
    }
}

function drawPlot(data) {
    const svg = document.getElementById('graph-plot');
    if (!svg) return;
    const width = svg.clientWidth;
    const height = 400;
    const padding = 40;
    const plotWidth = width - 2 * padding;
    const plotHeight = height - 2 * padding;
    const yValues = data.y.filter(v => !isNaN(v) && isFinite(v));
    const yMin = Math.min(...yValues);
    const yMax = Math.max(...yValues);
    const yRange = yMax - yMin || 1;
    for (let i = 0; i <= 10; i++) {
        const x = padding + (plotWidth / 10) * i;
        const y = padding + (plotHeight / 10) * i;
        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', x); line1.setAttribute('y1', padding);
        line1.setAttribute('x2', x); line1.setAttribute('y2', height - padding);
        line1.setAttribute('stroke', '#ddd'); line1.setAttribute('stroke-width', '0.5');
        svg.appendChild(line1);
        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', padding); line2.setAttribute('y1', y);
        line2.setAttribute('x2', width - padding); line2.setAttribute('y2', y);
        line2.setAttribute('stroke', '#ddd'); line2.setAttribute('stroke-width', '0.5');
        svg.appendChild(line2);
    }
    const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    xAxis.setAttribute('x1', padding); xAxis.setAttribute('y1', padding + plotHeight / 2);
    xAxis.setAttribute('x2', width - padding); xAxis.setAttribute('y2', padding + plotHeight / 2);
    xAxis.setAttribute('stroke', '#333'); xAxis.setAttribute('stroke-width', '2');
    svg.appendChild(xAxis);
    const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    yAxis.setAttribute('x1', padding); yAxis.setAttribute('y1', padding);
    yAxis.setAttribute('x2', padding); yAxis.setAttribute('y2', height - padding);
    yAxis.setAttribute('stroke', '#333'); yAxis.setAttribute('stroke-width', '2');
    svg.appendChild(yAxis);
    let pathData = '';
    for (let i = 0; i < data.x.length; i++) {
        const x_val = data.x[i];
        const y_val = data.y[i];
        if (!isNaN(y_val) && isFinite(y_val)) {
            const x_pos = padding + ((x_val - (-10)) / 20) * plotWidth;
            const y_pos = padding + plotHeight / 2 - ((y_val - 0) / (yRange || 1)) * (plotHeight / 2);
            pathData += (i === 0 ? `M ${x_pos} ${y_pos}` : ` L ${x_pos} ${y_pos}`);
        }
    }
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', pathData); path.setAttribute('stroke', '#4f8ef7');
    path.setAttribute('stroke-width', '2'); path.setAttribute('fill', 'none');
    svg.appendChild(path);
    data.roots.forEach(root => {
        const x_pos = padding + ((root - (-10)) / 20) * plotWidth;
        const y_pos = padding + plotHeight / 2;
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x_pos); circle.setAttribute('cy', y_pos);
        circle.setAttribute('r', '5'); circle.setAttribute('fill', '#e84040');
        svg.appendChild(circle);
    });
    data.critical_points.forEach(cp => {
        const x_pos = padding + ((cp.x - (-10)) / 20) * plotWidth;
        const y_pos = padding + plotHeight / 2 - ((cp.y - 0) / (yRange || 1)) * (plotHeight / 2);
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x_pos); circle.setAttribute('cy', y_pos);
        circle.setAttribute('r', '4'); circle.setAttribute('fill', '#2dd67a');
        svg.appendChild(circle);
    });
}
</script>
</body>
</html>