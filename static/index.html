<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>MathSphere v8.0 ‚Äî The Mathematical Lab</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"/>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
<style>
:root {
  --bg-deep: #0a0e27;
  --bg-main: #0f1437;
  --bg-light: #14194f;
  --accent-primary: #00d9ff;
  --accent-secondary: #7c3aed;
  --accent-tertiary: #06f7d6;
  --text-primary: #f8fafc;
  --text-secondary: #a8b7d1;
  --text-tertiary: #6b7a94;
  --gold: #d4a574;
  --danger: #ff6b6b;
  --font-display: 'Playfair Display', serif;
  --font-body: 'Poppins', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; background:linear-gradient(135deg,var(--bg-deep) 0%,#1a1f4b 100%); color:var(--text-primary); font-family:var(--font-body); font-size:14px; line-height:1.65; overflow:hidden; }
body::before { content:''; position:fixed; inset:0; pointer-events:none; z-index:0; background:radial-gradient(circle at 20% 80%,rgba(0,217,255,.15) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(124,58,237,.1) 0%,transparent 50%); animation:gradientShift 15s ease-in-out infinite; }
@keyframes gradientShift { 0%,100%{filter:blur(40px)} 50%{filter:blur(60px)} }
body::after { content:''; position:fixed; inset:0; pointer-events:none; z-index:0; background-image:linear-gradient(0deg,transparent 24%,rgba(0,217,255,.05) 25%,rgba(0,217,255,.05) 26%,transparent 27%,transparent 74%,rgba(0,217,255,.05) 75%,rgba(0,217,255,.05) 76%,transparent 77%),linear-gradient(90deg,transparent 24%,rgba(0,217,255,.05) 25%,rgba(0,217,255,.05) 26%,transparent 27%,transparent 74%,rgba(0,217,255,.05) 75%,rgba(0,217,255,.05) 76%,transparent 77%); background-size:60px 60px; opacity:.3; }
.math-float { position:fixed; font-size:80px; opacity:.04; pointer-events:none; z-index:0; animation:float 20s infinite ease-in-out; font-family:var(--font-mono); color:var(--accent-primary); }
@keyframes float { 0%,100%{transform:translateY(0) rotate(0deg)} 50%{transform:translateY(-20px) rotate(180deg)} }
#app { position:relative; z-index:1; display:flex; height:100vh; max-width:1400px; margin:0 auto; }

/* SIDEBAR */
#sidebar { width:260px; flex-shrink:0; background:rgba(10,14,39,.9); backdrop-filter:blur(20px); border-right:1px solid rgba(0,217,255,.1); display:flex; flex-direction:column; overflow:hidden; transition:transform .3s ease; }
.logo-wrap { padding:20px 18px; border-bottom:1px solid rgba(0,217,255,.1); display:flex; align-items:center; gap:14px; background:linear-gradient(135deg,rgba(0,217,255,.05) 0%,rgba(124,58,237,.05) 100%); }
.logo-icon { width:44px; height:44px; background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; box-shadow:0 0 30px rgba(0,217,255,.4); animation:glow 3s ease-in-out infinite; }
@keyframes glow { 0%,100%{box-shadow:0 0 20px rgba(0,217,255,.3)} 50%{box-shadow:0 0 40px rgba(0,217,255,.6),0 0 80px rgba(124,58,237,.3)} }
.logo-name { font-family:var(--font-display); font-size:17px; font-weight:800; background:linear-gradient(135deg,var(--text-primary),var(--accent-primary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
.logo-by { font-size:10px; color:var(--text-tertiary); font-family:var(--font-mono); letter-spacing:1.5px; text-transform:uppercase; }
.sb-scroll { flex:1; overflow-y:auto; padding:10px 8px; scrollbar-width:thin; scrollbar-color:rgba(0,217,255,.3) transparent; }
.sb-scroll::-webkit-scrollbar { width:4px; }
.sb-scroll::-webkit-scrollbar-thumb { background:rgba(0,217,255,.3); border-radius:2px; }
.sb-section { padding:12px 12px 4px; font-size:9px; color:var(--text-tertiary); font-family:var(--font-mono); letter-spacing:2px; text-transform:uppercase; margin-top:6px; }
.nav-btn { display:flex; align-items:center; gap:10px; width:100%; padding:10px 12px; border:none; background:transparent; color:var(--text-secondary); cursor:pointer; border-radius:8px; font-family:var(--font-body); font-size:13px; font-weight:500; transition:all .25s ease; text-align:left; margin:2px 0; position:relative; overflow:hidden; }
.nav-btn::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:linear-gradient(180deg,var(--accent-primary),var(--accent-secondary)); transform:scaleY(0); transition:transform .25s ease; border-radius:0 2px 2px 0; }
.nav-btn:hover { color:var(--text-primary); background:rgba(0,217,255,.07); transform:translateX(4px); }
.nav-btn.active { background:rgba(0,217,255,.12); color:var(--accent-primary); border:1px solid rgba(0,217,255,.3); box-shadow:0 0 15px rgba(0,217,255,.15); }
.nav-btn.active::before { transform:scaleY(1); }
.nav-btn .em { font-size:15px; transition:transform .25s ease; }
.nav-btn:hover .em { transform:scale(1.2) rotate(-8deg); }

/* MAIN */
#main { flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0; }
#topbar { display:flex; align-items:center; gap:12px; padding:12px 20px; border-bottom:1px solid rgba(0,217,255,.1); background:rgba(10,14,39,.7); backdrop-filter:blur(20px); flex-shrink:0; }
#mode-title { font-family:var(--font-display); font-weight:700; font-size:17px; background:linear-gradient(135deg,var(--text-primary),var(--accent-primary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; flex:1; transition:opacity .2s; }
.status-dot { width:8px; height:8px; border-radius:50%; background:linear-gradient(135deg,var(--accent-tertiary),var(--accent-primary)); box-shadow:0 0 12px var(--accent-tertiary); animation:pulse 2s ease-in-out infinite; }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.3)} }
#clear-btn,#theme-btn { background:rgba(0,217,255,.08); border:1px solid rgba(0,217,255,.25); color:var(--text-secondary); padding:6px 12px; border-radius:7px; font-family:var(--font-mono); font-size:10px; cursor:pointer; transition:all .25s; }
#clear-btn:hover,#theme-btn:hover { background:rgba(0,217,255,.15); border-color:var(--accent-primary); color:var(--accent-primary); box-shadow:0 0 12px rgba(0,217,255,.25); }
#owner-name { font-family:var(--font-display); font-weight:700; font-size:11px; color:var(--accent-tertiary); padding:5px 10px; border:1px solid rgba(6,247,214,.3); border-radius:999px; background:rgba(6,247,214,.08); }
#tagsbar { display:flex; gap:8px; padding:10px 20px; border-bottom:1px solid rgba(0,217,255,.08); background:rgba(20,25,79,.3); overflow-x:auto; flex-shrink:0; scrollbar-width:none; }
#tagsbar::-webkit-scrollbar { display:none; }
.tag { background:rgba(0,217,255,.07); border:1px solid rgba(0,217,255,.2); color:var(--text-secondary); padding:5px 12px; border-radius:20px; font-size:11px; font-family:var(--font-mono); cursor:pointer; white-space:nowrap; transition:all .25s; }
.tag:hover { background:rgba(0,217,255,.15); border-color:var(--accent-primary); color:var(--accent-primary); transform:translateY(-2px); box-shadow:0 6px 15px rgba(0,217,255,.2); }

/* CHAT */
#chat { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; scrollbar-width:thin; scrollbar-color:rgba(0,217,255,.2) transparent; }
#chat::-webkit-scrollbar { width:5px; }
#chat::-webkit-scrollbar-thumb { background:rgba(0,217,255,.2); border-radius:3px; }
.msg { display:flex; gap:10px; animation:msgIn .3s cubic-bezier(.4,0,.2,1); }
@keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.msg.user { flex-direction:row-reverse; }
.avatar { width:34px; height:34px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; font-weight:bold; }
.msg.user .avatar { background:linear-gradient(135deg,#1a2d5c,#2a1f4f); border:1px solid rgba(124,58,237,.3); }
.msg.bot .avatar { background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); box-shadow:0 0 15px rgba(0,217,255,.35); }
.bubble { max-width:78%; padding:13px 16px; border-radius:14px; font-size:13.5px; line-height:1.8; overflow-wrap:break-word; min-width:0; backdrop-filter:blur(10px); }
.msg.user .bubble { background:linear-gradient(135deg,rgba(124,58,237,.12),rgba(0,217,255,.08)); border:1px solid rgba(124,58,237,.25); border-top-right-radius:3px; }
.msg.bot .bubble { background:linear-gradient(135deg,rgba(0,217,255,.08),rgba(20,25,79,.5)); border:1px solid rgba(0,217,255,.2); border-top-left-radius:3px; position:relative; }
.msg.bot .bubble::before { content:''; position:absolute; top:0; left:0; right:0; height:1.5px; background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary),var(--accent-tertiary),transparent); border-radius:14px 14px 0 0; opacity:.5; }
.bubble code { font-family:var(--font-mono); font-size:11.5px; background:rgba(0,0,0,.3); padding:2px 5px; border-radius:4px; color:var(--accent-tertiary); }
.bubble pre { background:rgba(0,0,0,.4); border:1px solid rgba(0,217,255,.2); border-radius:8px; padding:12px; margin:8px 0; overflow-x:auto; font-family:var(--font-mono); font-size:11px; line-height:1.6; color:var(--accent-tertiary); white-space:pre-wrap; }

/* INPUT */
#inputarea { padding:14px 20px 18px; border-top:1px solid rgba(0,217,255,.1); background:rgba(10,14,39,.7); backdrop-filter:blur(20px); flex-shrink:0; }
.inp-wrap { display:flex; gap:8px; align-items:flex-end; background:rgba(20,25,79,.6); border:1px solid rgba(0,217,255,.25); border-radius:12px; padding:9px 10px 9px 14px; transition:all .25s ease; }
.inp-wrap:focus-within { border-color:var(--accent-primary); background:rgba(20,25,79,.8); box-shadow:0 6px 30px rgba(0,217,255,.15); }
#input { flex:1; background:none; border:none; outline:none; color:var(--text-primary); font-family:var(--font-body); font-size:13.5px; line-height:1.6; resize:none; max-height:120px; min-height:22px; font-weight:500; }
#input::placeholder { color:var(--text-tertiary); }
.iico { width:34px; height:34px; background:rgba(0,217,255,.08); border:1px solid rgba(0,217,255,.2); border-radius:7px; color:var(--text-tertiary); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:14px; transition:all .25s; flex-shrink:0; }
.iico:hover { background:rgba(0,217,255,.18); border-color:var(--accent-primary); color:var(--accent-primary); transform:scale(1.1); }
#send-btn { width:34px; height:34px; background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); border:none; border-radius:7px; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:15px; box-shadow:0 4px 15px rgba(0,217,255,.3); transition:all .25s; flex-shrink:0; }
#send-btn:hover { transform:scale(1.12) rotate(8deg); box-shadow:0 8px 25px rgba(0,217,255,.5); }
#send-btn:disabled { opacity:.4; cursor:not-allowed; transform:none; }
.inp-hint { text-align:center; margin-top:7px; font-size:10px; color:var(--text-tertiary); font-family:var(--font-mono); }

/* WELCOME */
#welcome { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; padding:30px 20px; text-align:center; animation:welcomeIn .6s cubic-bezier(.4,0,.2,1); }
@keyframes welcomeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
.big-icon { width:88px; height:88px; background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); border-radius:22px; display:flex; align-items:center; justify-content:center; font-size:44px; box-shadow:0 20px 50px rgba(0,217,255,.4); animation:iconFloat 4s ease-in-out infinite; margin-bottom:24px; }
@keyframes iconFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-12px)} }
#welcome h1 { font-family:var(--font-display); font-size:32px; font-weight:800; letter-spacing:-1px; margin-bottom:10px; background:linear-gradient(135deg,var(--text-primary),var(--accent-primary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
#welcome p { color:var(--text-secondary); max-width:460px; font-size:13px; line-height:1.8; margin-bottom:24px; }
.feat-grid { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; max-width:580px; }
.feat { background:rgba(0,217,255,.07); border:1px solid rgba(0,217,255,.18); border-radius:8px; padding:7px 13px; font-size:11px; color:var(--text-secondary); font-family:var(--font-mono); transition:all .25s; cursor:default; }
.feat:hover { background:rgba(0,217,255,.13); border-color:var(--accent-primary); color:var(--accent-primary); transform:translateY(-3px); }
.feat.new { border-color:rgba(6,247,214,.25); color:var(--accent-tertiary); background:rgba(6,247,214,.07); }

/* PANEL CARDS */
.panel-card { background:linear-gradient(135deg,rgba(0,217,255,.07),rgba(124,58,237,.07)); border:1px solid rgba(0,217,255,.2); border-radius:14px; padding:20px; animation:cardIn .35s cubic-bezier(.4,0,.2,1); }
@keyframes cardIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.panel-title { font-family:var(--font-display); font-weight:700; font-size:16px; color:var(--text-primary); margin-bottom:4px; }
.panel-sub { font-size:11px; color:var(--text-tertiary); font-family:var(--font-mono); margin-bottom:16px; }
.form-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
.form-group { display:flex; flex-direction:column; gap:6px; flex:1; min-width:140px; }
.form-label { font-size:10px; color:var(--text-tertiary); font-family:var(--font-mono); letter-spacing:1px; text-transform:uppercase; }
.form-input, .form-select { background:rgba(20,25,79,.7); border:1px solid rgba(0,217,255,.2); color:var(--text-primary); border-radius:8px; padding:9px 12px; font-family:var(--font-body); font-size:13px; outline:none; transition:all .25s; }
.form-input:focus, .form-select:focus { border-color:var(--accent-primary); box-shadow:0 0 12px rgba(0,217,255,.15); background:rgba(20,25,79,.9); }
.form-select option { background:var(--bg-main); color:var(--text-primary); }
.action-btn { background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); border:none; color:white; padding:11px 24px; border-radius:9px; font-family:var(--font-body); font-size:13px; font-weight:600; cursor:pointer; transition:all .25s; box-shadow:0 4px 15px rgba(0,217,255,.3); }
.action-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,217,255,.45); }
.action-btn:disabled { opacity:.4; cursor:not-allowed; transform:none; }
.action-btn-secondary { background:rgba(0,217,255,.1); border:1px solid rgba(0,217,255,.3); color:var(--accent-primary); padding:9px 18px; border-radius:8px; font-family:var(--font-body); font-size:12px; font-weight:600; cursor:pointer; transition:all .25s; }
.action-btn-secondary:hover { background:rgba(0,217,255,.2); transform:translateY(-1px); }
.result-box { background:rgba(0,0,0,.25); border:1px solid rgba(0,217,255,.15); border-radius:10px; padding:16px; margin-top:14px; line-height:1.9; font-size:13.5px; color:var(--text-primary); white-space:pre-wrap; overflow-wrap:break-word; max-height:55vh; overflow-y:auto; scrollbar-width:thin; scrollbar-color:rgba(0,217,255,.2) transparent; }
.result-box::-webkit-scrollbar { width:4px; }
.result-box::-webkit-scrollbar-thumb { background:rgba(0,217,255,.2); border-radius:2px; }
.graph-box { background:rgba(0,0,0,.3); border:1px solid rgba(0,217,255,.2); border-radius:10px; padding:12px; margin-top:12px; height:360px; }

/* TYPING */
.typing { display:flex; gap:5px; padding:12px 14px; background:rgba(0,217,255,.08); border:1px solid rgba(0,217,255,.2); border-radius:14px; border-top-left-radius:3px; width:fit-content; }
.td { width:6px; height:6px; border-radius:50%; background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); animation:bounce 1.2s ease-in-out infinite; }
.td:nth-child(2){animation-delay:.2s}.td:nth-child(3){animation-delay:.4s}
@keyframes bounce { 0%,60%,100%{transform:translateY(0);opacity:.5} 30%{transform:translateY(-9px);opacity:1} }

/* TOAST */
.toast { position:fixed; top:18px; right:18px; padding:11px 16px; border-radius:9px; font-size:12px; z-index:9999; font-family:var(--font-mono); animation:toastIn .3s ease; backdrop-filter:blur(10px); border:1px solid; }
@keyframes toastIn { from{opacity:0;transform:translateX(80px)} to{opacity:1;transform:translateX(0)} }
.toast.ok { background:rgba(6,247,214,.1); border-color:rgba(6,247,214,.3); color:var(--accent-tertiary); }
.toast.info { background:rgba(0,217,255,.1); border-color:rgba(0,217,255,.3); color:var(--accent-primary); }
.toast.err { background:rgba(255,107,107,.1); border-color:rgba(255,107,107,.3); color:#ff6b6b; }
.loading-spin { display:inline-block; width:14px; height:14px; border:2px solid rgba(0,217,255,.3); border-top-color:var(--accent-primary); border-radius:50%; animation:spin .7s linear infinite; vertical-align:middle; margin-right:6px; }
@keyframes spin { to{transform:rotate(360deg)} }

/* KATEX */
.katex { color:var(--text-primary); font-size:1.04em; }
.katex-display { margin:10px 0; overflow-x:auto; }

/* MOBILE */
@media(max-width:700px) {
  #sidebar { position:fixed; top:0; left:0; bottom:0; z-index:100; transform:translateX(-100%); width:240px; }
  #sidebar.open { transform:translateX(0); box-shadow:4px 0 30px rgba(0,217,255,.3); }
  #menu-toggle { display:flex!important; }
  .bubble { max-width:88%; }
  #welcome h1 { font-size:24px; }
  .graph-box { height:260px; }
}
</style>
</head>
<body>

<div id="app">

<!-- SIDEBAR -->
<nav id="sidebar">
  <div class="logo-wrap">
    <div class="logo-icon">‚àë</div>
    <div>
      <div class="logo-name">MathSphere</div>
      <div class="logo-by">By Anupam Nigam</div>
    </div>
  </div>
  <div class="sb-scroll">
    <div class="sb-section">üßÆ Core Learning</div>
    <button class="nav-btn active" id="nav-ask" onclick="setMode('ask')"><span class="em">üí¨</span>Ask Anupam</button>
    <button class="nav-btn" id="nav-formula" onclick="setMode('formula')"><span class="em">üìä</span>Formula Sheet</button>
    <button class="nav-btn" id="nav-graph" onclick="setMode('graph')"><span class="em">üìà</span>Graph Plotter</button>
    <div class="sb-section">üî¨ Explore</div>
    <button class="nav-btn" id="nav-mathematician" onclick="setMode('mathematician')"><span class="em">üë®‚Äçüî¨</span>Mathematicians</button>
    <button class="nav-btn" id="nav-projects" onclick="setMode('projects')"><span class="em">üöÄ</span>Projects</button>
    <button class="nav-btn" id="nav-theorem" onclick="setMode('theorem')"><span class="em">üìê</span>Theorems</button>
    <button class="nav-btn" id="nav-competition" onclick="setMode('competition')"><span class="em">üèÜ</span>Competitions</button>
    <div class="sb-section">üìö Practice</div>
    <button class="nav-btn" id="nav-quiz" onclick="setMode('quiz')"><span class="em">üìù</span>Quiz Mode</button>
    <button class="nav-btn" id="nav-verify" onclick="setMode('verify')"><span class="em">‚úÖ</span>Verify Answer</button>
    <button class="nav-btn" id="nav-mistakes" onclick="setMode('mistakes')"><span class="em">‚ö†Ô∏è</span>Common Mistakes</button>
  </div>
  <div style="padding:10px 8px;border-top:1px solid rgba(0,217,255,.1);display:flex;gap:6px">
    <a href="https://youtube.com/@pi_nomenal1729" target="_blank" style="flex:1;text-align:center;padding:7px;background:rgba(0,217,255,.07);border:1px solid rgba(0,217,255,.2);border-radius:7px;color:var(--text-secondary);text-decoration:none;font-size:11px;transition:all .25s" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-secondary)'">‚ñ∂ YouTube</a>
    <a href="https://www.anupamnigam.com" target="_blank" style="flex:1;text-align:center;padding:7px;background:rgba(0,217,255,.07);border:1px solid rgba(0,217,255,.2);border-radius:7px;color:var(--text-secondary);text-decoration:none;font-size:11px;transition:all .25s" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-secondary)'">üåê Website</a>
  </div>
</nav>

<!-- MAIN -->
<div id="main">
  <div id="topbar">
    <button id="menu-toggle" onclick="toggleSidebar()" style="display:none;background:rgba(0,217,255,.1);border:1px solid rgba(0,217,255,.2);color:var(--text-secondary);width:34px;height:34px;border-radius:7px;cursor:pointer;font-size:16px;align-items:center;justify-content:center">‚ò∞</button>
    <div id="mode-title">üí¨ Ask Anupam</div>
    <div class="status-dot"></div>
    <span style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono)">LIVE</span>
    <span id="owner-name">Anupam Nigam</span>
    <button id="theme-btn" onclick="toggleTheme()">üåô Dark</button>
    <button id="clear-btn" onclick="clearAll()">CLEAR</button>
  </div>
  <div id="tagsbar"></div>
  <div id="chat"></div>
  <div id="inputarea">
    <div style="display:none;margin-bottom:8px;position:relative" id="imgpreview">
      <img id="prev-img" src="" alt="" style="width:64px;height:48px;object-fit:cover;border-radius:7px;border:1px solid rgba(0,217,255,.3)"/>
      <button onclick="removeImg()" style="position:absolute;top:-5px;right:-5px;width:16px;height:16px;background:var(--danger);border-radius:50%;border:none;color:white;font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center">‚úï</button>
    </div>
    <div class="inp-wrap">
      <textarea id="input" rows="1" placeholder="Ask any math question..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <div style="display:flex;gap:7px;align-items:center;flex-shrink:0">
        <input type="file" id="filein" accept="image/*" style="display:none" onchange="handleImg(event)"/>
        <button class="iico" onclick="document.getElementById('filein').click()" title="Upload image">üì∏</button>
        <button id="send-btn" onclick="sendMsg()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
    <div class="inp-hint">MathSphere v8.0 ¬∑ The Mathematical Lab ¬∑ By Anupam Nigam</div>
  </div>
</div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üîß CONFIG ‚Äî YOUR RENDER BACKEND URL
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const API_BASE = "https://mathsphere-dlbt.onrender.com";

/* ‚ïê‚ïê‚ïê‚ïê Floating symbols ‚ïê‚ïê‚ïê‚ïê */
(()=>{
  const syms=['‚à´','‚àë','œÄ','‚àû','‚àö','‚àÇ','‚àá','Œª','Œî','Œ∏','Œ±','Œ≤','Œ≥'];
  for(let i=0;i<12;i++){
    const p=document.createElement('div');
    p.className='math-float';
    p.textContent=syms[i%syms.length];
    p.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;animation-duration:${20+Math.random()*15}s;animation-delay:${-Math.random()*20}s`;
    document.body.appendChild(p);
  }
})();

/* ‚ïê‚ïê‚ïê‚ïê KaTeX ‚ïê‚ïê‚ïê‚ïê */
function renderMath(el){
  if(!el||typeof renderMathInElement==='undefined')return;
  try{
    renderMathInElement(el,{
      delimiters:[
        {left:'\\[',right:'\\]',display:true},
        {left:'\\(',right:'\\)',display:false},
        {left:'$$',right:'$$',display:true},
        {left:'$',right:'$',display:false}
      ],throwOnError:false,errorColor:'#ff6b6b',strict:false
    });
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê */
let mode='ask', chatHistory=[], imgB64=null, imgType=null, busy=false;

const MODE_CFG={
  ask:{title:'üí¨ Ask Anupam',ph:'Ask any mathematics question...'},
  formula:{title:'üìä Formula Sheet',ph:''},
  graph:{title:'üìà Graph Plotter',ph:''},
  mathematician:{title:'üë®‚Äçüî¨ Mathematician Explorer',ph:''},
  projects:{title:'üöÄ Math Projects',ph:''},
  theorem:{title:'üìê Theorem Prover',ph:''},
  competition:{title:'üèÜ Competition Problems',ph:''},
  quiz:{title:'üìù Quiz Mode',ph:''},
  verify:{title:'‚úÖ Verify Answer',ph:''},
  mistakes:{title:'‚ö†Ô∏è Common Mistakes',ph:''},
};

window.onload=()=>{
  initTheme();
  setMode('ask');
};

/* ‚ïê‚ïê‚ïê‚ïê MODE SWITCHING ‚ïê‚ïê‚ïê‚ïê */
function setMode(m){
  mode=m;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const nb=document.getElementById(`nav-${m}`);
  if(nb)nb.classList.add('active');
  const cfg=MODE_CFG[m]||MODE_CFG.ask;
  const mt=document.getElementById('mode-title');
  mt.style.opacity='0';
  setTimeout(()=>{mt.textContent=cfg.title;mt.style.opacity='1';},150);
  if(cfg.ph)document.getElementById('input').placeholder=cfg.ph;
  document.getElementById('sidebar').classList.remove('open');
  clearAll();
  renderTagsBar();

  // Show mode-specific UI instead of welcome for non-chat modes
  if(m!=='ask') renderModePanel(m);
}

function clearAll(){
  chatHistory=[];imgB64=null;imgType=null;removeImg();
  document.getElementById('chat').innerHTML='';
  showWelcome();
}

function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}

document.addEventListener('click',e=>{
  const sb=document.getElementById('sidebar');
  if(window.innerWidth<=700&&sb.classList.contains('open')&&
     !sb.contains(e.target)&&e.target.id!=='menu-toggle')
    sb.classList.remove('open');
});

/* ‚ïê‚ïê‚ïê‚ïê TAGS BAR ‚ïê‚ïê‚ïê‚ïê */
function renderTagsBar(){
  const bar=document.getElementById('tagsbar');
  const tags={
    ask:[['‚à´ Integral','Solve: ‚à´ x¬≤ sin(x) dx step by step'],
         ['Matrix','Find eigenvalues of matrix [[2,1],[1,2]]'],
         ['Series','Test convergence of Œ£ 1/n¬≤'],
         ['ODE','Solve dy/dx + 2y = 4x, y(0)=1']],
    formula:[['Calculus','Calculus'],['Linear Algebra','Linear Algebra'],['Real Analysis','Real Analysis'],['Complex Analysis','Complex Analysis']],
    graph:[['x¬≤','x**2'],['sin(x)','sin(x)'],['e^x','exp(x)'],['x¬≥-3x','x**3-3*x'],['1/x','1/x']],
    mathematician:[['Ramanujan','Srinivasa Ramanujan'],['Euler','Leonhard Euler'],['Gauss','Carl Friedrich Gauss'],['Noether','Emmy Noether'],['Turing','Alan Turing']],
    theorem:[['Pythagorean','Pythagorean Theorem'],['FTA','Fundamental Theorem of Algebra'],['Bayes','Bayes Theorem'],['Fermat Last','Fermat Last Theorem']],
    competition:[['IMO','IMO'],['PUTNAM','PUTNAM'],['AIME','AIME']],
    quiz:[['Calculus','Calculus'],['Linear Algebra','Linear Algebra'],['Real Analysis','Real Analysis'],['Probability','Probability']],
    mistakes:[['Calculus','Calculus'],['Integration','Integration'],['Linear Algebra','Linear Algebra'],['Limits','Limits']],
  };
  const list=tags[mode];
  if(!list){bar.innerHTML='';return;}
  bar.innerHTML=list.map(item=>{
    const label=Array.isArray(item)?item[0]:item;
    const val=Array.isArray(item)?item[1]:item;
    return`<div class="tag" onclick="tagClick('${esc(val)}')">${label}</div>`;
  }).join('');
}

function tagClick(val){
  if(mode==='ask'){quickChat(val);return;}
  const panels={formula:fillFormula,graph:fillGraph,mathematician:fillMathematician,theorem:fillTheorem,competition:fillCompetition,quiz:fillQuiz,mistakes:fillMistakes};
  if(panels[mode])panels[mode](val);
}

/* ‚ïê‚ïê‚ïê‚ïê WELCOME SCREEN ‚ïê‚ïê‚ïê‚ïê */
function showWelcome(){
  const chat=document.getElementById('chat');
  chat.innerHTML=`
  <div id="welcome">
    <div class="big-icon">‚àë</div>
    <h1>MathSphere</h1>
    <p>Your premium AI mathematics laboratory. Solve problems, explore mathematicians, prove theorems and master mathematics with advanced AI.</p>
    <div class="feat-grid">
      <div class="feat">‚ú® Natural Chat</div>
      <div class="feat">üìä Formula Sheets</div>
      <div class="feat">üìà Graph Plotting</div>
      <div class="feat">üë®‚Äçüî¨ Math Explorers</div>
      <div class="feat">üöÄ Real Projects</div>
      <div class="feat">üìê Theorem Proofs</div>
      <div class="feat">üèÜ Competitions</div>
      <div class="feat new">üìù Quiz Mode</div>
      <div class="feat new">üì∏ Image Solving</div>
      <div class="feat new">‚úÖ Verify Answers</div>
      <div class="feat new">‚ö†Ô∏è Common Mistakes</div>
    </div>
  </div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê MODE PANELS ‚ïê‚ïê‚ïê‚ïê */
function renderModePanel(m){
  const chat=document.getElementById('chat');
  chat.innerHTML='';

  if(m==='formula') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">üìä Formula Sheet Generator</div>
      <div class="panel-sub">Get complete exam-ready formula sheets for any topic</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Topic</label>
          <input class="form-input" id="f-topic" placeholder="e.g. Calculus, Linear Algebra..." value="Calculus"/>
        </div>
        <div class="form-group">
          <label class="form-label">Exam</label>
          <select class="form-select" id="f-exam">
            <option value="JAM">IIT JAM</option>
            <option value="GATE">GATE</option>
            <option value="CSIR">CSIR NET</option>
            <option value="General">General</option>
          </select>
        </div>
      </div>
      <button class="action-btn" onclick="runFormula()">Generate Formula Sheet</button>
      <div id="f-result" class="result-box" style="display:none"></div>
    </div>`;

  else if(m==='graph') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">üìà Graph Plotter</div>
      <div class="panel-sub">Plot and analyze any mathematical function</div>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label class="form-label">Function f(x) =</label>
          <input class="form-input" id="g-expr" placeholder="e.g. x**2, sin(x), exp(x), x**3-3*x" value="x**2"/>
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-select" id="g-type">
            <option value="2d">2D Plot</option>
          </select>
        </div>
      </div>
      <button class="action-btn" onclick="runGraph()">Plot & Analyze</button>
      <div id="g-plotbox" class="graph-box" style="display:none"></div>
      <div id="g-result" class="result-box" style="display:none"></div>
    </div>`;

  else if(m==='mathematician') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">üë®‚Äçüî¨ Mathematician Explorer</div>
      <div class="panel-sub">Discover the lives and contributions of great mathematicians</div>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label class="form-label">Mathematician Name</label>
          <input class="form-input" id="m-name" placeholder="e.g. Ramanujan, Euler, Gauss, Emmy Noether..."/>
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <button class="action-btn" onclick="runMathematician()">Explore</button>
        <button class="action-btn-secondary" onclick="runRandomMathematician()">üé≤ Random</button>
      </div>
      <div id="m-result" class="result-box" style="display:none"></div>
    </div>`;

  else if(m==='projects') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">üöÄ Math Projects Generator</div>
      <div class="panel-sub">Get 5 detailed, actionable projects with code for any topic</div>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label class="form-label">Topic</label>
          <input class="form-input" id="p-topic" placeholder="e.g. Machine Learning, Statistics, Graph Theory..." value="Machine Learning"/>
        </div>
      </div>
      <button class="action-btn" onclick="runProjects()">Generate Projects</button>
      <div id="p-result" class="result-box" style="display:none"></div>
    </div>`;

  else if(m==='theorem') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">üìê Theorem Prover</div>
      <div class="panel-sub">Get complete, rigorous proofs from scratch</div>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label class="form-label">Theorem Name</label>
          <input class="form-input" id="t-name" placeholder="e.g. Pythagorean Theorem, Fundamental Theorem of Calculus..." value="Pythagorean Theorem"/>
        </div>
      </div>
      <button class="action-btn" onclick="runTheorem()">Prove Theorem</button>
      <div id="t-result" class="result-box" style="display:none"></div>
    </div>`;

  else if(m==='competition') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">üèÜ Competition Problems</div>
      <div class="panel-sub">Practice with olympiad-level problems and complete solutions</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Competition</label>
          <select class="form-select" id="c-cat">
            <option value="IMO">IMO</option>
            <option value="PUTNAM">Putnam</option>
            <option value="AIME">AIME</option>
            <option value="AMC">AMC</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Number of Problems</label>
          <select class="form-select" id="c-count">
            <option value="5">5 Problems</option>
            <option value="10" selected>10 Problems</option>
            <option value="20">20 Problems</option>
            <option value="30">30 Problems</option>
          </select>
        </div>
      </div>
      <button class="action-btn" onclick="runCompetition()">Generate Problems</button>
      <div id="c-result" class="result-box" style="display:none"></div>
    </div>`;

  else if(m==='quiz') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">üìù Quiz Mode</div>
      <div class="panel-sub">Practice with exam-style questions and complete solutions</div>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label class="form-label">Topic</label>
          <input class="form-input" id="q-topic" placeholder="e.g. Calculus, Real Analysis..." value="Calculus"/>
        </div>
        <div class="form-group">
          <label class="form-label">Questions</label>
          <select class="form-select" id="q-count">
            <option value="10">10 Questions</option>
            <option value="20" selected>20 Questions</option>
            <option value="30">30 Questions</option>
          </select>
        </div>
      </div>
      <button class="action-btn" onclick="runQuiz()">Start Quiz</button>
      <div id="q-result" class="result-box" style="display:none"></div>
    </div>`;

  else if(m==='verify') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">‚úÖ Answer Verifier</div>
      <div class="panel-sub">Check if your solution is correct</div>
      <div class="form-row">
        <div class="form-group" style="flex:1;min-width:100%">
          <label class="form-label">Problem</label>
          <textarea class="form-input" id="v-problem" rows="3" placeholder="Enter the problem statement..." style="resize:vertical"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:1;min-width:100%">
          <label class="form-label">Your Solution</label>
          <textarea class="form-input" id="v-solution" rows="3" placeholder="Enter your solution..." style="resize:vertical"></textarea>
        </div>
      </div>
      <button class="action-btn" onclick="runVerify()">Verify Solution</button>
      <div id="v-result" class="result-box" style="display:none"></div>
    </div>`;

  else if(m==='mistakes') chat.innerHTML=`
    <div class="panel-card">
      <div class="panel-title">‚ö†Ô∏è Common Mistakes</div>
      <div class="panel-sub">Learn the most common errors students make</div>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label class="form-label">Topic</label>
          <input class="form-input" id="mk-topic" placeholder="e.g. Integration, Limits, Linear Algebra..." value="Integration"/>
        </div>
      </div>
      <button class="action-btn" onclick="runMistakes()">Show Common Mistakes</button>
      <div id="mk-result" class="result-box" style="display:none"></div>
    </div>`;

  // render math in the new panel
  setTimeout(()=>renderMath(document.getElementById('chat')),100);
}

/* ‚ïê‚ïê‚ïê‚ïê FILL HELPERS (from tag clicks) ‚ïê‚ïê‚ïê‚ïê */
function fillFormula(val){document.getElementById('f-topic').value=val;runFormula();}
function fillGraph(val){document.getElementById('g-expr').value=val;runGraph();}
function fillMathematician(val){document.getElementById('m-name').value=val;runMathematician();}
function fillTheorem(val){document.getElementById('t-name').value=val;runTheorem();}
function fillCompetition(val){document.getElementById('c-cat').value=val;runCompetition();}
function fillQuiz(val){document.getElementById('q-topic').value=val;runQuiz();}
function fillMistakes(val){document.getElementById('mk-topic').value=val;runMistakes();}

/* ‚ïê‚ïê‚ïê‚ïê API RUNNERS ‚ïê‚ïê‚ïê‚ïê */
async function runFormula(){
  const topic=document.getElementById('f-topic').value.trim()||'Calculus';
  const exam=document.getElementById('f-exam').value;
  await runPanel('/api/formula',{topic,exam},'f-result',r=>r.answer);
}

async function runGraph(){
  const expr=document.getElementById('g-expr').value.trim()||'x**2';
  const btn=document.querySelector('#chat .action-btn');
  setLoading(btn,true,'Plotting...');
  try{
    const r=await apiPost('/api/graph',{expression:expr,type:'2d'});
    const plotbox=document.getElementById('g-plotbox');

    if(r.sympy&&r.points&&r.points.length>0){
      // SymPy available ‚Äî draw real graph with Plotly
      plotbox.style.display='block';
      plotbox.style.height='380px';
      const pts=r.points.filter(p=>p.y!==null&&p.y!==undefined&&isFinite(p.y));
      Plotly.newPlot(plotbox,[{
        x:pts.map(p=>p.x),
        y:pts.map(p=>p.y),
        type:'scatter',
        mode:'lines',
        line:{color:'#00d9ff',width:2.5,shape:'spline'},
        name:`f(x) = ${expr}`,
        fill:'tozeroy',
        fillcolor:'rgba(0,217,255,0.05)'
      }],{
        paper_bgcolor:'rgba(15,20,55,0.95)',
        plot_bgcolor:'rgba(15,20,55,0.95)',
        font:{color:'#a8b7d1',family:'JetBrains Mono',size:11},
        xaxis:{
          gridcolor:'rgba(0,217,255,.12)',
          zerolinecolor:'rgba(0,217,255,.4)',
          zerolinewidth:1.5,
          title:{text:'x',font:{color:'#00d9ff'}},
          tickfont:{color:'#6b7a94'}
        },
        yaxis:{
          gridcolor:'rgba(0,217,255,.12)',
          zerolinecolor:'rgba(0,217,255,.4)',
          zerolinewidth:1.5,
          title:{text:'f(x)',font:{color:'#00d9ff'}},
          tickfont:{color:'#6b7a94'}
        },
        margin:{l:55,r:20,t:40,b:50},
        showlegend:true,
        legend:{bgcolor:'rgba(0,0,0,0)',font:{color:'#a8b7d1',size:11}},
        title:{text:`f(x) = ${expr}`,font:{color:'#f8fafc',size:14},x:0.5}
      },{responsive:true,displayModeBar:true,
        modeBarButtonsToRemove:['pan2d','select2d','lasso2d','resetScale2d'],
        displaylogo:false});
      showResult('g-result',r.analysis||'');
    } else {
      // No SymPy ‚Äî show AI analysis only
      plotbox.style.display='none';
      showResult('g-result',r.analysis||'Could not plot graph. Analysis:\n\n'+JSON.stringify(r));
    }
  }catch(e){
    showResult('g-result','‚ö†Ô∏è Error: '+e.message,true);
  }finally{
    setLoading(btn,false,'Plot & Analyze');
  }
}

async function runMathematician(){
  const name=document.getElementById('m-name').value.trim();
  const btn=document.querySelector('#chat .action-btn');
  const resBox=document.getElementById('m-result');
  setLoading(btn,true,'Exploring...');
  resBox.style.display='none';
  try{
    const r=await apiPost('/api/mathematician',{name});
    resBox.style.display='block';
    resBox.innerHTML=formatMathematician(r);
    setTimeout(()=>renderMath(resBox),100);
  }catch(e){
    resBox.style.display='block';
    resBox.innerHTML='‚ö†Ô∏è Error: '+e.message;
  }finally{setLoading(btn,false,'Explore');}
}

async function runRandomMathematician(){
  document.getElementById('m-name').value='';
  const btn=document.querySelectorAll('#chat .action-btn')[0];
  const resBox=document.getElementById('m-result');
  setLoading(btn,true,'Loading...');
  resBox.style.display='none';
  try{
    const r=await apiPost('/api/mathematician',{});
    if(r.name) document.getElementById('m-name').value=r.name;
    resBox.style.display='block';
    resBox.innerHTML=formatMathematician(r);
    setTimeout(()=>renderMath(resBox),100);
  }catch(e){
    resBox.style.display='block';
    resBox.innerHTML='‚ö†Ô∏è Error: '+e.message;
  }finally{setLoading(btn,false,'Explore');}
}

function formatMathematician(r){
  if(!r||(!r.name&&!r.biography)) return '‚ö†Ô∏è Could not load mathematician data.';
  const name=r.name||'Unknown';
  const period=r.period||'';
  const country=r.country||'';
  const fields=Array.isArray(r.fields)?r.fields.join(' ¬∑ '):(r.fields||'');
  const bio=r.biography||r.bio||'';
  const quote=r.famous_quote||'';
  const contributions=Array.isArray(r.major_contributions)?r.major_contributions:[];
  const achievements=r.key_achievements||{};
  const impact=r.impact_today||'';
  const resources=Array.isArray(r.learning_resources)?r.learning_resources:[];
  const wiki=r.wikipedia||`https://en.wikipedia.org/wiki/${encodeURIComponent(name)}`;

  let html=`
  <div style="border-bottom:1px solid rgba(0,217,255,.2);padding-bottom:16px;margin-bottom:16px">
    <div style="font-family:var(--font-display);font-size:22px;font-weight:800;background:linear-gradient(135deg,#f8fafc,#00d9ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px">${escHtml(name)}</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px">
      ${period?`<span style="background:rgba(0,217,255,.12);border:1px solid rgba(0,217,255,.3);padding:3px 10px;border-radius:20px;font-size:11px;font-family:var(--font-mono);color:var(--accent-primary)">üìÖ ${escHtml(period)}</span>`:''}
      ${country?`<span style="background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.3);padding:3px 10px;border-radius:20px;font-size:11px;font-family:var(--font-mono);color:#a78bfa)">üåç ${escHtml(country)}</span>`:''}
    </div>
    ${fields?`<div style="font-size:11px;color:var(--accent-tertiary);font-family:var(--font-mono)">üî¨ ${escHtml(fields)}</div>`:''}
  </div>`;

  if(bio){
    html+=`<div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">üìñ BIOGRAPHY</div>
      <div style="color:var(--text-secondary);line-height:1.9;font-size:13px">${escHtml(bio)}</div>
    </div>`;
  }

  if(quote){
    html+=`<div style="background:rgba(212,165,116,.08);border-left:3px solid var(--gold);padding:12px 16px;border-radius:0 8px 8px 0;margin-bottom:16px;font-style:italic;color:var(--gold);font-size:13px">
      "${escHtml(quote)}"
    </div>`;
  }

  if(contributions.length>0){
    html+=`<div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">üèÜ MAJOR CONTRIBUTIONS</div>
      ${contributions.map(c=>`<div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:6px"><span style="color:var(--accent-primary);flex-shrink:0">‚ñ∏</span><span style="color:var(--text-secondary);font-size:13px">${escHtml(c)}</span></div>`).join('')}
    </div>`;
  }

  if(Object.keys(achievements).length>0){
    html+=`<div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">üìê KEY RESULTS & THEOREMS</div>
      ${Object.entries(achievements).map(([k,v])=>`
        <div style="background:rgba(0,217,255,.06);border:1px solid rgba(0,217,255,.15);border-radius:8px;padding:10px 14px;margin-bottom:8px">
          <div style="color:var(--accent-primary);font-weight:600;font-size:12px;margin-bottom:4px">${escHtml(k)}</div>
          <div style="color:var(--text-secondary);font-size:12px;line-height:1.7">${escHtml(String(v))}</div>
        </div>`).join('')}
    </div>`;
  }

  if(impact){
    html+=`<div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">üåç IMPACT TODAY</div>
      <div style="color:var(--text-secondary);font-size:13px;line-height:1.8">${escHtml(impact)}</div>
    </div>`;
  }

  if(resources.length>0){
    html+=`<div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">üìö LEARNING RESOURCES</div>
      ${resources.map(r=>`<div style="color:var(--accent-tertiary);font-size:12px;margin-bottom:4px">‚Üí ${escHtml(r)}</div>`).join('')}
    </div>`;
  }

  html+=`<div style="margin-top:4px">
    <a href="${escHtml(wiki)}" target="_blank" style="display:inline-block;background:rgba(0,217,255,.1);border:1px solid rgba(0,217,255,.3);color:var(--accent-primary);padding:8px 18px;border-radius:8px;text-decoration:none;font-size:12px;font-family:var(--font-mono);transition:all .25s" onmouseover="this.style.background='rgba(0,217,255,.2)'" onmouseout="this.style.background='rgba(0,217,255,.1)'">üîó Wikipedia ‚Üí</a>
  </div>`;

  return html;
}

function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

async function runProjects(){
  const topic=document.getElementById('p-topic').value.trim()||'Machine Learning';
  const btn=document.querySelector('#chat .action-btn');
  const resBox=document.getElementById('p-result');
  setLoading(btn,true,'Generating Projects...');
  resBox.style.display='none';
  try{
    const r=await apiPost('/api/projects/generate',{topic});
    resBox.style.display='block';
    if(!r.projects||!r.projects.length){
      resBox.innerHTML='‚ö†Ô∏è Could not generate projects. Please try again.';
      return;
    }
    resBox.innerHTML=r.projects.map((p,i)=>formatProject(p,i)).join('');
    setTimeout(()=>renderMath(resBox),100);
  }catch(e){
    resBox.style.display='block';
    resBox.innerHTML='‚ö†Ô∏è Error: '+e.message;
  }finally{setLoading(btn,false,'Generate Projects');}
}

function formatProject(p,i){
  const diffColor={'Beginner':'#06f7d6','Intermediate':'#00d9ff','Advanced':'#a78bfa'}[p.difficulty]||'#00d9ff';
  const concepts=Array.isArray(p.math_concepts)?p.math_concepts:[];
  const steps=Array.isArray(p.step_by_step)?p.step_by_step:[];
  const resources=Array.isArray(p.resources)?p.resources:[];
  const searchQuery=encodeURIComponent((p.title||'')+ ' mathematics project tutorial');
  const githubQuery=encodeURIComponent(p.title||'');
  const youtubeUrl=`https://www.youtube.com/results?search_query=${searchQuery}`;
  const githubUrl=`https://github.com/search?q=${githubQuery}&type=repositories`;
  const googleUrl=`https://www.google.com/search?q=${searchQuery}`;

  return `
  <div style="background:rgba(0,217,255,.05);border:1px solid rgba(0,217,255,.18);border-radius:12px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden">
    <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary),var(--accent-tertiary))"></div>

    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap">
      <div>
        <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);margin-bottom:4px">PROJECT ${i+1}</div>
        <div style="font-family:var(--font-display);font-size:17px;font-weight:700;color:var(--text-primary)">${escHtml(p.title||'')}</div>
      </div>
      <span style="background:rgba(0,217,255,.1);border:1px solid ${diffColor}33;color:${diffColor};padding:4px 12px;border-radius:20px;font-size:11px;font-family:var(--font-mono);white-space:nowrap;flex-shrink:0">${escHtml(p.difficulty||'')}</span>
    </div>

    <div style="color:var(--text-secondary);font-size:13px;line-height:1.8;margin-bottom:14px">${escHtml(p.description||'')}</div>

    ${concepts.length?`
    <div style="margin-bottom:14px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px">üî¢ MATH CONCEPTS</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        ${concepts.map(c=>`<span style="background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.25);color:#a78bfa;padding:3px 10px;border-radius:6px;font-size:11px;font-family:var(--font-mono)">${escHtml(c)}</span>`).join('')}
      </div>
    </div>`:''}

    ${steps.length?`
    <div style="margin-bottom:14px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px">üìã STEP-BY-STEP GUIDE</div>
      ${steps.map((s,si)=>`
        <div style="display:flex;gap:10px;margin-bottom:8px;align-items:flex-start">
          <span style="background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;margin-top:1px">${si+1}</span>
          <span style="color:var(--text-secondary);font-size:12.5px;line-height:1.7">${escHtml(s)}</span>
        </div>`).join('')}
    </div>`:''}

    ${p.code_snippet?`
    <div style="margin-bottom:14px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px">üíª CODE EXAMPLE</div>
      <pre style="background:rgba(0,0,0,.4);border:1px solid rgba(0,217,255,.15);border-radius:8px;padding:14px;font-family:var(--font-mono);font-size:11px;color:var(--accent-tertiary);overflow-x:auto;line-height:1.6">${escHtml(p.code_snippet)}</pre>
    </div>`:''}

    ${p.expected_outcome?`<div style="background:rgba(6,247,214,.07);border:1px solid rgba(6,247,214,.2);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12.5px;color:var(--accent-tertiary)">üéØ <strong>Outcome:</strong> ${escHtml(p.expected_outcome)}</div>`:''}

    ${p.career_salary?`<div style="background:rgba(212,165,116,.07);border:1px solid rgba(212,165,116,.2);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12.5px;color:var(--gold)">üíº <strong>Career:</strong> ${escHtml(p.career_salary)}</div>`:''}

    ${resources.length?`
    <div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px">üìö RESOURCES</div>
      ${resources.map(res=>`<div style="color:var(--accent-primary);font-size:12px;margin-bottom:3px">‚Üí ${escHtml(res)}</div>`).join('')}
    </div>`:''}

    <div style="display:flex;gap:8px;flex-wrap:wrap;padding-top:12px;border-top:1px solid rgba(0,217,255,.1)">
      <a href="${youtubeUrl}" target="_blank" style="background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);color:#ff6b6b;padding:7px 14px;border-radius:7px;text-decoration:none;font-size:11px;font-family:var(--font-mono);transition:all .25s" onmouseover="this.style.background='rgba(255,0,0,.2)'" onmouseout="this.style.background='rgba(255,0,0,.1)'">‚ñ∂ YouTube Tutorials</a>
      <a href="${githubUrl}" target="_blank" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);color:var(--text-secondary);padding:7px 14px;border-radius:7px;text-decoration:none;font-size:11px;font-family:var(--font-mono);transition:all .25s" onmouseover="this.style.background='rgba(255,255,255,.12)'" onmouseout="this.style.background='rgba(255,255,255,.06)'">‚å® GitHub Projects</a>
      <a href="${googleUrl}" target="_blank" style="background:rgba(0,217,255,.08);border:1px solid rgba(0,217,255,.25);color:var(--accent-primary);padding:7px 14px;border-radius:7px;text-decoration:none;font-size:11px;font-family:var(--font-mono);transition:all .25s" onmouseover="this.style.background='rgba(0,217,255,.15)'" onmouseout="this.style.background='rgba(0,217,255,.08)'">üîç Search More</a>
    </div>
  </div>`;
}

async function runTheorem(){
  const theorem=document.getElementById('t-name').value.trim()||'Pythagorean Theorem';
  await runPanel('/api/theorem/prove',{theorem},'t-result',r=>r.proof||r.theorem);
}

async function runCompetition(){
  const category=document.getElementById('c-cat').value;
  const count=parseInt(document.getElementById('c-count').value);
  await runPanel('/api/competition/problems',{category,count},'c-result',r=>r.problems||r.problems_raw||'No problems generated');
}

async function runQuiz(){
  const topic=document.getElementById('q-topic').value.trim()||'Calculus';
  const count=parseInt(document.getElementById('q-count').value);
  await runPanel('/api/quiz/generate',{topic,count},'q-result',r=>r.questions||r.questions_raw||'No questions generated');
}

async function runVerify(){
  const problem=document.getElementById('v-problem').value.trim();
  const solution=document.getElementById('v-solution').value.trim();
  if(!problem||!solution){toast('Please enter both problem and solution','err');return;}
  await runPanel('/api/verify-solution',{problem,solution},'v-result',r=>r.verification||'No result');
}

async function runMistakes(){
  const topic=document.getElementById('mk-topic').value.trim()||'Integration';
  await runPanel('/api/common-mistakes',{topic},'mk-result',r=>r.mistakes||'No results');
}

/* ‚ïê‚ïê‚ïê‚ïê GENERIC PANEL RUNNER ‚ïê‚ïê‚ïê‚ïê */
async function runPanel(endpoint,payload,resultId,extract){
  const btn=document.querySelector('#chat .action-btn');
  const resBox=document.getElementById(resultId);
  setLoading(btn,true,'Loading...');
  resBox.style.display='none';
  try{
    const r=await apiPost(endpoint,payload);
    const text=extract(r);
    showResult(resultId,text);
  }catch(e){
    showResult(resultId,'Error: '+e.message,true);
  }finally{
    setLoading(btn,false);
  }
}

function showResult(id,text,isErr=false){
  const box=document.getElementById(id);
  if(!box)return;
  box.style.display='block';
  box.innerHTML=fmt(text);
  if(isErr)box.style.borderColor='rgba(255,107,107,.3)';
  setTimeout(()=>renderMath(box),50);
  box.scrollTop=0;
}

function setLoading(btn,on,label=''){
  if(!btn)return;
  btn.disabled=on;
  if(on)btn.innerHTML=`<span class="loading-spin"></span>${label}`;
  else btn.textContent=btn.dataset.origLabel||label||'Generate';
  if(!on&&!btn.dataset.origLabel)btn.dataset.origLabel=btn.textContent;
}

/* ‚ïê‚ïê‚ïê‚ïê CHAT (Ask Anupam) ‚ïê‚ïê‚ïê‚ïê */
async function sendMsg(){
  if(mode!=='ask'){handlePanelEnter();return;}
  const inp=document.getElementById('input');
  const text=inp.value.trim();
  if((!text&&!imgB64)||busy)return;
  const welcome=document.getElementById('welcome');
  if(welcome)welcome.remove();
  addMsg('user',text||'üì∏ Image uploaded');
  inp.value='';inp.style.height='auto';
  const curImg=imgB64,curType=imgType;
  removeImg();
  chatHistory.push({role:'user',content:text||'Solve this problem'});
  showTyping();
  try{
    const payload={messages:chatHistory.slice(-30)};
    if(curImg){payload.image_b64=curImg;payload.image_type=curType;}
    const r=await apiPost('/api/chat',payload);
    hideTyping();
    chatHistory.push({role:'assistant',content:r.answer});
    addMsg('bot',r.answer);
  }catch(e){
    hideTyping();
    addMsg('bot','‚ö†Ô∏è Error connecting to backend: '+e.message,true);
  }
}

function handlePanelEnter(){
  const val=document.getElementById('input').value.trim();
  if(!val)return;
  document.getElementById('input').value='';
  const map={formula:()=>{document.getElementById('f-topic').value=val;runFormula();},
             graph:()=>{document.getElementById('g-expr').value=val;runGraph();},
             mathematician:()=>{document.getElementById('m-name').value=val;runMathematician();},
             theorem:()=>{document.getElementById('t-name').value=val;runTheorem();},
             mistakes:()=>{document.getElementById('mk-topic').value=val;runMistakes();}};
  if(map[mode])map[mode]();
}

function addMsg(role,text){
  const chat=document.getElementById('chat');
  const div=document.createElement('div');
  div.className=`msg ${role}`;
  div.innerHTML=`<div class="avatar">${role==='user'?'üë§':'‚àë'}</div><div class="bubble"></div>`;
  const bubble=div.querySelector('.bubble');
  bubble.innerHTML=fmt(text);
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  requestAnimationFrame(()=>{renderMath(bubble);chat.scrollTop=chat.scrollHeight;});
}

function showTyping(){
  busy=true;
  document.getElementById('send-btn').disabled=true;
  const chat=document.getElementById('chat');
  const div=document.createElement('div');
  div.className='msg bot';div.id='typing-ind';
  div.innerHTML=`<div class="avatar">‚àë</div><div class="typing"><div class="td"></div><div class="td"></div><div class="td"></div></div>`;
  chat.appendChild(div);chat.scrollTop=chat.scrollHeight;
}

function hideTyping(){
  busy=false;
  document.getElementById('send-btn').disabled=false;
  const t=document.getElementById('typing-ind');if(t)t.remove();
}

/* ‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê */
function fmt(text){
  if(!text)return'';
  const blocks=[];
  let t=String(text);
  t=t.replace(/\\\[([\s\S]*?)\\\]/g,m=>{blocks.push(m);return`\x00B${blocks.length-1}\x00`;});
  t=t.replace(/\\\(([\s\S]*?)\\\)/g,m=>{blocks.push(m);return`\x00B${blocks.length-1}\x00`;});
  t=t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  t=t.replace(/\x00B(\d+)\x00/g,(_,i)=>blocks[+i]);
  t=t.replace(/```([\s\S]*?)```/g,'<pre>$1</pre>');
  t=t.replace(/\n/g,'<br>');
  return t;
}

function esc(s){return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'");}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}

async function quickChat(msg){
  if(mode!=='ask'){setMode('ask');setTimeout(()=>{document.getElementById('input').value=msg;sendMsg();},200);return;}
  document.getElementById('input').value=msg;
  await sendMsg();
}

async function apiPost(url,data){
  const r=await fetch(API_BASE+url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(!r.ok)throw new Error(`Server error ${r.status}`);
  return r.json();
}

function toast(msg,type='ok'){
  const t=document.createElement('div');
  t.className=`toast ${type}`;t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300);},2500);
}

function handleImg(e){
  const file=e.target.files[0];if(!file)return;
  if(mode!=='ask'){toast('Image upload only available in Ask Anupam mode','info');return;}
  const r=new FileReader();
  r.onload=ev=>{
    const res=ev.target.result;
    imgB64=res.split(',')[1];imgType=file.type;
    document.getElementById('prev-img').src=res;
    document.getElementById('imgpreview').style.display='block';
    toast('Image ready ‚Äî press Send','ok');
  };
  r.readAsDataURL(file);
}

function removeImg(){
  imgB64=null;imgType=null;
  document.getElementById('imgpreview').style.display='none';
  document.getElementById('filein').value='';
}

function initTheme(){
  const t=localStorage.getItem('ms_theme')||'dark';
  document.getElementById('theme-btn').textContent=t==='light'?'‚òÄÔ∏è Light':'üåô Dark';
}

function toggleTheme(){
  const nowLight=!document.body.classList.contains('light');
  document.body.classList.toggle('light',nowLight);
  localStorage.setItem('ms_theme',nowLight?'light':'dark');
  document.getElementById('theme-btn').textContent=nowLight?'‚òÄÔ∏è Light':'üåô Dark';
}
</script>
</body>
</html>